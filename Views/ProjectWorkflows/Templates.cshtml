@model IEnumerable<OAI.Core.DTOs.Projects.ProjectDto>
@{
    ViewData["Title"] = "Workflow Šablony";
}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Workflow Šablony</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#createTemplateModal">
                        <i class="fas fa-plus"></i> Nová šablona
                    </button>
                    <button type="button" class="btn btn-info btn-sm" data-toggle="modal" data-target="#importTemplateModal">
                        <i class="fas fa-upload"></i> Importovat
                    </button>
                    <a href="/Projects" class="btn btn-default btn-sm">
                        <i class="fas fa-arrow-left"></i> Zpět na projekty
                    </a>
                </div>
            </div>
            <div class="card-body">
                @if (!Model.Any())
                {
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Zatím neexistují žádné workflow šablony.
                        <br/>
                        Vytvořte první šablonu z existujícího projektu nebo vytvořte novou.
                    </div>
                }
                else
                {
                    <div class="row">
                        @foreach (var template in Model)
                        {
                            <div class="col-md-4 mb-4">
                                <div class="card card-widget widget-user-2">
                                    <!-- Template header -->
                                    <div class="widget-user-header bg-gradient-primary">
                                        <div class="widget-user-image">
                                            <div class="img-circle elevation-2 bg-white d-flex align-items-center justify-content-center" style="width: 65px; height: 65px;">
                                                <i class="fas fa-project-diagram fa-2x text-primary"></i>
                                            </div>
                                        </div>
                                        <h3 class="widget-user-username">@template.Name</h3>
                                        <h5 class="widget-user-desc">@template.ProjectType</h5>
                                    </div>
                                    <div class="card-footer p-0">
                                        <ul class="nav flex-column">
                                            <li class="nav-item">
                                                <div class="nav-link">
                                                    <i class="fas fa-info-circle text-info"></i> @template.Description
                                                </div>
                                            </li>
                                            @if (template.WorkflowVersion > 0)
                                            {
                                                <li class="nav-item">
                                                    <div class="nav-link">
                                                        <i class="fas fa-code-branch text-success"></i> Verze: @template.WorkflowVersion
                                                    </div>
                                                </li>
                                            }
                                            <li class="nav-item">
                                                <div class="nav-link">
                                                    <i class="fas fa-calendar text-muted"></i> Vytvořeno: @template.CreatedAt.ToString("dd.MM.yyyy")
                                                </div>
                                            </li>
                                            <li class="nav-item">
                                                <div class="nav-link">
                                                    <i class="fas fa-layer-group text-warning"></i> Stages: @template.Stages?.Count()
                                                </div>
                                            </li>
                                        </ul>
                                        <div class="card-footer">
                                            <div class="btn-group w-100" role="group">
                                                <a href="/ProjectWorkflows/TemplateDetails?templateId=@template.Id" class="btn btn-sm btn-info">
                                                    <i class="fas fa-eye"></i> Detail
                                                </a>
                                                <a href="/ProjectWorkflows/CreateFromTemplate?templateId=@template.Id" class="btn btn-sm btn-success">
                                                    <i class="fas fa-plus"></i> Použít
                                                </a>
                                                <button type="button" class="btn btn-sm btn-warning" onclick="editTemplate('@template.Id')">
                                                    <i class="fas fa-edit"></i> Upravit
                                                </button>
                                                <button type="button" class="btn btn-sm btn-danger" onclick="deleteTemplate('@template.Id', '@template.Name')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Create Template Modal -->
<div class="modal fade" id="createTemplateModal" tabindex="-1" role="dialog" aria-labelledby="createTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createTemplateModalLabel">Vytvořit novou šablonu</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Workflow šablonu můžete vytvořit dvěma způsoby:
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title">Z existujícího projektu</h5>
                            </div>
                            <div class="card-body">
                                <p>Vyberte existující projekt a převeďte ho na šablonu.</p>
                                <div class="form-group">
                                    <label for="projectSelect">Vyberte projekt:</label>
                                    <select class="form-control" id="projectSelect">
                                        <option value="">-- Vyberte projekt --</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="createTemplateFromProject()">
                                    <i class="fas fa-copy"></i> Vytvořit ze projektu
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title">Nová prázdná šablona</h5>
                            </div>
                            <div class="card-body">
                                <p>Vytvořte novou šablonu od začátku.</p>
                                <div class="form-group">
                                    <label for="templateName">Název šablony:</label>
                                    <input type="text" class="form-control" id="templateName" placeholder="Např. E-commerce workflow">
                                </div>
                                <div class="form-group">
                                    <label for="templateDescription">Popis:</label>
                                    <textarea class="form-control" id="templateDescription" rows="3" placeholder="Popis účelu šablony..."></textarea>
                                </div>
                                <button type="button" class="btn btn-success" onclick="createNewTemplate()">
                                    <i class="fas fa-plus"></i> Vytvořit novou
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Zrušit</button>
            </div>
        </div>
    </div>
</div>

<!-- Import Template Modal -->
<div class="modal fade" id="importTemplateModal" tabindex="-1" role="dialog" aria-labelledby="importTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importTemplateModalLabel">Importovat workflow šablonu</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Vyberte JSON soubor se šablonou workflow, kterou chcete importovat.
                </div>
                <div class="form-group">
                    <label for="templateFile">Soubor šablony (JSON)</label>
                    <div class="custom-file">
                        <input type="file" class="custom-file-input" id="templateFile" accept=".json">
                        <label class="custom-file-label" for="templateFile">Vyberte soubor...</label>
                    </div>
                </div>
                <div id="templatePreview" class="mt-3" style="display: none;">
                    <h6>Náhled šablony:</h6>
                    <div class="card">
                        <div class="card-body">
                            <dl class="row">
                                <dt class="col-sm-3">Název:</dt>
                                <dd class="col-sm-9" id="previewName">-</dd>
                                <dt class="col-sm-3">Popis:</dt>
                                <dd class="col-sm-9" id="previewDescription">-</dd>
                                <dt class="col-sm-3">Verze:</dt>
                                <dd class="col-sm-9" id="previewVersion">-</dd>
                                <dt class="col-sm-3">Stages:</dt>
                                <dd class="col-sm-9" id="previewStages">-</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Zrušit</button>
                <button type="button" class="btn btn-primary" id="importButton" onclick="importTemplate()" disabled>
                    <i class="fas fa-upload"></i> Importovat šablonu
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let selectedTemplateData = null;
        
        $(document).ready(function() {
            loadProjects();
            
            // File input change handler
            $('#templateFile').on('change', function() {
                const file = this.files[0];
                if (file) {
                    $('.custom-file-label').text(file.name);
                    readTemplateFile(file);
                } else {
                    $('.custom-file-label').text('Vyberte soubor...');
                    $('#templatePreview').hide();
                    $('#importButton').prop('disabled', true);
                    selectedTemplateData = null;
                }
            });
        });
        
        function readTemplateFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const templateData = JSON.parse(e.target.result);
                    validateAndPreviewTemplate(templateData);
                } catch (error) {
                    toastr.error('Neplatný JSON soubor');
                    $('#templatePreview').hide();
                    $('#importButton').prop('disabled', true);
                    selectedTemplateData = null;
                }
            };
            reader.readAsText(file);
        }
        
        function validateAndPreviewTemplate(templateData) {
            // Basic validation
            if (!templateData.template || !templateData.workflow) {
                toastr.error('Neplatný formát šablony - chybí template nebo workflow data');
                return;
            }
            
            const template = templateData.template;
            const workflow = templateData.workflow;
            
            // Update preview
            $('#previewName').text(template.name || 'Bez názvu');
            $('#previewDescription').text(template.description || 'Bez popisu');
            $('#previewVersion').text(template.version || '1');
            $('#previewStages').text(workflow.stages ? workflow.stages.length : '0');
            
            $('#templatePreview').show();
            $('#importButton').prop('disabled', false);
            selectedTemplateData = templateData;
        }
        
        function loadProjects() {
            fetch('/api/projects')
                .then(response => response.json())
                .then(result => {
                    if (result.isSuccess) {
                        const select = $('#projectSelect');
                        select.empty();
                        select.append('<option value="">-- Vyberte projekt --</option>');
                        
                        result.data.forEach(project => {
                            if (!project.isTemplate) {
                                select.append(`<option value="${project.id}">${project.name}</option>`);
                            }
                        });
                    }
                })
                .catch(error => console.error('Error loading projects:', error));
        }
        
        function createTemplateFromProject() {
            const projectId = $('#projectSelect').val();
            if (!projectId) {
                toastr.warning('Prosím vyberte projekt');
                return;
            }
            
            if (confirm('Opravdu chcete vytvořit šablonu z tohoto projektu?')) {
                fetch(`/api/workflow/${projectId}/convert-to-template`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.isSuccess) {
                        toastr.success('Šablona byla úspěšně vytvořena');
                        $('#createTemplateModal').modal('hide');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        toastr.error(result.error || 'Chyba při vytváření šablony');
                    }
                })
                .catch(error => {
                    toastr.error('Chyba při komunikaci se serverem');
                    console.error('Error:', error);
                });
            }
        }
        
        function createNewTemplate() {
            const name = $('#templateName').val();
            const description = $('#templateDescription').val();
            
            if (!name) {
                toastr.warning('Prosím zadejte název šablony');
                return;
            }
            
            const data = {
                name: name + ' (Template)',
                description: description || 'Workflow template',
                type: 'Template',
                isTemplate: true,
                status: 'Active'
            };
            
            fetch('/api/projects', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.isSuccess) {
                    toastr.success('Šablona byla úspěšně vytvořena');
                    $('#createTemplateModal').modal('hide');
                    
                    // Redirect to workflow designer
                    setTimeout(() => {
                        window.location.href = `/WorkflowDesigner?projectId=${result.data.id}`;
                    }, 1500);
                } else {
                    toastr.error(result.error || 'Chyba při vytváření šablony');
                }
            })
            .catch(error => {
                toastr.error('Chyba při komunikaci se serverem');
                console.error('Error:', error);
            });
        }
        
        function editTemplate(templateId) {
            window.location.href = `/WorkflowDesigner?projectId=${templateId}`;
        }
        
        function deleteTemplate(templateId, templateName) {
            if (confirm(`Opravdu chcete smazat šablonu '${templateName}'?`)) {
                fetch(`/api/projects/${templateId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        toastr.success('Šablona byla úspěšně smazána');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        toastr.error('Nepodařilo se smazat šablonu');
                    }
                })
                .catch(error => {
                    toastr.error('Chyba při komunikaci se serverem');
                    console.error('Error:', error);
                });
            }
        }
        
        function importTemplate() {
            if (!selectedTemplateData) {
                toastr.error('Nejprve vyberte soubor šablony');
                return;
            }
            
            const btn = $('#importButton');
            btn.prop('disabled', true);
            btn.html('<i class="fas fa-spinner fa-spin"></i> Importuji...');
            
            const template = selectedTemplateData.template;
            const workflow = selectedTemplateData.workflow;
            
            // First create the project template
            const projectData = {
                name: template.name + ' (Imported)',
                description: template.description || 'Imported workflow template',
                type: 'Template',
                isTemplate: true,
                status: 'Active',
                workflowVersion: template.version || 1
            };
            
            fetch('/api/projects', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(projectData)
            })
            .then(response => response.json())
            .then(result => {
                if (result.isSuccess) {
                    const projectId = result.data.id;
                    
                    // Then import the workflow design
                    if (workflow && workflow.stages) {
                        const workflowData = {
                            projectId: projectId,
                            stages: workflow.stages.map(stage => ({
                                ...stage,
                                projectId: projectId
                            }))
                        };
                        
                        return fetch('/api/workflow/design', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(workflowData)
                        });
                    } else {
                        return Promise.resolve({ ok: true, json: () => Promise.resolve({ isSuccess: true }) });
                    }
                } else {
                    throw new Error(result.error || 'Chyba při vytváření projektu');
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.isSuccess) {
                    toastr.success('Šablona byla úspěšně importována');
                    $('#importTemplateModal').modal('hide');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    throw new Error(result.error || 'Chyba při importu workflow');
                }
            })
            .catch(error => {
                toastr.error('Chyba při importu šablony: ' + error.message);
                console.error('Import error:', error);
            })
            .finally(() => {
                btn.prop('disabled', false);
                btn.html('<i class="fas fa-upload"></i> Importovat šablonu');
            });
        }
    </script>
}