@{
    ViewData["Title"] = $"Vytvořit projekt ze šablony: {ViewBag.Template.Name}";
    var template = ViewBag.Template as OAI.Core.DTOs.Projects.ProjectDto;
}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Vytvořit projekt ze šablony: @template.Name</h3>
                <div class="card-tools">
                    <a href="/ProjectWorkflows/TemplateDetails?templateId=@template.Id" class="btn btn-info btn-sm">
                        <i class="fas fa-eye"></i> Detail šablony
                    </a>
                    <a href="/ProjectWorkflows/Templates" class="btn btn-default btn-sm">
                        <i class="fas fa-arrow-left"></i> Zpět na šablony
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <form id="createProjectForm">
                            <div class="form-group">
                                <label for="projectName">Název projektu *</label>
                                <input type="text" class="form-control" id="projectName" name="projectName" required 
                                       placeholder="Zadejte název pro nový projekt" value="@template.Name - Kopie">
                            </div>
                            
                            <div class="form-group">
                                <label for="projectDescription">Popis projektu</label>
                                <textarea class="form-control" id="projectDescription" name="projectDescription" rows="3" 
                                          placeholder="Volitelný popis projektu">@template.Description</textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="projectType">Typ projektu</label>
                                <select class="form-control" id="projectType" name="projectType">
                                    <option value="Development">Development</option>
                                    <option value="Testing">Testing</option>
                                    <option value="Production">Production</option>
                                    <option value="Research">Research</option>
                                    <option value="Analysis">Analysis</option>
                                </select>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="customerSelect">Zákazník (volitelné)</label>
                                        <select class="form-control" id="customerSelect" name="customerId">
                                            <option value="">-- Vyberte zákazníka --</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="projectBudget">Rozpočet (volitelné)</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="projectBudget" name="budget" 
                                                   placeholder="0" min="0" step="0.01">
                                            <div class="input-group-append">
                                                <span class="input-group-text">CZK</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <h5 class="mt-4">Možnosti vytvoření</h5>
                            <div class="form-group">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="copyStages" checked>
                                    <label class="custom-control-label" for="copyStages">
                                        Zkopírovat všechny workflow stages ze šablony
                                    </label>
                                </div>
                                <small class="form-text text-muted">
                                    Pokud zaškrtnuto, budou zkopírovány všechny stages včetně jejich konfigurace.
                                </small>
                            </div>
                            
                            <div class="form-group">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="startImmediately">
                                    <label class="custom-control-label" for="startImmediately">
                                        Otevřít workflow designer po vytvoření
                                    </label>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title">Náhled šablony</h5>
                            </div>
                            <div class="card-body">
                                <dl class="row">
                                    <dt class="col-sm-6">Název:</dt>
                                    <dd class="col-sm-6">@template.Name</dd>
                                    
                                    <dt class="col-sm-6">Typ:</dt>
                                    <dd class="col-sm-6">@template.ProjectType</dd>
                                    
                                    <dt class="col-sm-6">Verze:</dt>
                                    <dd class="col-sm-6">@template.WorkflowVersion</dd>
                                    
                                    <dt class="col-sm-6">Stages:</dt>
                                    <dd class="col-sm-6">@template.Stages?.Count()</dd>
                                    
                                    <dt class="col-sm-6">Vytvořeno:</dt>
                                    <dd class="col-sm-6">@template.CreatedAt.ToString("dd.MM.yyyy")</dd>
                                </dl>
                                
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    <small>
                                        Nový projekt bude vytvořen s aktuální konfigurací této šablony.
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Preview of stages -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="card-title">Stages v šabloně</h6>
                            </div>
                            <div class="card-body p-2">
                                <div id="stagesPreview">
                                    <p class="text-muted">Načítání...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <button type="button" class="btn btn-success" onclick="createProject()">
                    <i class="fas fa-plus"></i> Vytvořit projekt
                </button>
                <a href="/ProjectWorkflows/Templates" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Zrušit
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            loadCustomers();
            loadStagesPreview();
        });
        
        function loadCustomers() {
            fetch('/api/customers')
                .then(response => response.json())
                .then(result => {
                    if (result.isSuccess) {
                        const select = $('#customerSelect');
                        result.data.forEach(customer => {
                            select.append(`<option value="${customer.id}">${customer.name} ${customer.surname}</option>`);
                        });
                    }
                })
                .catch(error => console.error('Error loading customers:', error));
        }
        
        function loadStagesPreview() {
            const templateId = '@template.Id';
            
            fetch(`/api/workflow/${templateId}/design`)
                .then(response => response.json())
                .then(result => {
                    if (result.isSuccess && result.data.stages) {
                        const container = $('#stagesPreview');
                        container.empty();
                        
                        result.data.stages.forEach((stage, index) => {
                            const stageElement = `
                                <div class="d-flex align-items-center mb-2">
                                    <div class="mr-2">
                                        <span class="badge badge-primary">${stage.order}</span>
                                    </div>
                                    <div class="flex-grow-1">
                                        <small class="font-weight-bold">${stage.name}</small>
                                        <br>
                                        <small class="text-muted">${stage.type}</small>
                                    </div>
                                </div>
                            `;
                            container.append(stageElement);
                        });
                    } else {
                        $('#stagesPreview').html('<p class="text-muted">Žádné stages</p>');
                    }
                })
                .catch(error => {
                    console.error('Error loading stages preview:', error);
                    $('#stagesPreview').html('<p class="text-danger">Chyba při načítání</p>');
                });
        }
        
        function createProject() {
            const form = document.getElementById('createProjectForm');
            const formData = new FormData(form);
            
            const projectName = formData.get('projectName');
            if (!projectName) {
                toastr.warning('Prosím zadejte název projektu');
                return;
            }
            
            const data = {
                name: projectName,
                description: formData.get('projectDescription') || '',
                type: formData.get('projectType'),
                customerId: formData.get('customerId') || null,
                budget: formData.get('budget') ? parseFloat(formData.get('budget')) : null,
                isTemplate: false,
                status: 'Active'
            };
            
            // Show loading state
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Vytváření...';
            
            fetch('/api/workflow/templates/@template.Id/create-project', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.isSuccess) {
                    toastr.success('Projekt byl úspěšně vytvořen ze šablony');
                    
                    const startImmediately = $('#startImmediately').is(':checked');
                    
                    setTimeout(() => {
                        if (startImmediately) {
                            window.location.href = `/WorkflowDesigner?projectId=${result.data.id}`;
                        } else {
                            window.location.href = `/Projects/Details/${result.data.id}`;
                        }
                    }, 1500);
                } else {
                    toastr.error(result.error || 'Chyba při vytváření projektu');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-plus"></i> Vytvořit projekt';
                }
            })
            .catch(error => {
                toastr.error('Chyba při komunikaci se serverem');
                console.error('Error:', error);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plus"></i> Vytvořit projekt';
            });
        }
    </script>
}