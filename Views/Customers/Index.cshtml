@model IEnumerable<OAI.Core.DTOs.Customers.CustomerListDto>
@using OAI.Core.Entities.Customers
@{
    ViewData["Title"] = "Zákazníci";
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Správa zákazníků</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Dashboard</a></li>
                    <li class="breadcrumb-item active">Zákazníci</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="row">
                            <div class="col-sm-4">
                                <a asp-action="Create" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Nový zákazník
                                </a>
                            </div>
                            <div class="col-sm-4 text-center">
                                <div class="btn-group" role="group">
                                    <a asp-action="Index" asp-route-showDeleted="false" class="btn @(ViewBag.ShowDeleted == false ? "btn-primary" : "btn-outline-primary")">
                                        <i class="fas fa-users"></i> Aktivní
                                    </a>
                                    <a asp-action="Index" asp-route-showDeleted="true" class="btn @(ViewBag.ShowDeleted == true ? "btn-secondary" : "btn-outline-secondary")">
                                        <i class="fas fa-archive"></i> Archivované
                                    </a>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="card-tools float-right">
                                    <div class="input-group input-group-sm" style="width: 250px;">
                                        <input type="text" id="customerSearch" class="form-control float-right" placeholder="Hledat zákazníka...">
                                        <div class="input-group-append">
                                            <button type="button" class="btn btn-default" onclick="searchCustomers()">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body table-responsive p-0">
                        <table class="table table-hover text-nowrap">
                            <thead>
                                <tr>
                                    <th>Název</th>
                                    <th>IČO</th>
                                    <th>Email</th>
                                    <th>Telefon</th>
                                    <th>Typ</th>
                                    <th>Segment</th>
                                    <th>Status</th>
                                    @if (ViewBag.ShowDeleted == true)
                                    {
                                        <th>Archivován</th>
                                    }
                                    <th>Projekty</th>
                                    <th>Požadavky</th>
                                    <th>Akce</th>
                                </tr>
                            </thead>
                            <tbody id="customerTableBody">
                                @foreach (var customer in Model)
                                {
                                    <tr>
                                        <td>
                                            <a asp-action="Details" asp-route-id="@customer.Id" class="text-primary">
                                                <strong>@customer.Name</strong>
                                                @if (!string.IsNullOrEmpty(customer.CompanyName))
                                                {
                                                    <br />
                                                    <small class="text-muted">@customer.CompanyName</small>
                                                }
                                            </a>
                                        </td>
                                        <td>@(customer.CompanyName ?? "-")</td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(customer.Email))
                                            {
                                                <a href="mailto:@customer.Email">@customer.Email</a>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>@(customer.Phone ?? "-")</td>
                                        <td>
                                            <span class="badge badge-@(customer.Type switch {
                                                CustomerType.Individual => "info",
                                                CustomerType.Company => "primary",
                                                CustomerType.Government => "warning",
                                                CustomerType.NonProfit => "success",
                                                _ => "secondary"
                                            })">@GetTypeText(customer.Type)</span>
                                        </td>
                                        <td>
                                            <span class="badge badge-@(customer.Segment switch {
                                                CustomerSegment.VIP => "danger",
                                                CustomerSegment.Premium => "warning",
                                                CustomerSegment.Strategic => "purple",
                                                _ => "secondary"
                                            })">@GetSegmentText(customer.Segment)</span>
                                        </td>
                                        <td>
                                            <span class="badge badge-@(customer.Status switch {
                                                CustomerStatus.Active => "success",
                                                CustomerStatus.Lead => "info",
                                                CustomerStatus.Inactive => "secondary",
                                                CustomerStatus.Suspended => "warning",
                                                CustomerStatus.Blacklisted => "danger",
                                                _ => "secondary"
                                            })">@GetStatusText(customer.Status)</span>
                                        </td>
                                        @if (ViewBag.ShowDeleted == true)
                                        {
                                            <td>
                                                @if (customer.IsDeleted && customer.DeletedAt.HasValue)
                                                {
                                                    <span class="text-danger">
                                                        <i class="fas fa-archive"></i> @customer.DeletedAt.Value.ToString("dd.MM.yyyy HH:mm")
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                        }
                                        <td>
                                            <span class="text-primary">@customer.ActiveProjectsCount</span> / @customer.ProjectsCount
                                        </td>
                                        <td>
                                            <span class="text-warning">@customer.ActiveRequestsCount</span> / @customer.RequestsCount
                                        </td>
                                        <td>
                                            <div>
                                                <a asp-action="Details" asp-route-id="@customer.Id" class="btn btn-info btn-sm mr-1" title="Detail">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                @if (!customer.IsDeleted)
                                                {
                                                    <a asp-action="Edit" asp-route-id="@customer.Id" class="btn btn-warning btn-sm mr-1" title="Upravit">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    <a asp-controller="Projects" asp-action="Create" asp-route-customerId="@customer.Id" class="btn btn-success btn-sm mr-1" title="Nový projekt">
                                                        <i class="fas fa-project-diagram"></i>
                                                    </a>
                                                    <a asp-controller="Requests" asp-action="New" asp-route-customerId="@customer.Id" class="btn btn-info btn-sm" title="Nový požadavek">
                                                        <i class="fas fa-plus-circle"></i>
                                                    </a>
                                                }
                                                else
                                                {
                                                    <button class="btn btn-success btn-sm restore-customer-btn mr-1" data-customer-id="@customer.Id" title="Aktivovat">
                                                        <i class="fas fa-undo"></i> Aktivovat
                                                    </button>
                                                    <button class="btn btn-danger btn-sm permanent-delete-customer-btn" data-customer-id="@customer.Id" title="Trvale smazat">
                                                        <i class="fas fa-trash-alt"></i> Smazat
                                                    </button>
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Statistiky -->
                <div class="row">
                    <div class="col-md-3 col-sm-6 col-12">
                        <div class="info-box">
                            <span class="info-box-icon bg-info"><i class="fas fa-users"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Celkem zákazníků</span>
                                <span class="info-box-number">@Model.Count()</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 col-12">
                        <div class="info-box">
                            <span class="info-box-icon bg-success"><i class="fas fa-check-circle"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Aktivní zákazníci</span>
                                <span class="info-box-number">@Model.Count(c => c.Status == CustomerStatus.Active)</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 col-12">
                        <div class="info-box">
                            <span class="info-box-icon bg-warning"><i class="fas fa-project-diagram"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Aktivní projekty</span>
                                <span class="info-box-number">@Model.Sum(c => c.ActiveProjectsCount)</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 col-12">
                        <div class="info-box">
                            <span class="info-box-icon bg-danger"><i class="fas fa-dollar-sign"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Celková hodnota</span>
                                <span class="info-box-number">@Model.Sum(c => c.TotalProjectsValue).ToString("C0")</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3 col-sm-6 col-12">
                        <div class="info-box">
                            <span class="info-box-icon bg-purple"><i class="fas fa-file-alt"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Celkem požadavků</span>
                                <span class="info-box-number">@Model.Sum(c => c.RequestsCount)</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 col-12">
                        <div class="info-box">
                            <span class="info-box-icon bg-orange"><i class="fas fa-clock"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Aktivní požadavky</span>
                                <span class="info-box-number">@Model.Sum(c => c.ActiveRequestsCount)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        function searchCustomers() {
            var query = $('#customerSearch').val();
            $.get('@Url.Action("Search")', { query: query }, function(data) {
                $('#customerTableBody').html(data);
            });
        }

        $('#customerSearch').on('keypress', function(e) {
            if (e.which === 13) {
                searchCustomers();
            }
        });

        // Obnovení zákazníka
        $(document).on('click', '.restore-customer-btn', function() {
            var customerId = $(this).data('customer-id');
            
            Swal.fire({
                title: 'Aktivovat zákazníka?',
                text: 'Zákazník bude obnoven ze stavu archivován.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Ano, aktivovat!',
                cancelButtonText: 'Zrušit'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '@Url.Action("Restore", "Customers")/' + customerId,
                        type: 'POST',
                        headers: {
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function(response) {
                            if (response.success) {
                                Swal.fire(
                                    'Aktivován!',
                                    response.message,
                                    'success'
                                ).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire(
                                    'Chyba!',
                                    response.message,
                                    'error'
                                );
                            }
                        },
                        error: function() {
                            Swal.fire(
                                'Chyba!',
                                'Nastala chyba při aktivaci zákazníka.',
                                'error'
                            );
                        }
                    });
                }
            });
        });

        // Trvalé smazání zákazníka
        $(document).on('click', '.permanent-delete-customer-btn', function() {
            var customerId = $(this).data('customer-id');
            
            Swal.fire({
                title: 'Trvale smazat zákazníka?',
                text: 'POZOR! Tato akce je NEVRATNÁ. Zákazník bude trvale odstraněn ze systému.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Ano, trvale smazat!',
                cancelButtonText: 'Zrušit',
                input: 'text',
                inputPlaceholder: 'Napište SMAZAT pro potvrzení',
                inputValidator: (value) => {
                    if (value !== 'SMAZAT') {
                        return 'Musíte napsat SMAZAT pro potvrzení!'
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '@Url.Action("PermanentDelete", "Customers")/' + customerId,
                        type: 'POST',
                        headers: {
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function(response) {
                            if (response.success) {
                                Swal.fire(
                                    'Smazáno!',
                                    response.message,
                                    'success'
                                ).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire(
                                    'Chyba!',
                                    response.message,
                                    'error'
                                );
                            }
                        },
                        error: function() {
                            Swal.fire(
                                'Chyba!',
                                'Nastala chyba při mazání zákazníka.',
                                'error'
                            );
                        }
                    });
                }
            });
        });
    </script>
}

@functions {
    string GetTypeText(CustomerType type) => type switch
    {
        CustomerType.Individual => "Fyzická osoba",
        CustomerType.Company => "Firma",
        CustomerType.Government => "Státní správa",
        CustomerType.NonProfit => "Neziskovka",
        _ => "Neznámý"
    };

    string GetSegmentText(CustomerSegment segment) => segment switch
    {
        CustomerSegment.Small => "Malý",
        CustomerSegment.Standard => "Standardní",
        CustomerSegment.Premium => "Prémiový",
        CustomerSegment.VIP => "VIP",
        CustomerSegment.Strategic => "Strategický",
        _ => "Neznámý"
    };

    string GetStatusText(CustomerStatus status) => status switch
    {
        CustomerStatus.Lead => "Potenciální",
        CustomerStatus.Active => "Aktivní",
        CustomerStatus.Inactive => "Neaktivní",
        CustomerStatus.Suspended => "Pozastavený",
        CustomerStatus.Blacklisted => "Blacklist",
        _ => "Neznámý"
    };
}