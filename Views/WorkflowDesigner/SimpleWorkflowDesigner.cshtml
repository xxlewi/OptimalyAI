@model OptimalyAI.ViewModels.WorkflowGraphViewModel
@{
    ViewData["Title"] = "Workflow Designer";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .designer-container {
        display: flex;
        height: calc(100vh - 200px);
        gap: 20px;
    }
    
    .toolbox {
        width: 250px;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        overflow-y: auto;
    }
    
    .toolbox h6 {
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
    }
    
    .tool-item {
        background: white;
        border: 2px solid #ddd;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 10px;
        cursor: move;
        text-align: center;
        transition: all 0.2s;
    }
    
    .tool-item:hover {
        border-color: #007bff;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .canvas-container {
        flex: 1;
        background: white;
        border: 2px solid #ddd;
        border-radius: 8px;
        position: relative;
        overflow: auto;
    }
    
    .canvas-container.readonly {
        width: 100%;
        flex: none;
    }
    
    #workflow-canvas {
        width: 2000px;
        height: 1500px;
        position: relative;
        background-image: 
            linear-gradient(rgba(0,0,0,.05) 1px, transparent 1px),
            linear-gradient(90deg, rgba(0,0,0,.05) 1px, transparent 1px);
        background-size: 20px 20px;
    }
    
    .workflow-node {
        position: absolute;
        background: white;
        border: 2px solid #007bff;
        border-radius: 8px;
        padding: 15px;
        min-width: 180px;
        cursor: move;
        user-select: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .workflow-node.selected {
        border-color: #ff6b6b;
        box-shadow: 0 0 0 3px rgba(255,107,107,0.2);
    }
    
    .workflow-node.condition {
        width: 140px;
        height: 140px;
        border: none !important;
        background: transparent !important;
        padding: 0;
        min-width: unset;
        box-shadow: none !important;
    }
    
    .workflow-node.condition::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transform: rotate(45deg);
        border: 3px solid #ffc107;
        background: #fff8e1;
        border-radius: 15px;
        z-index: 1;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .workflow-node.condition .node-content-wrapper {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        z-index: 2;
    }
    
    .workflow-node.condition .node-header {
        margin-bottom: 5px;
        text-align: center;
        font-size: 14px;
        position: relative;
    }
    
    .workflow-node.condition .node-close {
        position: absolute;
        top: 23px;
        right: -40px;
        z-index: 3;
        background: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        line-height: 1;
    }
    
    /* Position dots at diamond vertices */
    .workflow-node.condition .connection-dot.input {
        top: -27px;
        left: 50%;
        transform: translateX(-50%);
    }
    
    .workflow-node.condition .connection-dot.output {
        bottom: -8px;
        transform: translateX(-50%);
        top: auto;
    }
    
    .workflow-node.condition .connection-dot.output.true {
        left: 15%;
        bottom: 15%;
        background: #28a745;
        transform: translate(-50%, 50%);
    }
    
    .workflow-node.condition .connection-dot.output.false {
        right: 15%;
        bottom: 15%;
        left: auto;
        background: #dc3545;
        transform: translate(50%, 50%);
    }
    
    .workflow-node.parallel {
        width: 140px;
        height: 140px;
        border: none !important;
        background: transparent !important;
        padding: 0;
        min-width: unset;
        box-shadow: none !important;
    }
    
    .workflow-node.parallel::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transform: rotate(45deg);
        border: 3px solid #6f42c1;
        background: #f3e5f5;
        border-radius: 15px;
        z-index: 1;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .workflow-node.parallel::after {
        content: '+';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 48px;
        font-weight: bold;
        color: #6f42c1;
        z-index: 2;
    }
    
    .workflow-node.parallel .node-content-wrapper {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        z-index: 3;
    }
    
    .workflow-node.parallel .node-header {
        font-size: 14px;
        text-align: center;
        position: relative;
    }
    
    .workflow-node.parallel .node-close {
        position: absolute;
        top: 23px;
        right: -40px;
        z-index: 3;
        background: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        line-height: 1;
    }
    
    /* Position parallel gateway dots on diamond vertices */
    .workflow-node.parallel .connection-dot.input {
        top: -27px;
        left: 50%;
        transform: translateX(-50%);
    }
    
    .workflow-node.parallel .connection-dot.output {
        bottom: -27px;
        left: 50%;
        background: #6f42c1;
        transform: translateX(-50%);
    }
    
    .node-header {
        font-weight: bold;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .node-close {
        cursor: pointer;
        color: #999;
        font-size: 18px;
        line-height: 1;
    }
    
    .node-close:hover {
        color: #dc3545;
    }
    
    .node-tools {
        font-size: 12px;
        margin-top: 8px;
    }
    
    .tool-badge {
        display: inline-block;
        background: #e3f2fd;
        color: #1976d2;
        padding: 2px 8px;
        border-radius: 4px;
        margin-right: 4px;
    }
    
    .connection-line {
        stroke: #007bff;
        stroke-width: 3;
        fill: none;
        pointer-events: none;
    }
    
    .connection-dot {
        width: 12px;
        height: 12px;
        background: #007bff;
        border: 2px solid white;
        border-radius: 50%;
        position: absolute;
        cursor: crosshair;
        z-index: 20;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .connection-dot:hover {
        background: #0056b3;
        transform: scale(1.2);
    }
    
    .connection-dot.input {
        left: 50%;
        top: -8px;
        transform: translateX(-50%);
    }
    
    .connection-dot.input:hover {
        transform: translateX(-50%) scale(1.2);
    }
    
    .connection-dot.output {
        left: 50%;
        bottom: -8px;
        transform: translateX(-50%);
    }
    
    .connection-dot.output:hover {
        transform: translateX(-50%) scale(1.2);
    }
    
    /* Magnetic effect styles */
    .connection-dot.magnetic-hover {
        background: #28a745;
        transform: scale(1.5);
        box-shadow: 0 0 10px rgba(40, 167, 69, 0.8);
        animation: pulse 0.5s ease-in-out infinite;
    }
    
    .connection-dot.input.magnetic-hover {
        transform: translateX(-50%) scale(1.5);
    }
    
    @@keyframes pulse {
        0% { transform: translateX(-50%) scale(1.5); }
        50% { transform: translateX(-50%) scale(1.8); }
        100% { transform: translateX(-50%) scale(1.5); }
    }
    
    .toolbar {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .zoom-controls {
        display: flex;
        gap: 5px;
        align-items: center;
        margin-left: auto;
    }
    
    .zoom-level {
        font-size: 14px;
        color: #666;
        min-width: 50px;
        text-align: center;
    }
    
    .badge-purple {
        background-color: #6f42c1;
        color: #fff;
    }
    
    .badge-purple:hover {
        background-color: #563d7c;
    }
    
    /* Drag & Drop Visual Feedback */
    .tool-item.dragging {
        opacity: 0.5;
        transform: scale(0.95);
        cursor: grabbing !important;
    }
    
    #workflow-canvas.drag-over {
        background-color: rgba(0, 123, 255, 0.05);
        border: 2px dashed #007bff;
    }
    
    .drop-zone-indicator {
        position: absolute;
        width: 150px;
        height: 80px;
        border: 3px dashed #28a745;
        border-radius: 8px;
        background-color: rgba(40, 167, 69, 0.1);
        pointer-events: none;
        display: none;
        z-index: 1000;
        animation: pulse 1s infinite;
    }
    
    @@keyframes pulse {
        0% { opacity: 0.4; transform: scale(0.98); }
        50% { opacity: 0.8; transform: scale(1.02); }
        100% { opacity: 0.4; transform: scale(0.98); }
    }
    
    .workflow-node.connection-source {
        box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.3);
    }
    
    .workflow-node.connection-target-valid {
        box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.3);
    }
    
    .workflow-node.connection-target-invalid {
        box-shadow: 0 0 0 4px rgba(220, 53, 69, 0.3);
    }
    
    .connection-line-preview {
        stroke: #007bff;
        stroke-width: 3;
        stroke-dasharray: 5, 5;
        fill: none;
        pointer-events: none;
        animation: dash 0.5s linear infinite;
    }
    
    @@keyframes dash {
        to {
            stroke-dashoffset: -10;
        }
    }
</style>

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>
                    <i class="fas fa-project-diagram"></i> Workflow Designer
                    <small class="text-muted">@Model.ProjectName</small>
                </h1>
            </div>
            <div class="col-sm-6">
                <div class="float-sm-right">
                    <a href="/Projects/@Model.ProjectId" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Zpƒõt na projekt
                    </a>
                    <button class="btn btn-success" onclick="saveWorkflow().catch(err => console.error(err))">
                        <i class="fas fa-save"></i> Ulo≈æit
                    </button>
                    <button class="btn btn-info" onclick="validateWorkflow()">
                        <i class="fas fa-check"></i> Validovat
                    </button>
                    <button class="btn btn-warning" onclick="testWorkflow()">
                        <i class="fas fa-download"></i> Export JSON
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        @if (ViewBag.ReadOnly != true)
        {
        <div class="toolbar">
            <button class="btn btn-sm btn-primary" onclick="runWorkflow()">
                <i class="fas fa-play"></i> Spustit
            </button>
            <button class="btn btn-sm btn-secondary" onclick="clearWorkflow()">
                <i class="fas fa-trash"></i> Vyƒçistit
            </button>
            <button class="btn btn-sm btn-secondary" onclick="autoLayout()">
                <i class="fas fa-magic"></i> Automatick√© rozlo≈æen√≠
            </button>
            <div class="zoom-controls">
                <button class="btn btn-sm btn-outline-secondary" onclick="zoomOut()" title="Odd√°lit">
                    <i class="fas fa-search-minus"></i>
                </button>
                <span class="zoom-level">100%</span>
                <button class="btn btn-sm btn-outline-secondary" onclick="zoomIn()" title="P≈ôibl√≠≈æit">
                    <i class="fas fa-search-plus"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="zoomReset()" title="Resetovat">
                    <i class="fas fa-compress"></i>
                </button>
            </div>
        </div>
        }
        
        <div class="designer-container">
            <!-- Toolbox - hide in readonly mode -->
            @if (ViewBag.ReadOnly != true)
            {
            <div class="toolbox">
                <h5><i class="fas fa-toolbox"></i> N√°stroje</h5>
                
                <h6>Z√°kladn√≠ uzly</h6>
                <div class="tool-item" data-type="task" draggable="true">
                    <i class="fas fa-square"></i> Proces
                    <small style="display: block; font-size: 10px; color: #666;">Obd√©ln√≠k</small>
                </div>
                <div class="tool-item" data-type="condition" draggable="true">
                    <i class="fas fa-question-circle"></i> Rozhodnut√≠
                    <small style="display: block; font-size: 10px; color: #666;">Podm√≠nka</small>
                </div>
                <div class="tool-item" data-type="parallel" draggable="true">
                    <i class="fas fa-plus"></i> Paraleln√≠ br√°na
                    <small style="display: block; font-size: 10px; color: #666;">AND Gateway</small>
                </div>
                
                <hr>
                
                <h6>AI N√°stroje</h6>
                @if (ViewBag.ToolsByCategory != null)
                {
                    var toolsByCategory = ViewBag.ToolsByCategory as Dictionary<string, List<OAI.Core.Interfaces.Tools.ITool>>;
                    if (toolsByCategory != null)
                    {
                        @foreach(var category in toolsByCategory)
                        {
                            <h6 style="font-size: 0.9em; margin-top: 10px;">@category.Key</h6>
                            @foreach(var tool in category.Value)
                            {
                                <div class="tool-item" data-type="tool" data-tool="@tool.Id" draggable="true" title="@tool.Description">
                                    <i class="fas fa-robot"></i> @tool.Name
                                </div>
                            }
                        }
                    }
                }
            </div>
            }
            
            <!-- Canvas -->
            <div class="canvas-container @(ViewBag.ReadOnly == true ? "readonly" : "")">
                <div id="workflow-canvas">
                    <svg id="connections-svg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: visible; z-index: 100;">
                        <defs>
                            <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
                                <polygon points="0 0, 8 3, 0 6" fill="#007bff" />
                            </marker>
                            <marker id="arrowhead-green" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
                                <polygon points="0 0, 8 3, 0 6" fill="#28a745" />
                            </marker>
                            <marker id="arrowhead-red" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
                                <polygon points="0 0, 8 3, 0 6" fill="#dc3545" />
                            </marker>
                        </defs>
                    </svg>
                    <!-- Drop zone indicator -->
                    <div class="drop-zone-indicator" id="dropZoneIndicator"></div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- I/O Configuration Modal -->
<div class="modal fade" id="ioConfigModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Konfigurace vstup≈Ø a v√Ωstup≈Ø workflow</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Input Configuration -->
                <h6><i class="fas fa-sign-in-alt"></i> Konfigurace vstupu</h6>
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="form-group">
                            <label>Typ vstupu</label>
                            <select class="form-control" id="modalInputType" onchange="updateInputConfig()">
                                <option value="files">üìÅ Soubory</option>
                                <option value="images">üñºÔ∏è Obr√°zky</option>
                                <option value="api">üåê API</option>
                                <option value="database">üóÑÔ∏è Datab√°ze</option>
                                <option value="csv">üìä CSV</option>
                                <option value="manual">‚úèÔ∏è Manu√°ln√≠</option>
                            </select>
                        </div>
                        
                        <div id="inputConfigDetails">
                            <!-- Dynamic content based on input type -->
                        </div>
                    </div>
                </div>
                
                <!-- Output Configuration -->
                <h6><i class="fas fa-sign-out-alt"></i> Konfigurace v√Ωstupu</h6>
                <div class="card">
                    <div class="card-body">
                        <div class="form-group">
                            <label>Typ v√Ωstupu</label>
                            <select class="form-control" id="modalOutputType" onchange="updateOutputConfig()">
                                <option value="excel">üìä Excel</option>
                                <option value="json">üìÑ JSON</option>
                                <option value="csv">üìä CSV</option>
                                <option value="api">üì§ API</option>
                                <option value="database">üíø Datab√°ze</option>
                                <option value="email">üìß Email</option>
                            </select>
                        </div>
                        
                        <div id="outputConfigDetails">
                            <!-- Dynamic content based on output type -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Zru≈°it</button>
                <button type="button" class="btn btn-primary" onclick="saveIOConfig()">
                    <i class="fas fa-save"></i> Ulo≈æit konfiguraci
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Node Edit Modal -->
<div class="modal fade" id="nodeEditModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upravit uzel</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editingNodeId">
                <div class="form-group">
                    <label>N√°zev</label>
                    <input type="text" class="form-control" id="nodeName">
                </div>
                <div class="form-group">
                    <label>Popis</label>
                    <textarea class="form-control" id="nodeDescription" rows="3"></textarea>
                </div>
                <div class="form-group" id="toolSection">
                    <label>N√°stroj</label>
                    <select class="form-control" id="nodeToolSelect">
                        <option value="">-- Vyberte n√°stroj --</option>
                        @if (ViewBag.RegisteredTools != null)
                        {
                            var registeredTools = ViewBag.RegisteredTools as List<OAI.Core.Interfaces.Tools.ITool>;
                            if (registeredTools != null)
                            {
                                @foreach(var tool in registeredTools)
                                {
                                    <option value="@tool.Id">@tool.Name</option>
                                }
                            }
                        }
                    </select>
                </div>
                <div class="form-group" id="executionSection">
                    <div class="custom-control custom-switch mb-3">
                        <input type="checkbox" class="custom-control-input" id="nodeUseReAct">
                        <label class="custom-control-label" for="nodeUseReAct">
                            <i class="fas fa-brain"></i> Pou≈æ√≠t ReAct pattern
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Timeout (sekundy)</label>
                        <input type="number" class="form-control" id="nodeTimeout" min="10" max="600" value="300">
                    </div>
                    <div class="form-group">
                        <label>Poƒçet pokus≈Ø p≈ôi selh√°n√≠</label>
                        <input type="number" class="form-control" id="nodeRetryCount" min="0" max="5" value="3">
                    </div>
                </div>
                <div class="form-group" id="conditionSection" style="display: none;">
                    <label>Podm√≠nka</label>
                    <input type="text" class="form-control" id="nodeCondition" placeholder="result > 0">
                </div>
                <div class="form-group" id="parametersSection">
                    <label><i class="fas fa-sliders-h"></i> Parametry n√°stroje</label>
                    <div id="dynamicParameters">
                        <!-- Parametry se naƒçtou dynamicky podle vybran√©ho n√°stroje -->
                        <div class="text-muted text-center py-3">
                            <i class="fas fa-info-circle"></i> Vyberte n√°stroj pro zobrazen√≠ parametr≈Ø
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="deleteCurrentNode()">
                    <i class="fas fa-trash"></i> Smazat
                </button>
                <button type="button" class="btn btn-info" id="testToolBtn" onclick="testCurrentTool()" style="display: none;">
                    <i class="fas fa-flask"></i> Test n√°stroje
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Zru≈°it</button>
                <button type="button" class="btn btn-primary" onclick="updateCurrentNode()">
                    <i class="fas fa-save"></i> Ulo≈æit
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Workflow Execution Modal -->
<div class="modal fade" id="executionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-play-circle"></i> Spu≈°tƒõn√≠ Workflow
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Pre-execution setup -->
                <div id="executionSetup">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Workflow bude spu≈°tƒõno s aktu√°ln√≠ konfigurac√≠.
                    </div>
                    
                    <div class="form-group">
                        <label>N√°zev spu≈°tƒõn√≠</label>
                        <input type="text" class="form-control" id="executionName" 
                               value="Test run - @DateTime.Now.ToString("yyyy-MM-dd HH:mm")">
                    </div>
                    
                    <div class="form-group">
                        <label>Vstupn√≠ parametry (JSON)</label>
                        <textarea class="form-control" id="executionParameters" rows="4">{}</textarea>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="enableDebugLogging" checked>
                        <label class="form-check-label" for="enableDebugLogging">
                            Povolit debug logy
                        </label>
                    </div>
                </div>
                
                <!-- Execution progress -->
                <div id="executionProgress" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Pr≈Øbƒõh zpracov√°n√≠</h6>
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="sr-only">Zpracov√°v√° se...</span>
                        </div>
                    </div>
                    
                    <div class="progress mb-3">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%">0%</div>
                    </div>
                    
                    <div id="executionSteps" class="execution-steps">
                        <!-- Steps will be added dynamically -->
                    </div>
                    
                    <div class="execution-log mt-3">
                        <h6>Logy</h6>
                        <div id="executionLog" class="log-container">
                            <!-- Logs will be added here -->
                        </div>
                    </div>
                </div>
                
                <!-- Execution results -->
                <div id="executionResults" style="display: none;">
                    <div class="alert" id="executionResultAlert">
                        <!-- Result message -->
                    </div>
                    
                    <div id="executionOutput">
                        <!-- Output data will be shown here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Zav≈ô√≠t</button>
                <button type="button" class="btn btn-primary" id="startExecutionBtn" onclick="startExecution()">
                    <i class="fas fa-play"></i> Spustit
                </button>
                <button type="button" class="btn btn-danger" id="cancelExecutionBtn" 
                        onclick="cancelExecution()" style="display: none;">
                    <i class="fas fa-stop"></i> Zru≈°it
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Tool Test Modal -->
<div class="modal fade" id="toolTestModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-flask"></i> Test n√°stroje: <span id="testToolName"></span>
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Test setup -->
                <div id="testSetup">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Nastavte parametry a spus≈•te test n√°stroje.
                    </div>
                    
                    <div id="testToolParameters">
                        <!-- Parameters will be loaded dynamically -->
                    </div>
                </div>
                
                <!-- Test progress -->
                <div id="testProgress" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Testov√°n√≠...</h6>
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="sr-only">Zpracov√°v√° se...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Test results -->
                <div id="testResults" style="display: none;">
                    <div class="alert" id="testResultAlert">
                        <!-- Result message -->
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6>V√Ωstup n√°stroje:</h6>
                            <pre id="testOutput" class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;"></pre>
                        </div>
                        <div class="col-md-6">
                            <h6>Detaily proveden√≠:</h6>
                            <div id="testDetails">
                                <p><strong>Doba bƒõhu:</strong> <span id="testDuration">-</span></p>
                                <p><strong>Status:</strong> <span id="testStatus">-</span></p>
                                <p><strong>Typ v√Ωstupu:</strong> <span id="testOutputType">-</span></p>
                            </div>
                            
                            <div id="testError" class="alert alert-danger mt-3" style="display: none;">
                                <h6>Chyba:</h6>
                                <pre id="testErrorDetails"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Zav≈ô√≠t</button>
                <button type="button" class="btn btn-primary" id="runTestBtn" onclick="runToolTest()">
                    <i class="fas fa-play"></i> Spustit test
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .execution-steps {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
    }
    
    .execution-step {
        padding: 8px;
        margin-bottom: 5px;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .execution-step.running {
        background: #e3f2fd;
        border-left: 3px solid #2196f3;
    }
    
    .execution-step.completed {
        background: #e8f5e9;
        border-left: 3px solid #4caf50;
    }
    
    .execution-step.failed {
        background: #ffebee;
        border-left: 3px solid #f44336;
    }
    
    .log-container {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        max-height: 150px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
    }
    
    .log-entry {
        margin-bottom: 2px;
    }
    
    .log-entry.error {
        color: #dc3545;
    }
    
    .log-entry.warning {
        color: #ffc107;
    }
    
    .log-entry.info {
        color: #17a2b8;
    }
    
    /* Fix for parameter inputs */
    #dynamicParameters input.form-control {
        width: 100% !important;
        height: 38px !important;
        padding: 6px 12px !important;
        font-size: 14px !important;
        line-height: 1.42857143 !important;
        color: #555 !important;
        background-color: #fff !important;
        background-image: none !important;
        border: 1px solid #ccc !important;
        border-radius: 4px !important;
        box-shadow: inset 0 1px 1px rgba(0,0,0,.075) !important;
        display: block !important;
    }
    
    #dynamicParameters .form-group {
        margin-bottom: 15px !important;
    }
</style>

@section Scripts {
<script>
    // Workflow state
    let nodes = {};
    let connections = [];
    let selectedNode = null;
    let nodeIdCounter = 1;
    let draggedElement = null;
    let isConnecting = false;
    let connectionStart = null;
    const currentProjectId = '@Model.ProjectId';
    let currentZoom = 1.0;
    
    // Initialize
    $(document).ready(function() {
        initializeDragAndDrop();
        initializeCanvas();
        initializeKeyboardShortcuts();
        initializeToolParameterLoading();
        
        // Start with 100% zoom
        currentZoom = 1.0;
        applyZoom();
        
        // Try to load saved workflow, or create default
        loadWorkflowFromServer();
    });
    
    // Initialize tool parameter loading
    function initializeToolParameterLoading() {
        // P≈ôi v√Ωbƒõru n√°stroje aktualizovat n√°zev a naƒç√≠st parametry
        $('#nodeToolSelect').on('change', function() {
            const selectedTool = $(this).val();
            if (selectedTool) {
                const toolName = $(this).find('option:selected').text();
                $('#nodeName').val(toolName);
                loadToolParameters(selectedTool);
            } else {
                $('#dynamicParameters').html(`
                    <div class="text-muted text-center py-3">
                        <i class="fas fa-info-circle"></i> Vyberte n√°stroj pro zobrazen√≠ parametr≈Ø
                    </div>
                `);
            }
        });
    }
    
    // Funkce pro naƒçten√≠ parametr≈Ø n√°stroje
    function loadToolParameters(toolId) {
        $('#dynamicParameters').html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Naƒç√≠t√°m parametry...</div>');
        
        $.ajax({
            url: '/api/tools/' + toolId + '/parameters',
            method: 'GET',
            success: function(parameters) {
                renderToolParameters(parameters);
            },
            error: function() {
                $('#dynamicParameters').html('<div class="alert alert-warning">Nepoda≈ôilo se naƒç√≠st parametry n√°stroje</div>');
            }
        });
    }
    
    // Funkce pro vykreslen√≠ parametr≈Ø
    function renderToolParameters(parameters) {
        console.log('Rendering parameters:', parameters); // Debug
        
        if (!parameters || parameters.length === 0) {
            $('#dynamicParameters').html('<div class="text-muted">Tento n√°stroj nem√° ≈æ√°dn√© parametry</div>');
            return;
        }
        
        let html = '';
        parameters.forEach(param => {
            console.log('Rendering param:', param); // Debug
            html += renderParameter(param);
        });
        
        console.log('Generated HTML:', html); // Debug
        $('#dynamicParameters').html(html);
        
        // P≈ôidat real-time validaci
        $('#dynamicParameters [data-param]').on('input change', function() {
            validateSingleParameter($(this));
        });
    }
    
    // Validace jednotliv√©ho parametru
    function validateSingleParameter($input) {
        const paramName = $input.data('param');
        const paramInfoStr = $input.attr('data-param-info');
        
        if (!paramInfoStr) return;
        
        // Vyƒçistit p≈ôedchoz√≠ chyby pro tento parametr
        $input.removeClass('is-invalid');
        $(`#error_${paramName}`).hide();
        
        try {
            const paramInfo = JSON.parse(atob(paramInfoStr)); // Decode from base64
            let value = $input.attr('type') === 'checkbox' ? $input.is(':checked') : $input.val();
            
            // Validace povinn√Ωch pol√≠
            if (paramInfo.isRequired && (!value || value === '')) {
                $input.addClass('is-invalid');
                $(`#error_${paramName}`).text(`${paramInfo.displayName || paramName} je povinn√© pole`).show();
                return false;
            }
            
            // Validace podle typu
            if (value !== '' && value !== null) {
                switch(paramInfo.type) {
                    case 'Integer':
                        const intVal = parseInt(value);
                        if (isNaN(intVal)) {
                            $input.addClass('is-invalid');
                            $(`#error_${paramName}`).text('Mus√≠ b√Ωt cel√© ƒç√≠slo').show();
                            return false;
                        } else {
                            // Kontrola min/max
                            if (paramInfo.validation) {
                                if (paramInfo.validation.min !== null && intVal < paramInfo.validation.min) {
                                    $input.addClass('is-invalid');
                                    $(`#error_${paramName}`).text(`Minim√°ln√≠ hodnota je ${paramInfo.validation.min}`).show();
                                    return false;
                                }
                                if (paramInfo.validation.max !== null && intVal > paramInfo.validation.max) {
                                    $input.addClass('is-invalid');
                                    $(`#error_${paramName}`).text(`Maxim√°ln√≠ hodnota je ${paramInfo.validation.max}`).show();
                                    return false;
                                }
                            }
                        }
                        break;
                        
                    case 'String':
                        if (paramInfo.validation) {
                            // Kontrola d√©lky
                            if (paramInfo.validation.minLength !== null && value.length < paramInfo.validation.minLength) {
                                $input.addClass('is-invalid');
                                $(`#error_${paramName}`).text(`Minim√°ln√≠ d√©lka je ${paramInfo.validation.minLength} znak≈Ø`).show();
                                return false;
                            }
                            if (paramInfo.validation.maxLength !== null && value.length > paramInfo.validation.maxLength) {
                                $input.addClass('is-invalid');
                                $(`#error_${paramName}`).text(`Maxim√°ln√≠ d√©lka je ${paramInfo.validation.maxLength} znak≈Ø`).show();
                                return false;
                            }
                        }
                        
                        // Speci√°ln√≠ validace pro URL typ
                        if (paramInfo.uiHints && paramInfo.uiHints.inputType === 'Url' && value) {
                            try {
                                new URL(value);
                            } catch (e) {
                                $input.addClass('is-invalid');
                                $(`#error_${paramName}`).text('Neplatn√° URL adresa').show();
                                return false;
                            }
                        }
                        break;
                }
            }
        } catch (e) {
            console.error('Error validating parameter:', e);
        }
        
        return true;
    }
    
    // Funkce pro vykreslen√≠ jednotliv√©ho parametru
    function renderParameter(param, prefix = '') {
        const idPrefix = prefix || 'param_';
        let html = '<div class="form-group">';
        html += `<label for="${idPrefix}${param.name}">${param.displayName || param.name}`;
        if (param.isRequired) html += ' <span class="text-danger">*</span>';
        html += '</label>';
        if (param.description) {
            html += `<small class="form-text text-muted">${param.description}</small>`;
        }
        
        // Podle typu parametru vykreslit spr√°vn√Ω input
        const paramType = param.type || 'String';
        console.log(`Param ${param.name} has type: ${paramType}`); // Debug
        
        switch(paramType) {
            case 'String':
                if (param.validation?.allowedValues && param.validation.allowedValues.length > 0) {
                    // Select pro allowed values
                    const selectParamInfo = btoa(JSON.stringify(param));
                    html += `<select class="form-control" id="${idPrefix}${param.name}" data-param="${param.name}" data-param-info="${selectParamInfo}">`;
                    param.validation.allowedValues.forEach(val => {
                        html += `<option value="${val}"${val === param.defaultValue ? ' selected' : ''}>${val}</option>`;
                    });
                    html += '</select>';
                } else {
                    // Textov√Ω input
                    const paramInfo = btoa(JSON.stringify(param)); // Base64 encode to avoid quote issues
                    html += `<input type="text" class="form-control" id="${idPrefix}${param.name}"
                             data-param="${param.name}" 
                             data-param-info="${paramInfo}"
                             value="${param.defaultValue || ''}" 
                             placeholder="${param.example || ''}" />`;
                }
                break;
                
            case 'Boolean':
                html += `<div class="custom-control custom-switch">`;
                const boolParamInfo = btoa(JSON.stringify(param));
                html += `<input type="checkbox" class="custom-control-input" id="${idPrefix}${param.name}" 
                         data-param="${param.name}" data-param-info="${boolParamInfo}"
                         ${param.defaultValue ? ' checked' : ''}>`;
                html += `<label class="custom-control-label" for="${idPrefix}${param.name}">Ano</label>`;
                html += '</div>';
                break;
                
            case 'Integer':
                const intParamInfo = btoa(JSON.stringify(param));
                html += `<input type="number" class="form-control" id="${idPrefix}${param.name}"
                         data-param="${param.name}" 
                         data-param-info="${intParamInfo}"
                         value="${param.defaultValue || ''}" 
                         ${param.validation?.min ? 'min="' + param.validation.min + '"' : ''}
                         ${param.validation?.max ? 'max="' + param.validation.max + '"' : ''}/>`;
                break;
                
            case 'Decimal':
                const decimalParamInfo = btoa(JSON.stringify(param));
                html += `<input type="number" step="0.01" class="form-control" id="${idPrefix}${param.name}"
                         data-param="${param.name}" 
                         data-param-info="${decimalParamInfo}"
                         value="${param.defaultValue || ''}"/>`;
                break;
                
            case 'Json':
                const jsonParamInfo = btoa(JSON.stringify(param));
                html += `<textarea class="form-control json-input" id="${idPrefix}${param.name}"
                         data-param="${param.name}" 
                         data-param-info="${jsonParamInfo}"
                         rows="4">${param.defaultValue ? JSON.stringify(param.defaultValue, null, 2) : '{}'}</textarea>`;
                break;
                
            default:
                const defaultParamInfo = btoa(JSON.stringify(param));
                html += `<input type="text" class="form-control" id="${idPrefix}${param.name}"
                         data-param="${param.name}" 
                         data-param-info="${defaultParamInfo}"
                         value="${param.defaultValue || ''}"/>`;
        }
        
        if (param.description) {
            html += `<small class="form-text text-muted">${param.description}</small>`;
        }
        
        // Div pro zobrazen√≠ validaƒçn√≠ch chyb
        html += `<div class="invalid-feedback" id="error_${idPrefix}${param.name}"></div>`;
        
        html += '</div>';
        return html;
    }
    
    // Initialize drag and drop
    function initializeDragAndDrop() {
        // Toolbox items
        $('.tool-item').on('dragstart', function(e) {
            e.originalEvent.dataTransfer.setData('type', $(this).data('type'));
            e.originalEvent.dataTransfer.setData('tool', $(this).data('tool') || '');
            
            // Add dragging class
            $(this).addClass('dragging');
            
            // Set drag image
            e.originalEvent.dataTransfer.effectAllowed = 'copy';
        }).on('dragend', function(e) {
            // Remove dragging class
            $(this).removeClass('dragging');
        });
        
        // Canvas
        $('#workflow-canvas').on('dragenter', function(e) {
            e.preventDefault();
            $(this).addClass('drag-over');
        }).on('dragover', function(e) {
            e.preventDefault();
            e.originalEvent.dataTransfer.dropEffect = 'copy';
            
            // Show drop zone indicator
            const rect = this.getBoundingClientRect();
            const x = e.clientX - rect.left - 75; // Center the indicator
            const y = e.clientY - rect.top - 40;
            
            $('#dropZoneIndicator').css({
                left: x + 'px',
                top: y + 'px',
                display: 'block'
            });
        }).on('dragleave', function(e) {
            // Only remove drag-over if we're leaving the canvas entirely
            if (e.target === this) {
                $(this).removeClass('drag-over');
                $('#dropZoneIndicator').hide();
            }
        }).on('drop', function(e) {
            e.preventDefault();
            
            // Remove visual feedback
            $(this).removeClass('drag-over');
            $('#dropZoneIndicator').hide();
            
            const type = e.originalEvent.dataTransfer.getData('type');
            const tool = e.originalEvent.dataTransfer.getData('tool');
            const rect = this.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            createNode(type, x, y, tool);
            
            // Visual feedback for successful drop
            toastr.success('N√°stroj byl p≈ôid√°n do workflow', '', {
                timeOut: 1000,
                positionClass: 'toast-bottom-right'
            });
        });
    }
    
    // Initialize canvas events
    function initializeCanvas() {
        $('#workflow-canvas').on('click', function(e) {
            if (e.target === this) {
                deselectAll();
            }
        });
        
        // Connection events - use delegated events for dynamic nodes
        $('#workflow-canvas').on('mousedown', '.connection-dot.output', function(e) {
            e.stopPropagation();
            e.preventDefault();
            const nodeEl = $(this).closest('.workflow-node');
            const nodeId = nodeEl.attr('id');
            const branch = $(this).attr('data-branch');
            startConnection(nodeId, branch);
            return false;
        });
        
        $('#workflow-canvas').on('mouseup', '.connection-dot.input', function(e) {
            e.stopPropagation();
            e.preventDefault();
            const nodeEl = $(this).closest('.workflow-node');
            const nodeId = nodeEl.attr('id');
            if (isConnecting && connectionStart && connectionStart.nodeId !== nodeId) {
                endConnection(nodeId);
            }
            return false;
        });
    }
    
    // Initialize keyboard shortcuts
    function initializeKeyboardShortcuts() {
        $(document).on('keydown', function(e) {
            // Delete or Backspace key
            if (e.key === 'Delete' || e.key === 'Backspace') {
                // Prevent backspace from navigating back if not in an input field
                if (!$(e.target).is('input, textarea')) {
                    e.preventDefault();
                    
                    // Delete selected node if any
                    if (selectedNode) {
                        removeNode(selectedNode);
                    }
                }
            }
        });
    }
    
    // Create new node
    function createNode(type, x, y, tool) {
        const nodeId = 'node_' + nodeIdCounter++;
        
        // Default descriptions
        const defaultDescriptions = {
            'task': 'Zpracov√°n√≠ dat nebo operace',
            'condition': 'Rozhodovac√≠ bod (if/else)',
            'parallel': 'Paraleln√≠ zpracov√°n√≠',
            'ai-tool': 'Vol√°n√≠ AI n√°stroje'
        };
        
        // If no position provided, auto-position
        if (!x || !y) {
            const nodeCount = Object.keys(nodes).length;
            x = 1000;  // Center horizontally
            y = 100 + (nodeCount * 120);  // Stack vertically
        }
        
        // Adjust position to center the node at click/drop point
        let adjustedX = x;
        let adjustedY = y;
        
        // Offset based on node type to center at cursor
        if (type === 'condition' || type === 'parallel') {
            adjustedX = x - 70; // Half of diamond width
            adjustedY = y - 70; // Half of diamond height  
        } else {
            adjustedX = x - 90; // Half of normal node width
            adjustedY = y - 30; // Approximate half height
        }
        
        const node = {
            id: nodeId,
            type: type,
            name: tool ? $('#nodeToolSelect option[value="' + tool + '"]').text() || tool : getNodeTypeName(type),
            x: adjustedX,
            y: adjustedY,
            tool: tool || null,
            description: defaultDescriptions[type] || '',
            configuration: {}
        };
        
        nodes[nodeId] = node;
        renderNode(node);
    }
    
    // Get node type display name
    function getNodeTypeName(type) {
        const names = {
            'task': 'Proces',
            'condition': 'Rozhodnut√≠',
            'parallel': 'Paraleln√≠ br√°na',
            'tool': 'N√°stroj'
        };
        return names[type] || type;
    }
    
    // Render node
    function renderNode(node) {
        const nodeEl = $('<div>')
            .addClass('workflow-node')
            .addClass(node.type)
            .attr('id', node.id)
            .css({
                left: node.x + 'px',
                top: node.y + 'px'
            });
        
        // Create wrapper for diamond-shaped nodes (condition and parallel)
        let contentWrapper;
        if (node.type === 'condition' || node.type === 'parallel') {
            contentWrapper = $('<div>').addClass('node-content-wrapper');
            nodeEl.append(contentWrapper);
        } else {
            contentWrapper = nodeEl;
        }
        
        // Header
        const header = $('<div>').addClass('node-header');
        header.append($('<span>').html(`<i class="${getNodeIcon(node.type)}"></i> ${node.name}`));
        
        // Close button for all nodes
        header.append($('<span>').addClass('node-close').html('√ó').click(function(e) {
            e.stopPropagation();
            removeNode(node.id);
        }));
        
        contentWrapper.append(header);
        
        // Description
        if (node.description) {
            const descDiv = $('<div>')
                .css({
                    fontSize: '12px',
                    color: '#666',
                    marginTop: '5px',
                    fontStyle: 'italic'
                })
                .text(node.description);
            contentWrapper.append(descDiv);
        }
        
        // Tool
        if (node.tool) {
            const toolDiv = $('<div>').addClass('node-tools');
            const toolName = $('#nodeToolSelect option[value="' + node.tool + '"]').text() || node.tool;
            toolDiv.append($('<span>').addClass('tool-badge').text(toolName));
            contentWrapper.append(toolDiv);
        }
        
        // ReAct badge
        if (node.useReAct) {
            const reactBadge = $('<span>')
                .addClass('badge badge-purple')
                .html('<i class="fas fa-brain"></i> ReAct')
                .css({
                    position: 'absolute',
                    top: '5px',
                    right: '25px',
                    fontSize: '11px'
                });
            nodeEl.append(reactBadge);
        }
        
        // Connection dots - all nodes can have input and output
        nodeEl.append($('<div>').addClass('connection-dot input'));
        
        if (node.type === 'condition') {
                // Two outputs for condition - TRUE and FALSE
                nodeEl.append($('<div>')
                    .addClass('connection-dot output true')
                    .attr('title', 'TRUE')
                    .attr('data-branch', 'true'));
                nodeEl.append($('<div>')
                    .addClass('connection-dot output false')
                    .attr('title', 'FALSE')
                    .attr('data-branch', 'false'));
        } else {
            nodeEl.append($('<div>').addClass('connection-dot output'));
        }
        
        // Events
        nodeEl.on('click', function(e) {
            e.stopPropagation();
            selectNode(node.id);
        });
        
        nodeEl.on('dblclick', function(e) {
            e.stopPropagation();
            editNode(node.id);
        });
        
        // Make draggable
        makeDraggable(nodeEl, node);
        
        // Connection events are now handled globally in initializeCanvas()
        
        $('#workflow-canvas').append(nodeEl);
    }
    
    // Get node icon
    function getNodeIcon(type) {
        const icons = {
            'task': 'fas fa-tasks',
            'condition': 'fas fa-question-circle',
            'parallel': 'fas fa-code-branch',
            'tool': 'fas fa-robot'
        };
        return icons[type] || 'fas fa-circle';
    }
    
    // Make element draggable
    function makeDraggable(element, node) {
        let isDragging = false;
        let startX, startY, initialX, initialY;
        
        element.on('mousedown', function(e) {
            if ($(e.target).hasClass('node-close') || $(e.target).hasClass('connection-dot')) return;
            
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            initialX = node.x;
            initialY = node.y;
            
            $(document).on('mousemove.drag', function(e) {
                if (!isDragging) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                node.x = initialX + dx;
                node.y = initialY + dy;
                
                element.css({
                    left: node.x + 'px',
                    top: node.y + 'px'
                });
                
                updateConnections();
            });
            
            $(document).on('mouseup.drag', function() {
                isDragging = false;
                $(document).off('.drag');
            });
        });
    }
    
    // Connection management
    function startConnection(nodeId, branch) {
        console.log('Starting connection from:', nodeId, 'branch:', branch);
        isConnecting = true;
        connectionStart = {
            nodeId: nodeId,
            branch: branch
        };
        
        // Add visual feedback to source node
        $('#' + nodeId).addClass('connection-source');
        
        // Change cursor
        $('#workflow-canvas').css('cursor', 'crosshair');
        
        // Create temporary line with preview style
        const tempLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        tempLine.setAttribute('id', 'temp-connection');
        tempLine.setAttribute('class', 'connection-line-preview');
        $('#connections-svg')[0].appendChild(tempLine);
        
        // Get start position - from output dot
        const startNode = nodes[nodeId];
        const startEl = $('#' + nodeId);
        
        // Find the specific output dot we're dragging from
        let outputDot;
        if (branch) {
            outputDot = startEl.find(`.connection-dot.output.${branch}`);
        } else {
            outputDot = startEl.find('.connection-dot.output');
        }
        
        // Use getBoundingClientRect for accurate position
        const canvasRect = $('#workflow-canvas')[0].getBoundingClientRect();
        const outputDotRect = outputDot[0].getBoundingClientRect();
        const startX = outputDotRect.left - canvasRect.left + (outputDotRect.width / 2);
        const startY = outputDotRect.top - canvasRect.top + (outputDotRect.height / 2);
        
        // Mouse move to update temp line with magnetic effect
        $(document).on('mousemove.connection', function(e) {
            const rect = $('#workflow-canvas')[0].getBoundingClientRect();
            let x = e.clientX - rect.left + $('#workflow-canvas').scrollLeft();
            let y = e.clientY - rect.top + $('#workflow-canvas').scrollTop();
            
            // Magnetic effect - find nearby input dots
            const magnetRadius = 30; // pixels
            let magnetized = false;
            
            $('.connection-dot.input').each(function() {
                const inputNodeId = $(this).closest('.workflow-node').attr('id');
                
                // Skip if it's the same node we're dragging from
                if (inputNodeId === connectionStart.nodeId) return;
                
                const inputRect = this.getBoundingClientRect();
                const inputX = inputRect.left - rect.left + $('#workflow-canvas').scrollLeft() + (inputRect.width / 2);
                const inputY = inputRect.top - rect.top + $('#workflow-canvas').scrollTop() + (inputRect.height / 2);
                
                // Calculate distance
                const distance = Math.sqrt(Math.pow(x - inputX, 2) + Math.pow(y - inputY, 2));
                
                if (distance < magnetRadius) {
                    // Snap to the input dot
                    x = inputX;
                    y = inputY;
                    magnetized = true;
                    
                    // Add visual feedback
                    $(this).addClass('magnetic-hover');
                    $('#' + inputNodeId).addClass('connection-target-valid');
                    
                    // Store the magnetized target
                    tempLine.setAttribute('data-magnetic-target', inputNodeId);
                    return false; // Break the loop
                } else {
                    $(this).removeClass('magnetic-hover');
                    $('#' + inputNodeId).removeClass('connection-target-valid');
                }
            });
            
            if (!magnetized) {
                tempLine.removeAttribute('data-magnetic-target');
                $('.connection-dot.input').removeClass('magnetic-hover');
                $('.workflow-node').removeClass('connection-target-valid');
            }
            
            tempLine.setAttribute('x1', startX);
            tempLine.setAttribute('y1', startY);
            tempLine.setAttribute('x2', x);
            tempLine.setAttribute('y2', y);
        });
        
        // Global mouseup to end or cancel connection
        $(document).on('mouseup.connection', function(e) {
            // Check if we're magnetized to a target
            const magneticTarget = tempLine.getAttribute('data-magnetic-target');
            
            if (magneticTarget) {
                // Complete the connection to the magnetized target
                endConnection(magneticTarget);
            } else if (!($(e.target).hasClass('connection-dot') && $(e.target).hasClass('input'))) {
                // If not on a valid input dot and not magnetized, cancel
                console.log('Connection cancelled');
                
                // Clean up
                $('#temp-connection').remove();
                isConnecting = false;
                connectionStart = null;
                $('#workflow-canvas').css('cursor', 'default');
                $(document).off('.connection');
                $('.connection-dot.input').removeClass('magnetic-hover');
                $('.workflow-node').removeClass('connection-source connection-target-valid connection-target-invalid');
            }
        });
    }
    
    function endConnection(nodeId) {
        console.log('Ending connection at:', nodeId);
        if (connectionStart && connectionStart.nodeId !== nodeId) {
            // Check if connection already exists
            const exists = connections.some(c => 
                c.from === connectionStart.nodeId && c.to === nodeId
            );
            
            if (!exists) {
                // Check if target already has an input connection - but allow it for now
                const existingToInput = connections.filter(c => c.to === nodeId);
                if (existingToInput.length > 0) {
                    console.log('Warning: Node already has input connection, but allowing new one');
                    // Remove the old connection to this node
                    connections = connections.filter(c => c.to !== nodeId);
                }
                
                // Check if output already has a connection (except for parallel gateway)
                const fromNode = nodes[connectionStart.nodeId];
                const existingFromOutput = connections.filter(c => 
                    c.from === connectionStart.nodeId && 
                    (!connectionStart.branch || c.branch === connectionStart.branch)
                );
                
                // Allow only one connection per output, except for parallel gateway
                if (existingFromOutput.length > 0 && fromNode.type !== 'parallel') {
                    toastr.warning('Tento v√Ωstup u≈æ m√° spojen√≠. Nejd≈ô√≠v ho odstra≈àte.');
                    cancelConnection();
                    return;
                }
                
                const connection = {
                    from: connectionStart.nodeId,
                    to: nodeId
                };
                
                // If from a condition node, store which branch
                if (connectionStart.branch) {
                    connection.branch = connectionStart.branch;
                }
                
                connections.push(connection);
                updateConnections();
                
                const branchInfo = connectionStart.branch ? ` (${connectionStart.branch.toUpperCase()})` : '';
                toastr.success('Propojeno' + branchInfo + '!');
            } else {
                toastr.warning('Toto propojen√≠ ji≈æ existuje');
            }
        }
        
        // Clean up
        $('#temp-connection').remove();
        isConnecting = false;
        connectionStart = null;
        $('#workflow-canvas').css('cursor', 'default');
        $(document).off('.connection');
        $('.connection-dot.input').removeClass('magnetic-hover');
        $('.workflow-node').removeClass('connection-source connection-target-valid connection-target-invalid');
    }
    
    function cancelConnection() {
        // Clean up
        $('#temp-connection').remove();
        isConnecting = false;
        connectionStart = null;
        $('#workflow-canvas').css('cursor', 'default');
        $(document).off('.connection');
        $('.connection-dot.input').removeClass('magnetic-hover');
        $('.workflow-node').removeClass('connection-source connection-target-valid connection-target-invalid');
    }
    
    // Update SVG connections
    function updateConnections() {
        const svg = $('#connections-svg');
        svg.find('line:not(#temp-connection)').remove();
        
        connections.forEach(conn => {
            const fromNode = nodes[conn.from];
            const toNode = nodes[conn.to];
            
            if (fromNode && toNode) {
                const fromEl = $('#' + conn.from);
                const toEl = $('#' + conn.to);
                
                // Get exact positions from connection dots
                let outputDot;
                if (conn.branch && fromNode.type === 'condition') {
                    outputDot = fromEl.find(`.connection-dot.output.${conn.branch}`);
                } else {
                    outputDot = fromEl.find('.connection-dot.output');
                }
                
                const inputDot = toEl.find('.connection-dot.input');
                
                // Use getBoundingClientRect for accurate positions including transforms
                const canvasRect = $('#workflow-canvas')[0].getBoundingClientRect();
                const outputDotRect = outputDot[0].getBoundingClientRect();
                const inputDotRect = inputDot[0].getBoundingClientRect();
                
                // Calculate positions relative to canvas
                const x1 = outputDotRect.left - canvasRect.left + (outputDotRect.width / 2);
                const y1 = outputDotRect.top - canvasRect.top + (outputDotRect.height / 2);
                const x2 = inputDotRect.left - canvasRect.left + (inputDotRect.width / 2);
                const y2 = inputDotRect.top - canvasRect.top + (inputDotRect.height / 2);
                
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x1);
                line.setAttribute('y1', y1);
                line.setAttribute('x2', x2);
                line.setAttribute('y2', y2);
                line.setAttribute('class', 'connection-line');
                line.setAttribute('marker-end', 'url(#arrowhead)');
                
                // Color code branches and use appropriate arrowhead
                if (conn.branch === 'true') {
                    line.setAttribute('stroke', '#28a745');
                    line.setAttribute('marker-end', 'url(#arrowhead-green)');
                } else if (conn.branch === 'false') {
                    line.setAttribute('stroke', '#dc3545');
                    line.setAttribute('marker-end', 'url(#arrowhead-red)');
                }
                
                svg[0].appendChild(line);
            }
        });
    }
    
    // Node selection
    function selectNode(nodeId) {
        deselectAll();
        selectedNode = nodeId;
        $('#' + nodeId).addClass('selected');
    }
    
    function deselectAll() {
        selectedNode = null;
        $('.workflow-node').removeClass('selected');
    }
    
    // Edit node
    function editNode(nodeId) {
        const node = nodes[nodeId];
        if (!node) return;
        
        $('#editingNodeId').val(nodeId);
        $('#nodeName').val(node.name);
        $('#nodeDescription').val(node.description || '');
        
        // Load configuration parameters
        if (node.configuration) {
            $('#nodeUrl').val(node.configuration.url || '');
            $('#nodeExtractImages').prop('checked', node.configuration.extractImages !== false);
            $('#nodeDownloadImages').prop('checked', node.configuration.downloadImages !== false);
            $('#nodeMaxImages').val(node.configuration.maxImages || 10);
        } else {
            // Default values
            $('#nodeUrl').val('');
            $('#nodeExtractImages').prop('checked', true);
            $('#nodeDownloadImages').prop('checked', true);
            $('#nodeMaxImages').val(10);
        }
        
        // Show/hide sections based on type
        if (node.type === 'condition' || node.type === 'parallel') {
            $('#toolSection').hide();
            $('#executionSection').hide();
            $('#parametersSection').hide();
            $('#conditionSection').toggle(node.type === 'condition');
            if (node.type === 'condition') {
                $('#nodeCondition').val(node.condition || '');
            }
        } else if (node.type === 'tool') {
            $('#toolSection').show();
            $('#executionSection').show();
            $('#parametersSection').show();
            $('#conditionSection').hide();
            
            // Set selected tool
            $('#nodeToolSelect').val(node.tool || '');
            
            // Show/hide test button based on whether tool is selected
            if (node.tool) {
                $('#testToolBtn').show();
            } else {
                $('#testToolBtn').hide();
            }
            
            // Load tool parameters if tool is selected
            if (node.tool) {
                loadToolParameters(node.tool);
                // Wait for parameters to load then fill values
                setTimeout(() => {
                    if (node.configuration) {
                        Object.entries(node.configuration).forEach(([key, value]) => {
                            const input = $(`#dynamicParameters [data-param="${key}"]`);
                            if (input.attr('type') === 'checkbox') {
                                input.prop('checked', value);
                            } else {
                                input.val(value);
                            }
                        });
                    }
                }, 500);
            }
            
            // Set execution settings
            $('#nodeUseReAct').prop('checked', node.useReAct || false);
            $('#nodeTimeout').val(node.timeoutSeconds || 300);
            $('#nodeRetryCount').val(node.retryCount || 3);
        } else {
            $('#toolSection').hide();
            $('#executionSection').show();
            $('#parametersSection').hide();
            $('#conditionSection').hide();
        }
        
        // Reset advanced settings visibility
        $('#advancedSettingsContent').hide();
        
        $('#nodeEditModal').modal('show');
    }
    
    // Validace parametr≈Ø n√°stroje
    function validateToolParameters() {
        let isValid = true;
        const errors = [];
        
        // Vyƒçistit p≈ôedchoz√≠ chyby
        $('#dynamicParameters .form-control').removeClass('is-invalid');
        $('#dynamicParameters .invalid-feedback').hide();
        
        // Proj√≠t v≈°echny parametry
        $('#dynamicParameters [data-param]').each(function() {
            const $input = $(this);
            const paramName = $input.data('param');
            const paramInfoStr = $input.attr('data-param-info');
            
            if (!paramInfoStr) return;
            
            try {
                const paramInfo = JSON.parse(atob(paramInfoStr)); // Decode from base64
                let value = $input.attr('type') === 'checkbox' ? $input.is(':checked') : $input.val();
                
                // Validace povinn√Ωch pol√≠
                if (paramInfo.isRequired && (!value || value === '')) {
                    isValid = false;
                    $input.addClass('is-invalid');
                    $(`#error_${paramName}`).text(`${paramInfo.displayName || paramName} je povinn√© pole`).show();
                    errors.push(`${paramInfo.displayName || paramName} je povinn√© pole`);
                    return;
                }
                
                // Validace podle typu
                if (value !== '' && value !== null) {
                    switch(paramInfo.type) {
                        case 'Integer':
                            const intVal = parseInt(value);
                            if (isNaN(intVal)) {
                                isValid = false;
                                $input.addClass('is-invalid');
                                $(`#error_${paramName}`).text('Mus√≠ b√Ωt cel√© ƒç√≠slo').show();
                                errors.push(`${paramInfo.displayName || paramName}: mus√≠ b√Ωt cel√© ƒç√≠slo`);
                            } else {
                                // Kontrola min/max
                                if (paramInfo.validation) {
                                    if (paramInfo.validation.min !== null && intVal < paramInfo.validation.min) {
                                        isValid = false;
                                        $input.addClass('is-invalid');
                                        $(`#error_${paramName}`).text(`Minim√°ln√≠ hodnota je ${paramInfo.validation.min}`).show();
                                        errors.push(`${paramInfo.displayName || paramName}: minim√°ln√≠ hodnota je ${paramInfo.validation.min}`);
                                    }
                                    if (paramInfo.validation.max !== null && intVal > paramInfo.validation.max) {
                                        isValid = false;
                                        $input.addClass('is-invalid');
                                        $(`#error_${paramName}`).text(`Maxim√°ln√≠ hodnota je ${paramInfo.validation.max}`).show();
                                        errors.push(`${paramInfo.displayName || paramName}: maxim√°ln√≠ hodnota je ${paramInfo.validation.max}`);
                                    }
                                }
                            }
                            break;
                            
                        case 'Decimal':
                            const decVal = parseFloat(value);
                            if (isNaN(decVal)) {
                                isValid = false;
                                $input.addClass('is-invalid');
                                $(`#error_${paramName}`).text('Mus√≠ b√Ωt ƒç√≠slo').show();
                                errors.push(`${paramInfo.displayName || paramName}: mus√≠ b√Ωt ƒç√≠slo`);
                            }
                            break;
                            
                        case 'String':
                            if (paramInfo.validation) {
                                // Kontrola d√©lky
                                if (paramInfo.validation.minLength !== null && value.length < paramInfo.validation.minLength) {
                                    isValid = false;
                                    $input.addClass('is-invalid');
                                    $(`#error_${paramName}`).text(`Minim√°ln√≠ d√©lka je ${paramInfo.validation.minLength} znak≈Ø`).show();
                                    errors.push(`${paramInfo.displayName || paramName}: minim√°ln√≠ d√©lka je ${paramInfo.validation.minLength} znak≈Ø`);
                                }
                                if (paramInfo.validation.maxLength !== null && value.length > paramInfo.validation.maxLength) {
                                    isValid = false;
                                    $input.addClass('is-invalid');
                                    $(`#error_${paramName}`).text(`Maxim√°ln√≠ d√©lka je ${paramInfo.validation.maxLength} znak≈Ø`).show();
                                    errors.push(`${paramInfo.displayName || paramName}: maxim√°ln√≠ d√©lka je ${paramInfo.validation.maxLength} znak≈Ø`);
                                }
                                // Kontrola patternu
                                if (paramInfo.validation.pattern) {
                                    const regex = new RegExp(paramInfo.validation.pattern);
                                    if (!regex.test(value)) {
                                        isValid = false;
                                        $input.addClass('is-invalid');
                                        $(`#error_${paramName}`).text('Neplatn√Ω form√°t').show();
                                        errors.push(`${paramInfo.displayName || paramName}: neplatn√Ω form√°t`);
                                    }
                                }
                            }
                            
                            // Speci√°ln√≠ validace pro URL typ
                            if (paramInfo.uiHints && paramInfo.uiHints.inputType === 'Url') {
                                try {
                                    new URL(value);
                                } catch (e) {
                                    isValid = false;
                                    $input.addClass('is-invalid');
                                    $(`#error_${paramName}`).text('Neplatn√° URL adresa').show();
                                    errors.push(`${paramInfo.displayName || paramName}: neplatn√° URL adresa`);
                                }
                            }
                            break;
                    }
                }
            } catch (e) {
                console.error('Error validating parameter:', e);
            }
        });
        
        return { isValid, errors };
    }
    
    // Update node
    function updateCurrentNode() {
        const nodeId = $('#editingNodeId').val();
        const node = nodes[nodeId];
        if (!node) return;
        
        // Validovat parametry pokud je to n√°stroj
        if (node.type === 'tool' && $('#nodeToolSelect').val()) {
            const validation = validateToolParameters();
            if (!validation.isValid) {
                toastr.error('Opravte chyby ve formul√°≈ôi:<br>' + validation.errors.join('<br>'), 'Chyba validace', {
                    closeButton: true,
                    timeOut: 0,
                    extendedTimeOut: 0
                });
                return;
            }
        }
        
        node.name = $('#nodeName').val();
        node.description = $('#nodeDescription').val();
        
        if (node.type === 'condition') {
            node.condition = $('#nodeCondition').val();
        } else if (node.type === 'tool') {
            node.tool = $('#nodeToolSelect').val() || null;
            
            // Save execution settings
            node.useReAct = $('#nodeUseReAct').is(':checked');
            node.timeoutSeconds = parseInt($('#nodeTimeout').val()) || 300;
            node.retryCount = parseInt($('#nodeRetryCount').val()) || 3;
            
            // Collect parameters dynamically
            node.configuration = {};
            $('#dynamicParameters [data-param]').each(function() {
                const paramName = $(this).data('param');
                let value;
                
                if ($(this).attr('type') === 'checkbox') {
                    value = $(this).is(':checked');
                } else if ($(this).attr('type') === 'number') {
                    value = parseFloat($(this).val()) || 0;
                } else {
                    value = $(this).val();
                }
                
                node.configuration[paramName] = value;
            });
        }
        
        // Re-render node
        $('#' + nodeId).remove();
        renderNode(node);
        
        $('#nodeEditModal').modal('hide');
    }
    
    // Delete node
    function deleteCurrentNode() {
        const nodeId = $('#editingNodeId').val();
        removeNode(nodeId);
        $('#nodeEditModal').modal('hide');
    }
    
    function removeNode(nodeId) {
        delete nodes[nodeId];
        $('#' + nodeId).remove();
        
        // Remove connections
        connections = connections.filter(c => c.from !== nodeId && c.to !== nodeId);
        updateConnections();
    }
    
    // Load initial workflow
    function loadInitialWorkflow() {
        // Simple fixed positions - no complex calculations
        const canvasCenterX = 1000;  // Center of 2000px wide canvas
        
        // Don't create any default nodes - let user build workflow from scratch
        // Just scroll to center the canvas
        setTimeout(() => {
            const container = $('.canvas-container');
            const containerWidth = container.width();
            
            // Center horizontally
            const scrollLeft = canvasCenterX - (containerWidth / 2);
            container.scrollLeft(scrollLeft);
            container.scrollTop(0);
        }, 100);
        
        // Load existing workflow if saved
        const model = @Html.Raw(Json.Serialize(Model));
        if (model && model.metadata && model.metadata.orchestratorData) {
            loadFromOrchestratorFormat(model.metadata.orchestratorData);
        }
    }
    
    // Workflow operations
    function saveWorkflow() {
        return new Promise((resolve, reject) => {
            // Validovat v≈°echny n√°stroje p≈ôed ulo≈æen√≠m
            const toolNodes = Object.values(nodes).filter(n => n.type === 'tool');
            const missingTools = [];
            
            toolNodes.forEach(node => {
                if (!node.tool) {
                    missingTools.push(node.name);
                }
            });
            
            if (missingTools.length > 0) {
                toastr.error('N√°sleduj√≠c√≠ uzly nemaj√≠ p≈ôi≈ôazen√Ω n√°stroj:<br>' + missingTools.join('<br>'), 'Chyba validace');
                reject('Missing tools');
                return;
            }
            
            // Convert to orchestrator-compatible format
            const workflowData = convertToOrchestratorFormat();
            
            console.log('Saving workflow:', workflowData);
            
            // Send to server
            $.ajax({
                url: '/WorkflowDesigner/SaveWorkflow',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    ProjectId: '@Model.ProjectId',
                    WorkflowData: workflowData
                }),
                success: function(response) {
                    if (response.success) {
                        toastr.success('Workflow ulo≈æeno');
                        // Update workflow ID if returned
                        if (response.workflowId) {
                            $('#executionModal').data('workflowId', response.workflowId);
                            console.log('Workflow saved with ID:', response.workflowId);
                        }
                        resolve(response);
                    } else {
                        toastr.error('Chyba p≈ôi ukl√°d√°n√≠');
                        reject('Save failed');
                    }
                },
                error: function() {
                    toastr.error('Chyba p≈ôi komunikaci se serverem');
                    reject('Communication error');
                }
            });
        });
    }
    
    // I/O Configuration
    let workflowIOConfig = {
        input: {
            type: 'images',
            config: {
                formats: ['jpg', 'png', 'webp'],
                maxSize: '10MB',
                source: 'upload'
            }
        },
        output: {
            type: 'excel',
            config: {
                format: 'xlsx',
                includeImages: true,
                fields: ['url', 'price', 'availability', 'similarity']
            }
        }
    };
    
    // Show I/O configuration modal
    function showIOConfig() {
        $('#modalInputType').val(workflowIOConfig.input.type);
        $('#modalOutputType').val(workflowIOConfig.output.type);
        updateInputConfig();
        updateOutputConfig();
        $('#ioConfigModal').modal('show');
    }
    
    // Update input configuration UI
    function updateInputConfig() {
        const inputType = $('#modalInputType').val();
        let configHtml = '';
        
        switch(inputType) {
            case 'images':
                configHtml = `
                    <div class="form-group">
                        <label>Podporovan√© form√°ty</label>
                        <input type="text" class="form-control" id="imageFormats" value="jpg, png, webp" placeholder="jpg, png, gif">
                    </div>
                    <div class="form-group">
                        <label>Max. velikost souboru</label>
                        <input type="text" class="form-control" id="maxFileSize" value="10MB">
                    </div>
                    <div class="form-group">
                        <label>Zdroj</label>
                        <select class="form-control" id="imageSource">
                            <option value="upload">Upload soubor≈Ø</option>
                            <option value="url">URL adresa</option>
                            <option value="api">API endpoint</option>
                        </select>
                    </div>
                `;
                break;
                
            case 'api':
                configHtml = `
                    <div class="form-group">
                        <label>Endpoint URL</label>
                        <input type="url" class="form-control" id="apiEndpoint" placeholder="https://api.example.com/data">
                    </div>
                    <div class="form-group">
                        <label>Metoda</label>
                        <select class="form-control" id="apiMethod">
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Autentizace</label>
                        <select class="form-control" id="apiAuth">
                            <option value="none">≈Ω√°dn√°</option>
                            <option value="bearer">Bearer Token</option>
                            <option value="apikey">API Key</option>
                        </select>
                    </div>
                `;
                break;
                
            case 'database':
                configHtml = `
                    <div class="form-group">
                        <label>Typ datab√°ze</label>
                        <select class="form-control" id="dbType">
                            <option value="postgresql">PostgreSQL</option>
                            <option value="mysql">MySQL</option>
                            <option value="mongodb">MongoDB</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tabulka/Kolekce</label>
                        <input type="text" class="form-control" id="dbTable" placeholder="products">
                    </div>
                    <div class="form-group">
                        <label>Filtr (SQL WHERE / MongoDB query)</label>
                        <textarea class="form-control" id="dbFilter" rows="2"></textarea>
                    </div>
                `;
                break;
                
            case 'csv':
                configHtml = `
                    <div class="form-group">
                        <label>Oddƒõlovaƒç</label>
                        <select class="form-control" id="csvDelimiter">
                            <option value=",">ƒå√°rka (,)</option>
                            <option value=";">St≈ôedn√≠k (;)</option>
                            <option value="\\t">Tabul√°tor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>K√≥dov√°n√≠</label>
                        <select class="form-control" id="csvEncoding">
                            <option value="utf-8">UTF-8</option>
                            <option value="windows-1250">Windows-1250</option>
                        </select>
                    </div>
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="csvHeaders" checked>
                        <label class="custom-control-label" for="csvHeaders">Prvn√≠ ≈ô√°dek obsahuje hlaviƒçky</label>
                    </div>
                `;
                break;
        }
        
        $('#inputConfigDetails').html(configHtml);
    }
    
    // Update output configuration UI
    function updateOutputConfig() {
        const outputType = $('#modalOutputType').val();
        let configHtml = '';
        
        switch(outputType) {
            case 'excel':
                configHtml = `
                    <div class="form-group">
                        <label>N√°zev souboru</label>
                        <input type="text" class="form-control" id="excelFilename" value="vysledky_{timestamp}.xlsx">
                    </div>
                    <div class="form-group">
                        <label>Sloupce</label>
                        <textarea class="form-control" id="excelColumns" rows="3">URL produktu
Cena
Dostupnost
Sk√≥re podobnosti
Obr√°zek</textarea>
                    </div>
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="excelIncludeImages" checked>
                        <label class="custom-control-label" for="excelIncludeImages">Vlo≈æit obr√°zky p≈ô√≠mo do Excelu</label>
                    </div>
                `;
                break;
                
            case 'api':
                configHtml = `
                    <div class="form-group">
                        <label>Webhook URL</label>
                        <input type="url" class="form-control" id="webhookUrl" placeholder="https://webhook.example.com/results">
                    </div>
                    <div class="form-group">
                        <label>Metoda</label>
                        <select class="form-control" id="webhookMethod">
                            <option value="POST">POST</option>
                            <option value="PUT">PUT</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Headers</label>
                        <textarea class="form-control" id="webhookHeaders" rows="2" placeholder='{"Authorization": "Bearer token"}'></textarea>
                    </div>
                `;
                break;
                
            case 'email':
                configHtml = `
                    <div class="form-group">
                        <label>P≈ô√≠jemci (oddƒõlen√© ƒç√°rkou)</label>
                        <input type="text" class="form-control" id="emailRecipients" placeholder="user@example.com, admin@example.com">
                    </div>
                    <div class="form-group">
                        <label>P≈ôedmƒõt</label>
                        <input type="text" class="form-control" id="emailSubject" value="V√Ωsledky workflow {workflow_name}">
                    </div>
                    <div class="form-group">
                        <label>Form√°t p≈ô√≠lohy</label>
                        <select class="form-control" id="emailAttachmentFormat">
                            <option value="excel">Excel</option>
                            <option value="csv">CSV</option>
                            <option value="pdf">PDF</option>
                        </select>
                    </div>
                `;
                break;
        }
        
        $('#outputConfigDetails').html(configHtml);
    }
    
    // Save I/O configuration
    function saveIOConfig() {
        const inputType = $('#modalInputType').val();
        const outputType = $('#modalOutputType').val();
        
        // Save input config
        workflowIOConfig.input.type = inputType;
        workflowIOConfig.input.config = {};
        
        // Save output config
        workflowIOConfig.output.type = outputType;
        workflowIOConfig.output.config = {};
        
        // Update the dropdowns in toolbox
        $('#workflowInputType').val(inputType);
        $('#workflowOutputType').val(outputType);
        
        $('#ioConfigModal').modal('hide');
        toastr.success('Konfigurace vstup≈Ø a v√Ωstup≈Ø ulo≈æena');
    }
    
    // Convert visual workflow to orchestrator format
    function convertToOrchestratorFormat() {
        console.log('Converting workflow with connections:', connections);
        const steps = [];
        const nodeMap = {};
        
        // First pass - create steps
        Object.values(nodes).forEach((node, index) => {
            const step = {
                id: node.id,
                name: node.name,
                type: mapNodeTypeToStepType(node.type),
                description: node.description || '',
                position: index
            };
            
            // Add type-specific properties
            if (node.type === 'tool') {
                step.tool = node.tool || null;
                step.useReAct = node.useReAct || false;
                step.timeoutSeconds = node.timeoutSeconds || 300;
                step.retryCount = node.retryCount || 3;
                // Add configuration parameters
                step.configuration = node.configuration || {};
            } else if (node.type === 'condition') {
                step.condition = node.condition || 'true';
                step.branches = {
                    true: [],
                    false: []
                };
            } else if (node.type === 'parallel') {
                step.branches = [];
            }
            
            steps.push(step);
            nodeMap[node.id] = step;
        });
        
        // Second pass - build connections
        // Find nodes without incoming connections (entry points)
        const nodesWithIncoming = new Set(connections.map(c => c.to));
        const entryNodes = Object.keys(nodeMap).filter(id => !nodesWithIncoming.has(id));
        const firstStepId = entryNodes[0] || Object.keys(nodeMap)[0];
        
        // Find nodes without outgoing connections (exit points)
        const nodesWithOutgoing = new Set(connections.map(c => c.from));
        const lastStepIds = Object.keys(nodeMap).filter(id => !nodesWithOutgoing.has(id));
        
        // Build step sequence
        steps.forEach(step => {
            const outgoingConnections = connections.filter(c => c.from === step.id);
            console.log(`Processing ${step.id} (${step.type}), outgoing connections:`, outgoingConnections);
            
            if (step.type === 'decision') {
                // For conditions, use the branch info from connection
                outgoingConnections.forEach(conn => {
                    const targetStep = nodeMap[conn.to];
                    if (targetStep) {
                        const branch = conn.branch || 'true';
                        step.branches[branch].push(targetStep.id);
                    }
                });
                // Remove 'next' if it was set
                delete step.next;
            } else if (step.type === 'parallel-gateway') {
                // For parallel, all connections are branches
                step.branches = outgoingConnections
                    .map(conn => nodeMap[conn.to]?.id)
                    .filter(id => id != null);
                // Remove 'next' if it was set
                delete step.next;
            } else {
                // For regular steps, find next step
                const nextConnection = outgoingConnections[0];
                if (nextConnection) {
                    const nextStep = nodeMap[nextConnection.to];
                    if (nextStep) {
                        step.next = nextStep.id;
                    }
                } else {
                    // No outgoing connection - this is a final step
                    step.isFinal = true;
                }
            }
        });
        
        // Get the current orchestrator settings if available
        const model = @Html.Raw(Json.Serialize(Model));
        const currentSettings = model?.metadata?.settings || {};
        
        return {
            name: 'Workflow ' + new Date().toISOString(),
            description: 'Visual workflow designer output',
            firstStepId: firstStepId,
            lastStepIds: lastStepIds,
            steps: steps,
            input: workflowIOConfig.input,  // Add input configuration
            output: workflowIOConfig.output, // Add output configuration
            metadata: {
                createdWith: 'SimpleWorkflowDesigner',
                createdAt: new Date().toISOString(),
                nodePositions: Object.values(nodes).reduce((acc, node) => {
                    acc[node.id] = { 
                        x: node.x, 
                        y: node.y,
                        type: node.type
                    };
                    return acc;
                }, {}),
                settings: currentSettings // Preserve orchestrator settings
            }
        };
    }
    
    function mapNodeTypeToStepType(nodeType) {
        const typeMap = {
            'task': 'process',
            'tool': 'tool',
            'condition': 'decision',
            'parallel': 'parallel-gateway'
        };
        return typeMap[nodeType] || nodeType;
    }
    
    function validateWorkflow() {
        const errors = [];
        
        // Check if there are any nodes
        if (Object.keys(nodes).length === 0) {
            errors.push('Workflow je pr√°zdn√©');
        }
        
        // Check disconnected nodes (but first/last nodes can have open connections)
        Object.values(nodes).forEach(node => {
            const hasInput = connections.some(c => c.to === node.id);
            const hasOutput = connections.some(c => c.from === node.id);
            
            // At least one node should be an entry point (no input)
            // At least one node should be an exit point (no output)
            // But not all nodes need both
            if (!hasInput && !hasOutput && Object.keys(nodes).length > 1) {
                errors.push(`Uzel "${node.name}" nen√≠ propojen√Ω`);
            }
        });
        
        if (errors.length === 0) {
            toastr.success('Workflow je validn√≠');
        } else {
            toastr.error(errors.join('<br>'), 'Chyby ve workflow');
        }
    }
    
    function testWorkflow() {
        const workflowData = convertToOrchestratorFormat();
        
        // Show JSON in console for debugging
        console.log('Orchestrator format:', JSON.stringify(workflowData, null, 2));
        
        // You can also show it in a modal or download as file
        const jsonStr = JSON.stringify(workflowData, null, 2);
        
        // Create download link
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `workflow-${currentProjectId || 'export'}-orchestrator.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        toastr.info('Export pro orchestr√°tor byl sta≈æen');
    }
    
    function clearWorkflow() {
        if (confirm('Opravdu vymazat workflow?')) {
            nodes = {};
            connections = [];
            $('.workflow-node').remove();
            $('svg line').remove();
            
            // Canvas is now empty - ready for new workflow
        }
    }
    
    // Workflow execution functions
    let currentExecutionId = null;
    let executionCheckInterval = null;
    
    function runWorkflow() {
        // First save the workflow to ensure it's up to date
        saveWorkflow().then(() => {
            $('#executionModal').modal('show');
            resetExecutionModal();
        }).catch(error => {
            toastr.error('Mus√≠te nejd≈ô√≠ve ulo≈æit workflow');
        });
    }
    
    function resetExecutionModal() {
        $('#executionSetup').show();
        $('#executionProgress').hide();
        $('#executionResults').hide();
        $('#startExecutionBtn').show();
        $('#cancelExecutionBtn').hide();
        $('#executionParameters').val('{}');
        $('#executionSteps').empty();
        $('#executionLog').empty();
        currentExecutionId = null;
        
        if (executionCheckInterval) {
            clearInterval(executionCheckInterval);
            executionCheckInterval = null;
        }
    }
    
    function startExecution() {
        const executionName = $('#executionName').val();
        const parametersText = $('#executionParameters').val();
        const enableDebug = $('#enableDebugLogging').is(':checked');
        
        // Validate JSON parameters
        let parameters = {};
        try {
            parameters = JSON.parse(parametersText);
        } catch (e) {
            toastr.error('Neplatn√© JSON parametry');
            return;
        }
        
        // Switch to progress view
        $('#executionSetup').hide();
        $('#executionProgress').show();
        $('#startExecutionBtn').hide();
        $('#cancelExecutionBtn').show();
        
        // Get the workflow ID from modal data or model
        let workflowId = $('#executionModal').data('workflowId') || '@Model.WorkflowId';
        
        console.log('About to execute workflow:', workflowId);
        console.log('Parameters:', parameters);
        
        if (!workflowId || workflowId === '00000000-0000-0000-0000-000000000000') {
            toastr.error('Workflow mus√≠ b√Ωt nejd≈ô√≠ve ulo≈æeno');
            resetExecutionModal();
            return;
        }
        
        // Start execution via API
        const requestData = {
            inputParameters: parameters,
            enableDebugLogging: enableDebug,
            initiatedBy: "user" // Add this field
        };
        
        console.log('Sending execution request:', requestData, 'to workflow:', workflowId);
        
        $.ajax({
            url: `/api/workflow/execute/${workflowId}`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData),
            success: function(response) {
                if (response.success && response.data) {
                    currentExecutionId = response.data.executionId;
                    addLogEntry('Workflow spu≈°tƒõno s ID: ' + currentExecutionId, 'info');
                    
                    // Start polling for status
                    executionCheckInterval = setInterval(checkExecutionStatus, 2000);
                } else {
                    toastr.error(response.message || 'Chyba p≈ôi spou≈°tƒõn√≠ workflow');
                    showExecutionError(response.message || 'Nezn√°m√° chyba');
                }
            },
            error: function(xhr) {
                console.error('Execution failed:', xhr);
                console.error('Response:', xhr.responseJSON);
                console.error('Response Text:', xhr.responseText);
                
                const errorMsg = xhr.responseJSON?.message || xhr.responseJSON?.errors?.[0] || 'Chyba p≈ôi spou≈°tƒõn√≠ workflow';
                const errors = xhr.responseJSON?.errors || [];
                
                if (errors.length > 0) {
                    errors.forEach(err => toastr.error(err));
                } else {
                    toastr.error(errorMsg);
                }
                showExecutionError(errorMsg);
            }
        });
    }
    
    function checkExecutionStatus() {
        if (!currentExecutionId) return;
        
        $.ajax({
            url: `/api/workflow/status/${currentExecutionId}`,
            method: 'GET',
            success: function(response) {
                if (response.success && response.data) {
                    updateExecutionProgress(response.data);
                    
                    // Check if execution is complete
                    if (response.data.status !== 'Running' && response.data.status !== 'Pending') {
                        clearInterval(executionCheckInterval);
                        executionCheckInterval = null;
                        
                        if (response.data.status === 'Completed') {
                            showExecutionSuccess();
                        } else {
                            showExecutionError(response.data.message || 'Workflow selhalo');
                        }
                    }
                }
            },
            error: function(xhr) {
                console.error('Error checking execution status:', xhr);
            }
        });
    }
    
    function updateExecutionProgress(status) {
        // Update progress bar
        const progress = Math.round(status.progressPercentage || 0);
        $('#progressBar').css('width', progress + '%').text(progress + '%');
        
        // Update current step
        if (status.currentStepName) {
            const stepExists = $(`#step-${status.currentStepId}`).length > 0;
            if (!stepExists) {
                addExecutionStep(status.currentStepId, status.currentStepName, 'running');
            }
        }
        
        // Add log message if available
        if (status.message) {
            addLogEntry(status.message, 'info');
        }
    }
    
    function addExecutionStep(stepId, stepName, status) {
        const stepHtml = `
            <div id="step-${stepId}" class="execution-step ${status}">
                <i class="fas fa-${status === 'running' ? 'spinner fa-spin' : 
                                 status === 'completed' ? 'check-circle' : 
                                 'times-circle'}"></i>
                ${stepName}
            </div>
        `;
        $('#executionSteps').append(stepHtml);
    }
    
    function addLogEntry(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logHtml = `
            <div class="log-entry ${type}">
                [${timestamp}] ${message}
            </div>
        `;
        $('#executionLog').append(logHtml);
        $('#executionLog').scrollTop($('#executionLog')[0].scrollHeight);
    }
    
    function showExecutionSuccess() {
        $('#executionProgress').hide();
        $('#executionResults').show();
        $('#cancelExecutionBtn').hide();
        
        $('#executionResultAlert')
            .removeClass('alert-danger')
            .addClass('alert-success')
            .html('<i class="fas fa-check-circle"></i> Workflow bylo √∫spƒõ≈°nƒõ dokonƒçeno!');
        
        // TODO: Show output data when available
    }
    
    function showExecutionError(message) {
        $('#executionProgress').hide();
        $('#executionResults').show();
        $('#cancelExecutionBtn').hide();
        
        $('#executionResultAlert')
            .removeClass('alert-success')
            .addClass('alert-danger')
            .html(`<i class="fas fa-exclamation-circle"></i> ${message}`);
    }
    
    function cancelExecution() {
        if (!currentExecutionId) return;
        
        if (confirm('Opravdu chcete zru≈°it prob√≠haj√≠c√≠ workflow?')) {
            $.ajax({
                url: `/api/workflow/cancel/${currentExecutionId}`,
                method: 'POST',
                success: function(response) {
                    if (response.success) {
                        toastr.info('Workflow bylo zru≈°eno');
                        clearInterval(executionCheckInterval);
                        showExecutionError('Workflow bylo zru≈°eno u≈æivatelem');
                    }
                },
                error: function(xhr) {
                    toastr.error('Nepoda≈ôilo se zru≈°it workflow');
                }
            });
        }
    }
    
    function autoLayout() {
        // Check if there are any nodes
        if (Object.keys(nodes).length === 0) {
            toastr.warning('Nejsou ≈æ√°dn√© uzly k rozlo≈æen√≠');
            return;
        }
        
        // Find entry point - node without incoming connections
        const nodesWithIncoming = new Set(connections.map(c => c.to));
        let startNodeId = Object.keys(nodes).find(id => !nodesWithIncoming.has(id));
        
        // If no clear entry point, just use first node
        if (!startNodeId) {
            startNodeId = Object.keys(nodes)[0];
        }
        
        // Layout parameters
        const canvasWidth = $('#workflow-canvas').width();
        const centerX = canvasWidth / 2;
        const verticalSpacing = 150;
        const horizontalSpacing = 250;
        const visited = new Set();
        let maxY = 100;
        
        // Helper function to get node connections
        function getNodeConnections(nodeId) {
            const node = nodes[nodeId];
            const outgoing = connections.filter(c => c.from === nodeId);
            const result = {
                next: null,
                branches: {}
            };
            
            if (node.type === 'condition') {
                outgoing.forEach(conn => {
                    const branch = conn.branch || 'true';
                    result.branches[branch] = conn.to;
                });
            } else if (node.type === 'parallel') {
                result.branches = outgoing.reduce((acc, conn, idx) => {
                    acc[`branch${idx}`] = conn.to;
                    return acc;
                }, {});
            } else if (outgoing.length > 0) {
                result.next = outgoing[0].to;
            }
            
            return result;
        }
        
        // Recursive layout function
        function layoutNode(nodeId, x, y) {
            if (visited.has(nodeId)) return y;
            visited.add(nodeId);
            
            const node = nodes[nodeId];
            if (!node) return y;
            
            // Center node based on type
            let adjustedX = x;
            if (node.type === 'condition' || node.type === 'parallel') {
                adjustedX = x - 70; // Half of diamond width
            } else {
                adjustedX = x - 90; // Half of normal node width
            }
            
            // Position node
            node.x = adjustedX;
            node.y = y;
            $('#' + node.id).css({
                left: node.x + 'px',
                top: node.y + 'px'
            });
            
            maxY = Math.max(maxY, y);
            
            // Get connections
            const conns = getNodeConnections(nodeId);
            let nextY = y + verticalSpacing;
            
            if (node.type === 'condition' && Object.keys(conns.branches).length > 0) {
                // Layout branches side by side at the same Y position
                const leftX = x - horizontalSpacing / 2;
                const rightX = x + horizontalSpacing / 2;
                const branchY = nextY + 50; // Add 50px offset for better visual clarity
                let branchMaxY = branchY;
                
                if (conns.branches.true) {
                    branchMaxY = Math.max(branchMaxY, layoutNode(conns.branches.true, leftX, branchY));
                }
                if (conns.branches.false) {
                    branchMaxY = Math.max(branchMaxY, layoutNode(conns.branches.false, rightX, branchY));
                }
                nextY = branchMaxY;
            } else if (node.type === 'parallel' && Object.keys(conns.branches).length > 0) {
                // Layout parallel branches at the same Y position
                const branchCount = Object.keys(conns.branches).length;
                // Reduce spacing if too many branches
                const adjustedSpacing = branchCount > 4 ? horizontalSpacing * 0.7 : horizontalSpacing;
                const totalWidth = (branchCount - 1) * adjustedSpacing;
                let branchX = x - totalWidth / 2;
                const branchY = nextY + 50; // Add 50px offset for better visual clarity
                let branchMaxY = branchY;
                
                Object.values(conns.branches).forEach(targetId => {
                    branchMaxY = Math.max(branchMaxY, layoutNode(targetId, branchX, branchY));
                    branchX += adjustedSpacing;
                });
                nextY = branchMaxY;
            } else if (conns.next) {
                // Regular next node
                nextY = layoutNode(conns.next, x, nextY);
            }
            
            return nextY;
        }
        
        // Start layout from entry point
        layoutNode(startNodeId, centerX, 100);
        
        // Layout any unvisited nodes (disconnected components)
        Object.keys(nodes).forEach(nodeId => {
            if (!visited.has(nodeId)) {
                maxY += verticalSpacing;
                layoutNode(nodeId, centerX, maxY);
            }
        });
        
        updateConnections();
        toastr.success('Uzly byly automaticky rozm√≠stƒõny');
    }
    
    // Load workflow from orchestrator format
    function loadFromOrchestratorFormat(data) {
        if (!data || !data.steps) return;
        
        // Load I/O configuration if available
        if (data.input) {
            workflowIOConfig.input = data.input;
            $('#workflowInputType').val(data.input.type);
        }
        if (data.output) {
            workflowIOConfig.output = data.output;
            $('#workflowOutputType').val(data.output.type);
        }
        
        // Clear existing
        Object.keys(nodes).forEach(nodeId => {
            removeNode(nodeId);
        });
        connections = [];
        
        // Get node positions from metadata if available
        const positions = data.metadata?.nodePositions || {};
        
        // Create nodes from steps
        data.steps.forEach((step, index) => {
            const pos = positions[step.id] || {
                x: 1000,
                y: 300 + (index * 150)
            };
            
            // Map step type back to node type
            let nodeType = 'task';
            if (step.type === 'decision') nodeType = 'condition';
            else if (step.type === 'parallel-gateway') nodeType = 'parallel';
            else if (step.type === 'tool') nodeType = 'tool';
            
            // Create the node
            const nodeId = step.id;
            nodes[nodeId] = {
                id: nodeId,
                type: nodeType,
                name: step.name,
                x: pos.x,
                y: pos.y,
                tool: step.tool || null,
                description: step.description || '',
                condition: step.condition,
                useReAct: step.useReAct,
                timeoutSeconds: step.timeoutSeconds,
                retryCount: step.retryCount,
                configuration: step.configuration || {}
            };
            renderNode(nodes[nodeId]);
        });
        
        // Recreate connections
        
        // Connect steps based on their next/branches
        data.steps.forEach(step => {
            if (step.type === 'decision' && step.branches) {
                // Decision node connections
                if (step.branches.true && step.branches.true.length > 0) {
                    connections.push({
                        from: step.id,
                        to: step.branches.true[0],
                        branch: 'true'
                    });
                }
                if (step.branches.false && step.branches.false.length > 0) {
                    connections.push({
                        from: step.id,
                        to: step.branches.false[0],
                        branch: 'false'
                    });
                }
            } else if (step.type === 'parallel-gateway' && step.branches) {
                // Parallel gateway connections
                step.branches.forEach(targetId => {
                    connections.push({
                        from: step.id,
                        to: targetId
                    });
                });
            } else if (step.next) {
                // Regular step connection
                connections.push({
                    from: step.id,
                    to: step.next
                });
            }
            // Final steps just don't have outgoing connections
        });
        
        updateConnections();
        toastr.info('Workflow naƒçteno');
    }
    
    // Load workflow from server
    function loadWorkflowFromServer() {
        $.ajax({
            url: '/WorkflowDesigner/LoadWorkflow',
            type: 'GET',
            data: { projectId: currentProjectId },
            success: function(response) {
                if (response.success && response.workflow) {
                    // Check if we have orchestrator data in metadata
                    if (response.workflow.metadata && response.workflow.metadata.orchestratorData) {
                        // Load from orchestrator format
                        loadFromOrchestratorFormat(response.workflow.metadata.orchestratorData);
                    } else if (response.workflow.nodes && response.workflow.nodes.length > 0) {
                        // Load nodes directly from workflow
                        response.workflow.nodes.forEach(node => {
                            const nodeData = {
                                id: node.id,
                                type: node.type.toLowerCase(),
                                name: node.name,
                                x: node.position.x,
                                y: node.position.y,
                                tools: node.tools || [],
                                description: ''
                            };
                            nodes[node.id] = nodeData;
                            renderNode(nodeData);
                        });
                        
                        // Load edges
                        if (response.workflow.edges) {
                            response.workflow.edges.forEach(edge => {
                                connections.push({
                                    from: edge.source,
                                    to: edge.target
                                });
                            });
                            updateConnections();
                        }
                    }
                    console.log('Loaded nodes:', nodes);
                    console.log('Loaded connections:', connections);
                } else {
                    // Create empty workflow
                    loadInitialWorkflow();
                }
            },
            error: function() {
                // Create empty workflow on error
                loadInitialWorkflow();
            }
        });
    }
    
    // Zoom functions
    function zoomIn() {
        currentZoom = Math.min(currentZoom + 0.1, 2.0);
        applyZoom();
    }
    
    function zoomOut() {
        currentZoom = Math.max(currentZoom - 0.1, 0.5);
        applyZoom();
    }
    
    function zoomReset() {
        currentZoom = 1.0;
        applyZoom();
    }
    
    function applyZoom() {
        $('#workflow-canvas').css('transform', `scale(${currentZoom})`);
        $('#workflow-canvas').css('transform-origin', '0 0');
        
        // Also scale the SVG overlay
        $('#connections-svg').css('transform', `scale(${currentZoom})`);
        $('#connections-svg').css('transform-origin', '0 0');
        
        // Update zoom display
        $('.zoom-level').text(Math.round(currentZoom * 100) + '%');
        
        // Adjust canvas size to prevent cutoff
        $('.canvas-container').css('overflow', 'auto');
    }
    
    // Toggle advanced settings in node edit modal
    function toggleAdvancedSettings() {
        $('#advancedSettingsContent').slideToggle();
    }
    
    // Test current tool
    function testCurrentTool() {
        const nodeId = $('#editingNodeId').val();
        const node = nodes[nodeId];
        
        if (!node || !node.tool) {
            toastr.error('Nejprve vyberte n√°stroj');
            return;
        }
        
        // Get current parameter values from the edit modal
        const parameters = {};
        $('#dynamicParameters [data-param]').each(function() {
            const paramName = $(this).data('param');
            let value;
            
            if ($(this).attr('type') === 'checkbox') {
                value = $(this).is(':checked');
            } else if ($(this).attr('type') === 'number') {
                value = parseFloat($(this).val()) || 0;
            } else {
                value = $(this).val();
            }
            
            parameters[paramName] = value;
        });
        
        // Hide edit modal and show test modal
        $('#nodeEditModal').modal('hide');
        
        // Set up test modal
        $('#testToolName').text(node.name || node.tool);
        loadTestToolParameters(node.tool, parameters);
        
        // Show test modal
        $('#toolTestModal').modal('show');
    }
    
    // Load tool parameters for testing
    function loadTestToolParameters(toolId, currentValues) {
        $('#testToolParameters').html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Naƒç√≠t√°m parametry...</div>');
        
        $.ajax({
            url: '/api/tools/' + toolId + '/parameters',
            method: 'GET',
            success: function(parameters) {
                renderTestToolParameters(parameters, currentValues);
            },
            error: function() {
                $('#testToolParameters').html('<div class="alert alert-warning">Nepoda≈ôilo se naƒç√≠st parametry n√°stroje</div>');
            }
        });
    }
    
    // Render parameters for testing
    function renderTestToolParameters(parameters, currentValues) {
        if (!parameters || parameters.length === 0) {
            $('#testToolParameters').html('<div class="text-muted">Tento n√°stroj nem√° ≈æ√°dn√© parametry</div>');
            return;
        }
        
        let html = '';
        parameters.forEach(param => {
            // Use current value if available
            if (currentValues && currentValues[param.name] !== undefined) {
                param.defaultValue = currentValues[param.name];
            }
            html += renderParameter(param, 'test_');
        });
        
        $('#testToolParameters').html(html);
    }
    
    // Run tool test
    function runToolTest() {
        const nodeId = $('#editingNodeId').val();
        const node = nodes[nodeId];
        
        if (!node || !node.tool) {
            toastr.error('N√°stroj nebyl nalezen');
            return;
        }
        
        // Collect parameters
        const parameters = {};
        $('#testToolParameters [data-param]').each(function() {
            const paramName = $(this).data('param');
            let value;
            
            if ($(this).attr('type') === 'checkbox') {
                value = $(this).is(':checked');
            } else if ($(this).attr('type') === 'number') {
                value = parseFloat($(this).val()) || 0;
            } else if ($(this).hasClass('json-input')) {
                try {
                    value = JSON.parse($(this).val() || '{}');
                } catch (e) {
                    value = $(this).val();
                }
            } else {
                value = $(this).val();
            }
            
            parameters[paramName] = value;
        });
        
        // Show progress
        $('#testSetup').hide();
        $('#testProgress').show();
        $('#testResults').hide();
        $('#runTestBtn').prop('disabled', true);
        
        const startTime = Date.now();
        
        // Execute tool
        $.ajax({
            url: '/api/tools/' + node.tool + '/execute',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(parameters),
            success: function(response) {
                const duration = Date.now() - startTime;
                showTestResults(response, duration, true);
            },
            error: function(xhr) {
                const duration = Date.now() - startTime;
                let errorMessage = 'Chyba p≈ôi spu≈°tƒõn√≠ n√°stroje';
                let errorDetails = '';
                
                try {
                    const errorResponse = JSON.parse(xhr.responseText);
                    if (errorResponse.message) {
                        errorMessage = errorResponse.message;
                    }
                    if (errorResponse.errors && errorResponse.errors.length > 0) {
                        errorDetails = errorResponse.errors.join('\n');
                    } else if (errorResponse.error) {
                        errorDetails = errorResponse.error;
                    }
                } catch (e) {
                    errorDetails = xhr.responseText || xhr.statusText;
                }
                
                showTestResults({
                    success: false,
                    message: errorMessage,
                    error: errorDetails
                }, duration, false);
            },
            complete: function() {
                $('#runTestBtn').prop('disabled', false);
            }
        });
    }
    
    // Show test results
    function showTestResults(response, duration, success) {
        $('#testProgress').hide();
        $('#testResults').show();
        
        // Update alert
        const $alert = $('#testResultAlert');
        $alert.removeClass('alert-success alert-danger');
        $alert.addClass(success ? 'alert-success' : 'alert-danger');
        $alert.html(`<i class="fas fa-${success ? 'check-circle' : 'exclamation-circle'}"></i> ${response.message || (success ? 'Test dokonƒçen √∫spƒõ≈°nƒõ' : 'Test selhal')}`);
        
        // Update output
        if (response.data) {
            $('#testOutput').text(typeof response.data === 'string' ? response.data : JSON.stringify(response.data, null, 2));
        } else {
            $('#testOutput').text('≈Ω√°dn√Ω v√Ωstup');
        }
        
        // Update details
        $('#testDuration').text((duration / 1000).toFixed(2) + ' s');
        $('#testStatus').html(success ? '<span class="badge badge-success">√öspƒõch</span>' : '<span class="badge badge-danger">Chyba</span>');
        $('#testOutputType').text(response.data ? typeof response.data : 'null');
        
        // Show error if any
        if (!success && (response.error || response.errors)) {
            $('#testError').show();
            $('#testErrorDetails').text(response.error || (response.errors ? response.errors.join('\n') : 'Nezn√°m√° chyba'));
        } else {
            $('#testError').hide();
        }
    }
    
    // Modify nodeToolSelect change handler to show/hide test button
    $(document).on('change', '#nodeToolSelect', function() {
        const selectedTool = $(this).val();
        if (selectedTool) {
            $('#testToolBtn').show();
        } else {
            $('#testToolBtn').hide();
        }
    });
</script>
}