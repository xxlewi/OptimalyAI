@model OAI.Core.DTOs.CreateProjectDto
@{
    ViewData["Title"] = "Vytvo≈ôit projekt";
    var workflowTypes = ViewBag.WorkflowTypes as IEnumerable<OAI.Core.DTOs.WorkflowTypeDto> ?? new List<OAI.Core.DTOs.WorkflowTypeDto>();
    var customers = ViewBag.Customers as IEnumerable<OAI.Core.DTOs.Customers.CustomerListDto> ?? new List<OAI.Core.DTOs.Customers.CustomerListDto>();
}

<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>
                    <i class="fas fa-plus-circle"></i> Vytvo≈ôit projekt
                </h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="@Url.Action("Index")">Projekty</a></li>
                    <li class="breadcrumb-item active">Vytvo≈ôit</li>
                </ol>
            </div>
        </div>
    </div>
</section>

<section class="content">
    <div class="container-fluid">
        <form asp-action="Create" method="post" id="createProjectForm">
            <div class="row">
                <!-- Main form -->
                <div class="col-lg-8">
                    <div class="card card-primary">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-info-circle"></i> Z√°kladn√≠ informace
                            </h3>
                        </div>
                        
                        <div class="card-body">
                            @if (ViewData.ModelState.ErrorCount > 0)
                            {
                                <div class="alert alert-danger">
                                    <h5><i class="icon fas fa-ban"></i> Chyby validace:</h5>
                                    @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                                    {
                                        <p>@error.ErrorMessage</p>
                                    }
                                </div>
                            }
                            
                            <!-- Project Name & Type -->
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="form-group">
                                        <label asp-for="Name">N√°zev projektu <span class="text-danger">*</span></label>
                                        <input asp-for="Name" class="form-control form-control-lg" placeholder="nap≈ô. E-commerce vyhled√°vaƒç" autofocus>
                                        <span asp-validation-for="Name" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label asp-for="WorkflowType">Typ workflow <span class="text-danger">*</span></label>
                                        <select asp-for="WorkflowType" class="form-control">
                                            <option value="">-- Vyberte --</option>
                                            @foreach (var type in workflowTypes)
                                            {
                                                <option value="@type.Value" data-icon="@type.Icon" data-description="@type.Description">
                                                    @type.Name
                                                </option>
                                            }
                                        </select>
                                        <span asp-validation-for="WorkflowType" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Description -->
                            <div class="form-group">
                                <label asp-for="Description">Popis projektu</label>
                                <textarea asp-for="Description" class="form-control" rows="2" 
                                          placeholder="Struƒçn√Ω popis √∫ƒçelu a c√≠le projektu..."></textarea>
                                <span asp-validation-for="Description" class="text-danger"></span>
                            </div>
                            
                            <!-- Customer Selection -->
                            <div class="card card-outline card-info">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="fas fa-user"></i> Z√°kazn√≠k
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label>Vyberte z√°kazn√≠ka</label>
                                        <select asp-for="CustomerId" class="form-control select2" id="customerSelect">
                                            <option value="">-- Vyberte mo≈ænost --</option>
                                            <option value="" data-internal="true">üè¢ Intern√≠ projekt (bez z√°kazn√≠ka)</option>
                                            <option value="new">‚ûï Nov√Ω z√°kazn√≠k (vypl≈àte √∫daje n√≠≈æe)</option>
                                            <optgroup label="Existuj√≠c√≠ z√°kazn√≠ci">
                                                @foreach (var customer in customers)
                                                {
                                                    <option value="@customer.Id" 
                                                            data-name="@customer.Name" 
                                                            data-company="@customer.CompanyName">
                                                        @customer.Name
                                                        @if (!string.IsNullOrEmpty(customer.CompanyName))
                                                        {
                                                            <text> (@customer.CompanyName)</text>
                                                        }
                                                    </option>
                                                }
                                            </optgroup>
                                        </select>
                                    </div>
                                    
                                    <div id="customerDetails">
                                        <div class="form-group">
                                            <label asp-for="CustomerName">Jm√©no z√°kazn√≠ka</label>
                                            <input asp-for="CustomerName" class="form-control" placeholder="Jan Nov√°k">
                                            <span asp-validation-for="CustomerName" class="text-danger"></span>
                                        </div>
                                        <input asp-for="CustomerEmail" type="hidden" />
                                    </div>
                                    
                                    <div class="alert alert-info" id="customerAlert" style="display: none;">
                                        <i class="fas fa-info-circle"></i> √ödaje z√°kazn√≠ka byly automaticky vyplnƒõny.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sidebar with actions -->
                <div class="col-lg-4">
                    <!-- Actions -->
                    <div class="card">
                        <div class="card-body">
                            <button type="submit" class="btn btn-primary btn-lg btn-block mb-2">
                                <i class="fas fa-plus-circle"></i> Vytvo≈ôit projekt
                            </button>
                            <a href="@Url.Action("Index")" class="btn btn-outline-secondary btn-block">
                                <i class="fas fa-times"></i> Zru≈°it
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>

@section Styles {
    <link rel="stylesheet" href="~/plugins/select2/css/select2.min.css">
    <link rel="stylesheet" href="~/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css">
}

@section Scripts {
    <script src="~/plugins/select2/js/select2.full.min.js"></script>
    <script>
        $(document).ready(function() {
            // Initialize Select2
            $('.select2').select2({
                theme: 'bootstrap4',
                placeholder: '-- Vyberte z√°kazn√≠ka --',
                allowClear: true
            });
            
            // Handle customer selection
            $('#customerSelect').on('change', function() {
                const selectedOption = $(this).find('option:selected');
                const selectedValue = $(this).val();
                
                if (selectedOption.data('internal') === true) {
                    // Internal project - hide customer details
                    $('#customerDetails').slideUp();
                    $('#customerAlert').html('<i class="fas fa-info-circle"></i> Intern√≠ projekt - bez z√°kazn√≠ka').slideDown();
                    $('#CustomerName').val('Intern√≠ projekt');
                    $('#CustomerEmail').val('');
                    // Clear the CustomerId by setting a hidden field
                    $('<input>').attr({
                        type: 'hidden',
                        name: 'InternalProject',
                        value: 'true'
                    }).appendTo('#createProjectForm');
                } else if (selectedValue === 'new') {
                    // New customer - will be created automatically
                    $('#customerDetails').slideDown();
                    $('#CustomerName').val('').prop('readonly', false);
                    $('#CustomerEmail').val('');
                    // Don't send 'new' as CustomerId - it should be null
                    $(this).val(''); // Clear the select to send null CustomerId
                    $('#customerDetails').removeClass('bg-light');
                    $('#customerAlert').html('<i class="fas fa-info-circle"></i> Nov√Ω z√°kazn√≠k bude automaticky vytvo≈ôen p≈ôi zalo≈æen√≠ projektu.').slideDown();
                    $('input[name="InternalProject"]').remove();
                } else if (selectedValue === '') {
                    // Nothing selected
                    $('#customerDetails').slideUp();
                    $('#customerAlert').slideUp();
                    $('input[name="InternalProject"]').remove();
                } else {
                    // Existing customer selected
                    const name = selectedOption.data('name');
                    
                    $('#customerDetails').slideDown();
                    $('#CustomerName').val(name).prop('readonly', true);
                    $('#CustomerEmail').val('');
                    $('#customerDetails').addClass('bg-light');
                    $('#customerAlert').html('<i class="fas fa-info-circle"></i> √ödaje z√°kazn√≠ka byly automaticky vyplnƒõny.').slideDown();
                    $('input[name="InternalProject"]').remove();
                }
            });
            
            // Show workflow type description
            $('#WorkflowType').on('change', function() {
                const selectedOption = $(this).find('option:selected');
                const description = selectedOption.data('description');
                
                if (description && $(this).val()) {
                    if (!$('#workflowDescription').length) {
                        $(this).after('<small id="workflowDescription" class="form-text text-muted"></small>');
                    }
                    $('#workflowDescription').text(description).fadeIn();
                } else {
                    $('#workflowDescription').fadeOut();
                }
            });
            
            // Focus on name field
            $('#Name').focus();
        });
    </script>
}