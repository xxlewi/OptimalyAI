@model OAI.Core.DTOs.Projects.CreateProjectStageDto

<div class="modal fade" id="createStageModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <form id="createStageForm">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-plus-circle"></i> Přidat nový krok workflow
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="projectId" value="@Model.ProjectId" />
                    
                    <!-- Quick Templates -->
                    <div class="alert alert-light border mb-4" style="background-color: #f8f9fa; border-color: #dee2e6;">
                        <h6 class="alert-heading text-dark mb-3">
                            <i class="fas fa-magic text-success"></i> Rychlé šablony kroku
                        </h6>
                        <p class="mb-3 text-muted">Vyberte šablonu pro rychlé vyplnění formuláře:</p>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-success" onclick="fillStageTemplate('search')">
                                <i class="fas fa-search"></i> Vyhledávání
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="fillStageTemplate('analysis')">
                                <i class="fas fa-chart-line"></i> Analýza
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="fillStageTemplate('processing')">
                                <i class="fas fa-cogs"></i> Zpracování
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="fillStageTemplate('export')">
                                <i class="fas fa-file-export"></i> Export
                            </button>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label>
                                    Název kroku <span class="text-danger">*</span>
                                    <i class="fas fa-info-circle text-primary" data-toggle="tooltip" 
                                       title="Krátký výstižný název popisující, co tento krok dělá. Bude viditelný ve flow diagramu."
                                       data-placement="top"></i>
                                </label>
                                <input type="text" class="form-control form-control-lg" id="stageName" required 
                                       placeholder="např. 'Analýza vstupních fotek zákazníka'" />
                                <small class="form-text text-muted">
                                    <i class="fas fa-lightbulb"></i> Tip: Použijte akční sloveso - "Analyzuj", "Vyhledej", "Filtruj"
                                </small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>
                                    Typ kroku
                                    <i class="fas fa-question-circle text-info" data-toggle="tooltip" 
                                       title="Kategorie kroku - pomáhá při organizaci workflow a automatickém návrhu nástrojů"
                                       data-placement="top"></i>
                                </label>
                                <select class="form-control form-control-lg" id="stageType" onchange="updateStageTypeHelp()">
                                    @foreach (var type in ViewBag.Components["stageTypes"])
                                    {
                                        <option value="@type">@type</option>
                                    }
                                </select>
                                <div class="alert alert-light mt-2 p-2" id="stageTypeHelp" style="display: none;">
                                    <small><i class="fas fa-tag"></i> Vyberte typ kroku</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            Popis kroku
                            <i class="fas fa-info-circle text-secondary" data-toggle="tooltip" 
                               title="Detailní popis toho, co krok dělá, jaké má vstupy a výstupy"
                               data-placement="top"></i>
                        </label>
                        <textarea class="form-control" id="stageDescription" rows="2" 
                                  placeholder="např. 'Analyzuje zákaznické fotky pomocí AI pro extrakci barev, stylu a kategorie produktů. Výstup: JSON s vlastnostmi produktu'"></textarea>
                        <small class="form-text text-muted">
                            <i class="fas fa-lightbulb"></i> Tip: Popište vstupy, proces a výstupy kroku
                        </small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>
                                    Orchestrátor <span class="text-danger">*</span>
                                    <i class="fas fa-info-circle text-primary" data-toggle="tooltip" 
                                       title="Orchestrátor řídí celý krok - jak se spouští nástroje a zpracovávají data"
                                       data-placement="top"></i>
                                </label>
                                <select class="form-control form-control-lg" id="orchestratorType" required onchange="updateOrchestratorHelp()">
                                    <option value="">-- Vyberte orchestrátor --</option>
                                    @foreach (var orchestrator in ViewBag.Components["orchestrators"])
                                    {
                                        <option value="@orchestrator">@orchestrator</option>
                                    }
                                </select>
                                <div class="alert alert-info mt-2 p-2" id="orchestratorHelp">
                                    <small><i class="fas fa-lightbulb"></i> Vyberte orchestrátor pro řízení tohoto kroku</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>
                                    ReAct Agent 
                                    <span class="badge badge-secondary">Volitelné</span>
                                    <i class="fas fa-question-circle text-info" data-toggle="tooltip" 
                                       title="ReAct = Reasoning + Acting. Agent 'myslí' před každou akcí - vhodné pro složité rozhodování"
                                       data-placement="top"></i>
                                </label>
                                <select class="form-control form-control-lg" id="reactAgentType" onchange="updateReactAgentHelp()">
                                    <option value="">-- Žádný agent --</option>
                                    @foreach (var agent in ViewBag.Components["reactAgents"])
                                    {
                                        <option value="@agent">@agent</option>
                                    }
                                </select>
                                <div class="alert alert-warning mt-2 p-2" id="reactAgentHelp" style="display: none;">
                                    <small><i class="fas fa-brain"></i> ReAct agent přidá "myšlení" do procesu</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            Strategie vykonávání nástrojů
                            <i class="fas fa-question-circle text-success" data-toggle="tooltip" 
                               title="Jak se budou spouštět nástroje v tomto kroku - postupně, současně nebo podle podmínek"
                               data-placement="top"></i>
                        </label>
                        <div class="btn-group btn-group-toggle d-flex" data-toggle="buttons">
                            @foreach (var strategy in ViewBag.Components["executionStrategies"])
                            {
                                var isChecked = strategy == "Sequential";
                                var icon = strategy switch {
                                    "Sequential" => "fas fa-arrow-right",
                                    "Parallel" => "fas fa-random",
                                    "Conditional" => "fas fa-code-branch",
                                    _ => "fas fa-cog"
                                };
                                var description = strategy switch {
                                    "Sequential" => "Postupně jeden za druhým",
                                    "Parallel" => "Všechny současně",
                                    "Conditional" => "Podle podmínek",
                                    _ => strategy
                                };
                                var tooltip = strategy switch {
                                    "Sequential" => "Nástroje se spustí jeden po druhém - výstup z prvního je vstup do druhého",
                                    "Parallel" => "Všechny nástroje se spustí současně - rychlejší, ale nezávislé",
                                    "Conditional" => "Nástroje se spustí podle podmínek - pokročilé rozhodování",
                                    _ => strategy
                                };
                                
                                <label class="btn btn-outline-secondary @(isChecked ? "active" : "")" style="flex: 1" 
                                       data-toggle="tooltip" title="@tooltip" data-placement="top">
                                    <input type="radio" name="executionStrategy" value="@strategy" @(isChecked ? "checked" : "")>
                                    <i class="@icon"></i> @strategy
                                    <br>
                                    <small>@description</small>
                                </label>
                            }
                        </div>
                        <div class="alert alert-info mt-2 p-2">
                            <small>
                                <i class="fas fa-info-circle"></i> 
                                <strong>Sequential:</strong> Pro e-commerce - analýza → vyhledávání → filtrování<br>
                                <strong>Parallel:</strong> Pro rychlost - vyhledávání na více platformách současně<br>
                                <strong>Conditional:</strong> Pro složité scénáře - podle typu produktu různé nástroje
                            </small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            Nástroje pro tento krok
                            <i class="fas fa-question-circle text-warning" data-toggle="tooltip" 
                               title="Nástroje jsou konkrétní funkce - např. analýza obrázků, vyhledávání produktů, export dat. Orchestrátor je používá k vykonání úkolů."
                               data-placement="top"></i>
                        </label>
                        <div class="card">
                            <div class="card-body">
                                <div class="alert alert-light border mb-3" style="background-color: #f8f9fa;">
                                    <h6 class="mb-2"><i class="fas fa-info-circle text-primary"></i> Jak nástroje fungují:</h6>
                                    <ul class="mb-0 small">
                                        <li><strong>image_analyzer</strong> - Analyzuje fotky a extrahuje vlastnosti produktů</li>
                                        <li><strong>web_search</strong> - Vyhledává produkty na internetu</li>
                                        <li><strong>aliexpress_search</strong> - Specializované vyhledávání na Aliexpress</li>
                                        <li><strong>excel_exporter</strong> - Exportuje výsledky do Excel souboru</li>
                                        <li><strong>data_analyzer</strong> - Analyzuje a filtruje data</li>
                                    </ul>
                                </div>
                                <div class="alert alert-light border mb-3" style="background-color: #f8f9fa; border-color: #28a745;">
                                    <h6 class="text-success mb-2">
                                        <i class="fas fa-lightbulb"></i> Pro váš e-commerce workflow:
                                    </h6>
                                    <div class="text-dark">
                                        <strong>Analýza:</strong> <code class="bg-light text-dark px-2 py-1">image_analyzer</code> → 
                                        <strong>Vyhledávání:</strong> <code class="bg-light text-dark px-2 py-1">aliexpress_search + web_search</code> → 
                                        <strong>Export:</strong> <code class="bg-light text-dark px-2 py-1">excel_exporter</code>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Doporučené pro vybraný typ:</h6>
                                        <div id="suggestedTools" class="mb-2">
                                            <span class="badge badge-light mr-1 mb-1">Vyberte typ kroku</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Všechny dostupné nástroje:</h6>
                                        <div style="max-height: 150px; overflow-y: auto;">
                                            @foreach (var tool in ViewBag.Components["tools"])
                                            {
                                                <span class="badge badge-secondary mr-1 mb-1" 
                                                      data-toggle="tooltip" 
                                                      title="Klikněte pro více informací o nástroji @tool"
                                                      data-placement="top">@tool</span>
                                            }
                                        </div>
                                        <small class="text-muted mt-2 d-block">
                                            <i class="fas fa-info-circle"></i> Nástroje přidáte po vytvoření kroku pomocí drag & drop
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced Configuration (Collapsible) -->
                    <div class="mt-4">
                        <a class="btn btn-link" data-toggle="collapse" href="#advancedConfig" role="button">
                            <i class="fas fa-cog"></i> Pokročilá konfigurace
                            <i class="fas fa-info-circle text-muted ml-1" data-toggle="tooltip" 
                               title="Volitelné nastavení pro pokročilé uživatele - není nutné vyplňovat"
                               data-placement="top"></i>
                        </a>
                        <div class="collapse" id="advancedConfig">
                            <div class="card card-body">
                                <div class="alert alert-warning mb-3">
                                    <i class="fas fa-exclamation-triangle"></i> <strong>Upozornění:</strong> 
                                    Tato sekce je určena pro pokročilé uživatele. Nesprávná konfigurace může způsobit chyby workflow.
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>
                                                Konfigurace orchestrátoru (JSON)
                                                <i class="fas fa-question-circle text-info" data-toggle="tooltip" 
                                                   title="JSON objekt s parametry pro orchestrátor - např. timeout, retry, specific settings"
                                                   data-placement="top"></i>
                                            </label>
                                            <textarea class="form-control font-monospace" id="orchestratorConfig" rows="4" 
                                                      placeholder='{\n  "timeout": 300,\n  "retryCount": 3\n}'>{}</textarea>
                                            <small class="form-text text-muted">
                                                <i class="fas fa-lightbulb"></i> Příklad: timeout, retry nastavení, specifické parametry
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>
                                                Konfigurace ReAct agenta (JSON)
                                                <i class="fas fa-question-circle text-info" data-toggle="tooltip" 
                                                   title="JSON objekt s parametry pro ReAct agenta - např. model, temperature, max_tokens"
                                                   data-placement="top"></i>
                                            </label>
                                            <textarea class="form-control font-monospace" id="reactAgentConfig" rows="4"
                                                      placeholder='{\n  "model": "llama3.1",\n  "temperature": 0.7\n}'>{}</textarea>
                                            <small class="form-text text-muted">
                                                <i class="fas fa-lightbulb"></i> Příklad: AI model, creativita (temperature), délka odpovědi
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i> Zrušit
                    </button>
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-plus-circle"></i> Vytvořit krok
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Initialize tooltips
    $('[data-toggle="tooltip"]').tooltip();
    
    // Initialize help functions
    updateStageTypeHelp();
    updateOrchestratorHelp();
    
    // Stage template filling
    function fillStageTemplate(templateType) {
        const templates = {
            'search': {
                name: 'Vyhledávání produktů',
                description: 'Vyhledávání podobných produktů na základě vstupních dat',
                type: 'Search',
                orchestrator: 'ToolChainOrchestrator',
                strategy: 'Parallel',
                tools: ['web_search', 'aliexpress_search']
            },
            'analysis': {
                name: 'Analýza dat',
                description: 'Komplexní analýza vstupních dat s využitím AI',
                type: 'Analysis',
                orchestrator: 'ConversationOrchestrator',
                reactAgent: 'ConversationReActAgent',
                strategy: 'Sequential',
                tools: ['image_analyzer', 'data_analyzer']
            },
            'processing': {
                name: 'Zpracování výsledků',
                description: 'Filtrování, třídění a hodnocení výsledků',
                type: 'Processing',
                orchestrator: 'ConversationOrchestrator',
                strategy: 'Sequential',
                tools: ['product_filter', 'similarity_scorer']
            },
            'export': {
                name: 'Export dat',
                description: 'Export zpracovaných dat do požadovaného formátu',
                type: 'Export',
                orchestrator: 'ToolChainOrchestrator',
                strategy: 'Sequential',
                tools: ['excel_exporter', 'database_saver']
            }
        };
        
        const template = templates[templateType];
        if (template) {
            $('#stageName').val(template.name);
            $('#stageDescription').val(template.description);
            $('#stageType').val(template.type);
            $('#orchestratorType').val(template.orchestrator).trigger('change');
            if (template.reactAgent) {
                $('#reactAgentType').val(template.reactAgent);
            }
            // Reset all strategy buttons first
            $('input[name="executionStrategy"]').prop('checked', false).parent().removeClass('active');
            // Set the correct one
            $(`input[name="executionStrategy"][value="${template.strategy}"]`).prop('checked', true).parent().addClass('active');
            
            // Update suggested tools
            updateSuggestedTools(template.tools);
        }
    }
    
    function updateSuggestedTools(tools) {
        const container = $('#suggestedTools');
        container.empty();
        if (tools && tools.length > 0) {
            tools.forEach(tool => {
                container.append(`<span class="badge badge-success mr-1 mb-1">${tool}</span>`);
            });
        } else {
            container.append('<span class="badge badge-light mr-1 mb-1">Žádné specifické doporučení</span>');
        }
    }
    
    function updateStageTypeHelp() {
        const stageType = $('#stageType').val();
        const helpDiv = $('#stageTypeHelp');
        
        const typeData = {
            'Analysis': {
                text: 'Analýza a zpracování dat',
                tools: ['image_analyzer', 'data_analyzer'],
                example: 'Analýza zákaznických fotek pro extrakci vlastností produktů'
            },
            'Search': {
                text: 'Vyhledávání a získávání dat',
                tools: ['web_search', 'aliexpress_search', 'alibaba_search'],
                example: 'Vyhledávání podobných produktů na e-commerce platformách'
            },
            'Processing': {
                text: 'Zpracování a filtrování výsledků',
                tools: ['data_analyzer', 'product_filter', 'similarity_scorer'],
                example: 'Filtrování produktů podle ceny, hodnocení a podobnosti'
            },
            'Export': {
                text: 'Export a uložení výsledků',
                tools: ['excel_exporter', 'database_saver', 'report_generator'],
                example: 'Vytvoření Excel reportu s nejlepšími produkty'
            },
            'Custom': {
                text: 'Vlastní specifický úkol',
                tools: [],
                example: 'Specifický úkol podle vašich potřeb'
            }
        };
        
        if (typeData[stageType]) {
            const data = typeData[stageType];
            helpDiv.html(`
                <small>
                    <i class="fas fa-tag"></i> <strong>${data.text}</strong><br>
                    <span class="text-success"><i class="fas fa-example"></i> ${data.example}</span>
                </small>
            `).show();
            
            // Update suggested tools
            updateSuggestedTools(data.tools);
        } else {
            helpDiv.hide();
            updateSuggestedTools([]);
        }
    }
    
    function updateOrchestratorHelp() {
        const orchestrator = $('#orchestratorType').val();
        const helpDiv = $('#orchestratorHelp');
        
        const helpData = {
            'ConversationOrchestrator': {
                text: 'Ideální pro kroky vyžadující AI reasoning a analýzu',
                detail: 'Umí komunikovat s AI modely, rozhodovat se a analyzovat data. Používá se pro složité úkoly jako je rozpoznávání obrázků nebo analýza textů.',
                useCase: 'Pro váš příklad: Analýza fotek produktů a extrakce jejich vlastností'
            },
            'ToolChainOrchestrator': {
                text: 'Nejlepší pro sekvenční nebo paralelní spouštění nástrojů',
                detail: 'Rychle spouští nástroje v definovaném pořadí nebo současně. Nepoužívá AI reasoning.',
                useCase: 'Pro váš příklad: Současné vyhledávání na více e-shop platformách'
            },
            'CustomOrchestrator': {
                text: 'Pro specifické úlohy s vlastní logikou',
                detail: 'Umožňuje vytvořit vlastní logiku řízení workflow s podmínkami a vlastními algoritmy.',
                useCase: 'Pro váš příklad: Komplexní filtrování produktů podle vlastních kritérií'
            }
        };
        
        if (helpData[orchestrator]) {
            const data = helpData[orchestrator];
            helpDiv.html(`
                <small>
                    <i class="fas fa-lightbulb"></i> <strong>${data.text}</strong><br>
                    ${data.detail}<br>
                    <span class="text-success"><i class="fas fa-shopping-cart"></i> ${data.useCase}</span>
                </small>
            `).show();
        } else {
            helpDiv.html('<small><i class="fas fa-lightbulb"></i> Vyberte orchestrátor pro řízení tohoto kroku</small>').show();
        }
    }
    
    function updateReactAgentHelp() {
        const agent = $('#reactAgentType').val();
        const helpDiv = $('#reactAgentHelp');
        
        if (!agent) {
            helpDiv.hide();
            return;
        }
        
        const helpData = {
            'ConversationReActAgent': {
                text: 'Agent pro konverzační AI a rozhodování',
                detail: 'Myslí před každou akcí, umí se rozhodovat na základě kontextu.',
                useCase: 'Pro váš příklad: Rozhoduje, které vlastnosti produktu jsou nejdůležitější'
            },
            'AnalysisReActAgent': {
                text: 'Specializovaný agent pro analýzu dat',
                detail: 'Provádí hlubokou analýzu a hodnocení dat s logickým uvažováním.',
                useCase: 'Pro váš příklad: Hodnotí podobnost nalezených produktů se vstupní fotkou'
            }
        };
        
        if (helpData[agent]) {
            const data = helpData[agent];
            helpDiv.html(`
                <small>
                    <i class="fas fa-brain"></i> <strong>${data.text}</strong><br>
                    ${data.detail}<br>
                    <span class="text-success"><i class="fas fa-shopping-cart"></i> ${data.useCase}</span>
                </small>
            `).show();
        } else {
            helpDiv.html('<small><i class="fas fa-brain"></i> Agent přidá "myšlení" do procesu</small>').show();
        }
    }
    
    $('#createStageForm').on('submit', function(e) {
        e.preventDefault();
        
        const stageData = {
            projectId: $('#projectId').val(),
            name: $('#stageName').val(),
            description: $('#stageDescription').val(),
            type: $('#stageType').val(),
            orchestratorType: $('#orchestratorType').val(),
            orchestratorConfiguration: $('#orchestratorConfig').val(),
            reactAgentType: $('#reactAgentType').val() || null,
            reactAgentConfiguration: $('#reactAgentConfig').val(),
            executionStrategy: $('input[name="executionStrategy"]:checked').val() || 'Sequential',
            tools: []
        };
        
        // Show loading state
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Vytvářím...');
        
        $.ajax({
            url: '/api/workflow/stages',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(stageData),
            success: function(response) {
                toastr.success('Krok byl úspěšně vytvořen');
                $('#createStageModal').modal('hide');
                
                // Refresh workflow designer
                if (window.workflowDesigner) {
                    window.workflowDesigner.loadWorkflow();
                } else {
                    location.reload();
                }
            },
            error: function(xhr) {
                const error = xhr.responseJSON;
                if (error && error.errors) {
                    const messages = Object.values(error.errors).flat().join('<br>');
                    toastr.error(messages);
                } else {
                    toastr.error('Chyba při vytváření kroku');
                }
            },
            complete: function() {
                submitBtn.prop('disabled', false).html(originalText);
            }
        });
    });
</script>