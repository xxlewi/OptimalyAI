@model OptimalyAI.ViewModels.ProjectViewModel
@{
    ViewData["Title"] = $"Projekt: {Model.Name}";
}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">@Model.Name</h3>
                <div class="card-tools">
                    <a href="/WorkflowDesigner?projectId=@Model.Id" class="btn btn-primary btn-sm mr-2">
                        <i class="fas fa-project-diagram"></i> Workflow Designer
                    </a>
                    <button type="button" class="btn btn-success btn-sm mr-2" data-toggle="modal" data-target="#executeWorkflowModal">
                        <i class="fas fa-play"></i> Spustit Workflow
                    </button>
                    <button type="button" class="btn btn-info btn-sm mr-2" onclick="window.location.href='/ProjectWorkflows/Monitor?projectId=@Model.Id'">
                        <i class="fas fa-chart-line"></i> Monitor
                    </button>
                    <span class="badge badge-@(Model.Status switch { 
                        ProjectStatus.Active => "success",
                        ProjectStatus.Failed => "danger",
                        ProjectStatus.Paused => "warning",
                        ProjectStatus.Completed => "info",
                        _ => "secondary"
                    })">@Model.Status</span>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h5>Popis projektu</h5>
                        <p>@Model.Description</p>
                        
                        <h5 class="mt-4">Workflow kroky</h5>
                        <div class="timeline">
                            @foreach (var step in Model.Workflow.OrderBy(s => s.Order))
                            {
                                <div>
                                    <i class="fas fa-@(step.Status == "completed" ? "check-circle text-success" : "circle") bg-gray"></i>
                                    <div class="timeline-item">
                                        <h3 class="timeline-header">@step.Name</h3>
                                        <div class="timeline-body">
                                            @step.Description
                                            <br />
                                            <small class="text-muted">Tool: @step.ToolId</small>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                        
                        <h5 class="mt-4">Konfigurace</h5>
                        <dl class="row">
                            <dt class="col-sm-3">Zdroje:</dt>
                            <dd class="col-sm-9">
                                @foreach (var source in Model.Configuration.Sources)
                                {
                                    <span class="badge badge-info">@source</span>
                                }
                            </dd>
                            
                            <dt class="col-sm-3">Klíčová slova:</dt>
                            <dd class="col-sm-9">
                                @foreach (var keyword in Model.Configuration.Keywords)
                                {
                                    <span class="badge badge-primary">@keyword</span>
                                }
                            </dd>
                            
                            <dt class="col-sm-3">CRM integrace:</dt>
                            <dd class="col-sm-9">@(string.IsNullOrEmpty(Model.Configuration.CrmIntegration) ? "Není nastavena" : Model.Configuration.CrmIntegration)</dd>
                            
                            <dt class="col-sm-3">Notifikační email:</dt>
                            <dd class="col-sm-9">@(string.IsNullOrEmpty(Model.Configuration.NotificationEmail) ? "Není nastaven" : Model.Configuration.NotificationEmail)</dd>
                        </dl>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="info-box">
                            <span class="info-box-icon bg-info"><i class="fas fa-clock"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Plánování</span>
                                <span class="info-box-number">@Model.Schedule</span>
                            </div>
                        </div>
                        
                        <div class="info-box">
                            <span class="info-box-icon bg-success"><i class="fas fa-check-circle"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Úspěšnost</span>
                                <span class="info-box-number">@Model.Metrics.SuccessRate.ToString("F1")%</span>
                                <div class="progress">
                                    <div class="progress-bar bg-success" style="width: @Model.Metrics.SuccessRate%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-box">
                            <span class="info-box-icon bg-warning"><i class="fas fa-tasks"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Zpracováno položek</span>
                                <span class="info-box-number">@Model.Metrics.ItemsProcessed</span>
                                <span class="progress-description">
                                    Shoda: @Model.Metrics.ItemsMatched položek
                                </span>
                            </div>
                        </div>
                        
                        <div class="info-box">
                            <span class="info-box-icon bg-primary"><i class="fas fa-hourglass-half"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Průměrný čas běhu</span>
                                <span class="info-box-number">@Model.Metrics.AverageRunTime.TotalMinutes.ToString("F1") min</span>
                            </div>
                        </div>
                        
                        @if (Model.LastRun.HasValue)
                        {
                            <div class="info-box">
                                <span class="info-box-icon bg-secondary"><i class="fas fa-history"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Poslední běh</span>
                                    <span class="info-box-number">@Model.LastRun.Value.ToString("dd.MM.yyyy HH:mm")</span>
                                </div>
                            </div>
                        }
                        
                        @if (Model.NextRun.HasValue)
                        {
                            <div class="info-box">
                                <span class="info-box-icon bg-info"><i class="fas fa-calendar-alt"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Další běh</span>
                                    <span class="info-box-number">@Model.NextRun.Value.ToString("dd.MM.yyyy HH:mm")</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary">
                    <i class="fas fa-edit"></i> Upravit
                </a>
                <a asp-action="RunNow" asp-route-id="@Model.Id" class="btn btn-success">
                    <i class="fas fa-play"></i> Spustit nyní
                </a>
                <a asp-action="Index" class="btn btn-default">
                    <i class="fas fa-arrow-left"></i> Zpět na seznam
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Execute Workflow Modal -->
<div class="modal fade" id="executeWorkflowModal" tabindex="-1" role="dialog" aria-labelledby="executeWorkflowModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="executeWorkflowModalLabel">Spustit Workflow</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="executeWorkflowForm">
                    <div class="form-group">
                        <label for="parameters">Vstupní parametry (JSON)</label>
                        <textarea class="form-control" id="parameters" name="parameters" rows="5" placeholder='{"key": "value"}'>{}</textarea>
                        <small class="form-text text-muted">Zadejte parametry ve formátu JSON</small>
                    </div>
                    <div class="form-group">
                        <label for="initiatedBy">Spuštěno kým</label>
                        <input type="text" class="form-control" id="initiatedBy" name="initiatedBy" value="@User.Identity.Name" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Zrušit</button>
                <button type="button" class="btn btn-success" onclick="executeWorkflow()">
                    <i class="fas fa-play"></i> Spustit
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function executeWorkflow() {
            const projectId = '@Model.Id';
            const parameters = document.getElementById('parameters').value;
            const initiatedBy = document.getElementById('initiatedBy').value;
            
            let parsedParams = {};
            try {
                if (parameters.trim()) {
                    parsedParams = JSON.parse(parameters);
                }
            } catch (e) {
                toastr.error('Neplatný JSON formát parametrů');
                return;
            }
            
            const data = {
                parameters: parsedParams,
                initiatedBy: initiatedBy
            };
            
            // Disable button during execution
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Spouštím...';
            
            fetch(`/api/workflow/${projectId}/execute`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.isSuccess) {
                    toastr.success('Workflow byl úspěšně spuštěn');
                    $('#executeWorkflowModal').modal('hide');
                    
                    // Redirect to monitor page
                    setTimeout(() => {
                        window.location.href = `/ProjectWorkflows/Monitor?executionId=${result.data.executionId}`;
                    }, 1500);
                } else {
                    toastr.error(result.error || 'Chyba při spouštění workflow');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-play"></i> Spustit';
                }
            })
            .catch(error => {
                toastr.error('Chyba při komunikaci se serverem');
                console.error('Error:', error);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-play"></i> Spustit';
            });
        }
    </script>
}