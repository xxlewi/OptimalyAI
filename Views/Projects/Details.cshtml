@model OAI.Core.DTOs.ProjectDto
@{
    ViewData["Title"] = $"Projekt: {Model.Name}";
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-8">
                <h1>
                    <i class="fas fa-project-diagram"></i> @Model.Name
                    <span class="badge badge-@(Model.Status switch { 
                        "Active" => "success",
                        "Failed" => "danger",
                        "Paused" => "warning",
                        "Completed" => "info",
                        "Draft" => "secondary",
                        _ => "secondary"
                    }) ml-2">
                        <i class="fas fa-@(Model.Status switch {
                            "Active" => "play-circle",
                            "Failed" => "times-circle",
                            "Paused" => "pause-circle",
                            "Completed" => "check-circle",
                            "Draft" => "pencil-alt",
                            _ => "flag"
                        })"></i> @Model.Status
                    </span>
                </h1>
                @if (!string.IsNullOrEmpty(Model.Description))
                {
                    <p class="text-muted lead">@Model.Description</p>
                }
            </div>
            <div class="col-sm-4">
                <div class="d-flex justify-content-end align-items-center">
                    <a href="@Url.Action("Index")" class="btn btn-default mr-2">
                        <i class="fas fa-arrow-left"></i> Zp캩t
                    </a>
                    
                    <!-- Status dropdown -->
                    <div class="btn-group mr-2">
                        <button type="button" id="statusDropdown" class="btn btn-outline-@(Model.Status switch { 
                            "Active" => "success",
                            "Failed" => "danger",
                            "Paused" => "warning",
                            "Completed" => "info",
                            "Draft" => "secondary",
                            _ => "secondary"
                        }) dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-@(Model.Status switch {
                                "Active" => "play-circle",
                                "Failed" => "times-circle",
                                "Paused" => "pause-circle",
                                "Completed" => "check-circle",
                                "Draft" => "pencil-alt",
                                _ => "flag"
                            })"></i> <span id="currentStatus">@(Model.Status switch {
                                "Active" => "Aktivn칤",
                                "Failed" => "Selhalo",
                                "Paused" => "Pozastaveno",
                                "Completed" => "Dokon캜eno",
                                "Draft" => "Draft",
                                _ => Model.Status
                            })</span>
                        </button>
                        <div class="dropdown-menu">
                            <a class="dropdown-item status-item @(Model.Status == "Draft" ? "active" : "")" href="#" data-status="Draft" onclick="changeProjectStatus('@Model.Id', 'Draft'); return false;">
                                <i class="fas fa-pencil-alt text-secondary"></i> Draft
                            </a>
                            <a class="dropdown-item status-item @(Model.Status == "Active" ? "active" : "")" href="#" data-status="Active" onclick="changeProjectStatus('@Model.Id', 'Active'); return false;">
                                <i class="fas fa-play-circle text-success"></i> Aktivn칤
                            </a>
                            <a class="dropdown-item status-item @(Model.Status == "Paused" ? "active" : "")" href="#" data-status="Paused" onclick="changeProjectStatus('@Model.Id', 'Paused'); return false;">
                                <i class="fas fa-pause-circle text-warning"></i> Pozastaveno
                            </a>
                            <a class="dropdown-item status-item @(Model.Status == "Completed" ? "active" : "")" href="#" data-status="Completed" onclick="changeProjectStatus('@Model.Id', 'Completed'); return false;">
                                <i class="fas fa-check-circle text-info"></i> Dokon캜eno
                            </a>
                            <a class="dropdown-item status-item @(Model.Status == "Failed" ? "active" : "")" href="#" data-status="Failed" onclick="changeProjectStatus('@Model.Id', 'Failed'); return false;">
                                <i class="fas fa-times-circle text-danger"></i> Selhalo
                            </a>
                        </div>
                    </div>
                    
                    <button class="btn btn-warning mr-2" onclick="showRunModal('test')">
                        <i class="fas fa-vial"></i> Test
                    </button>
                    <button class="btn btn-success mr-2" onclick="showRunModal('production')">
                        <i class="fas fa-play"></i> Spustit
                    </button>
                    <div class="btn-group">
                        <button type="button" class="btn btn-danger dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-trash"></i> Smazat
                        </button>
                        <div class="dropdown-menu dropdown-menu-right">
                            <a class="dropdown-item" href="#" onclick="archiveProject('@Model.Id')">
                                <i class="fas fa-archive text-warning"></i> Archivovat projekt
                            </a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item text-danger" href="#" onclick="deleteProject('@Model.Id')">
                                <i class="fas fa-trash-alt"></i> Trvale smazat
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <!-- Left column - Info cards -->
            <div class="col-md-4">
                <!-- Basic information -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-info-circle"></i> Z치kladn칤 informace</h3>
                        <div class="card-tools">
                            <a href="@Url.Action("Edit", new { id = Model.Id })" class="btn btn-warning btn-sm">
                                <i class="fas fa-edit"></i> Upravit
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-5">ID projektu:</dt>
                            <dd class="col-sm-7"><code>@Model.Id.ToString().Substring(0, 8)...</code></dd>
                            
                            <dt class="col-sm-5">Z치kazn칤k:</dt>
                            <dd class="col-sm-7">
                                @if (Model.CustomerId.HasValue && Model.CustomerId.Value != Guid.Empty)
                                {
                                    <a href="@Url.Action("Details", "Customers", new { id = Model.CustomerId.Value })" class="text-primary">
                                        <i class="fas fa-user"></i> @Model.CustomerName
                                    </a>
                                }
                                else
                                {
                                    <span>
                                        <i class="fas fa-user text-muted"></i> @Model.CustomerName
                                    </span>
                                    <!-- Debug: CustomerId = @(Model.CustomerId?.ToString() ?? "null") -->
                                }
                                @if (!string.IsNullOrEmpty(Model.CustomerEmail))
                                {
                                    <br>
                                    <small class="text-muted">
                                        <a href="mailto:@Model.CustomerEmail">@Model.CustomerEmail</a>
                                    </small>
                                }
                            </dd>
                            
                            <dt class="col-sm-5">Typ workflow:</dt>
                            <dd class="col-sm-7">
                                @switch (Model.WorkflowType)
                                {
                                    case "image_processing":
                                        <span class="badge badge-info"><i class="fa fa-image"></i> Image Processing</span>
                                        break;
                                    case "data_analysis":
                                        <span class="badge badge-primary"><i class="fa fa-chart-line"></i> Data Analysis</span>
                                        break;
                                    case "text_generation":
                                        <span class="badge badge-warning"><i class="fa fa-file-alt"></i> Text Generation</span>
                                        break;
                                    case "custom":
                                    default:
                                        <span class="badge badge-secondary"><i class="fa fa-cogs"></i> Custom</span>
                                        break;
                                }
                            </dd>
                            
                            <dt class="col-sm-5">Spou코t캩n칤:</dt>
                            <dd class="col-sm-7">
                                @switch (Model.TriggerType)
                                {
                                    case "Manual":
                                        <text><i class="fas fa-hand-pointer"></i> Manu치ln칤</text>
                                        break;
                                    case "Schedule":
                                        <span><i class="fas fa-clock"></i> Pl치novan칠</span>
                                        if (Model.NextRun.HasValue)
                                        {
                                            <br>
                                            <small>Dal코칤: @Model.NextRun.Value.ToString("dd.MM.yyyy HH:mm")</small>
                                        }
                                        break;
                                    case "Event":
                                        <text><i class="fas fa-bolt"></i> Ud치lostmi</text>
                                        break;
                                    default:
                                        <text><i class="fas fa-question"></i> @Model.TriggerType</text>
                                        break;
                                }
                            </dd>
                            
                            <dt class="col-sm-5">Po캜et etap:</dt>
                            <dd class="col-sm-7">
                                <span class="badge badge-info">@Model.StageCount</span>
                            </dd>
                            
                            @if (!string.IsNullOrEmpty(Model.Description))
                            {
                                <dt class="col-sm-12 mt-3">Popis projektu:</dt>
                                <dd class="col-sm-12">
                                    <p class="text-muted mb-0">@Model.Description</p>
                                </dd>
                            }
                        </dl>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-chart-bar"></i> Statistiky</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="description-block border-right">
                                    <h5 class="description-header">@Model.TotalRuns</h5>
                                    <span class="description-text">CELKEM B캨H콡</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="description-block">
                                    <h5 class="description-header text-@(Model.SuccessRate >= 80 ? "success" : Model.SuccessRate >= 50 ? "warning" : "danger")">
                                        @Model.SuccessRate.ToString("F0")%
                                    </h5>
                                    <span class="description-text">칔SP캨NOST</span>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="text-center">
                            <p class="text-muted">
                                @if (Model.LastRun.HasValue)
                                {
                                    <text>Posledn칤 b캩h: @Model.LastRun.Value.ToString("dd.MM.yyyy HH:mm")</text>
                                    if (Model.LastRunSuccess)
                                    {
                                        <span class="badge badge-success ml-2">칔sp캩코n칳</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-danger ml-2">Ne칰sp캩코n칳</span>
                                    }
                                }
                                else
                                {
                                    <text>Zat칤m nebylo spu코t캩no</text>
                                }
                            </p>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <!-- Right column - Workflow -->
            <div class="col-md-8">
                <!-- Workflow diagram -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-project-diagram"></i> Workflow Diagram
                        </h3>
                        <div class="card-tools">
                            <button class="btn btn-sm btn-outline-secondary" onclick="exportWorkflow()">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <a href="@Url.Action("Index", "WorkflowDesigner", new { projectId = Model.Id })" class="btn btn-sm btn-primary">
                                <i class="fas fa-edit"></i> Upravit
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Clean workflow diagram component -->
                        <div id="workflowDiagramContainer" style="height: 400px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa; overflow: hidden;">
                            <div class="text-center py-5">
                                <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                <p class="text-muted mt-2">Na캜칤t치m workflow diagram...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Workflow steps -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-tasks"></i> Workflow Steps
                        </h3>
                    </div>
                    <div class="card-body" id="workflowSteps">
                        <div class="text-center py-3">
                            <i class="fas fa-spinner fa-spin"></i> Na캜칤t치m kroky workflow...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Related Requests - Full Width -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-clipboard-list"></i> Souvisej칤c칤 po쬬davky</h3>
                        <div class="card-tools">
                            <a href="/Requests/New?projectId=@Model.Id" class="btn btn-sm btn-primary">
                                <i class="fas fa-plus"></i> Nov칳 po쬬davek
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="relatedRequests">
                            <div class="text-center py-3">
                                <i class="fas fa-spinner fa-spin"></i> Na캜칤t치m po쬬davky...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Execution history -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-history"></i> Historie spu코t캩n칤
                        </h3>
                        <div class="card-tools">
                            <button class="btn btn-sm btn-default" onclick="refreshHistory()">
                                <i class="fas fa-sync-alt"></i> Obnovit
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="executionHistoryTable">
                                <thead>
                                    <tr>
                                        <th>Zah치jeno</th>
                                        <th>Dokon캜eno</th>
                                        <th>Doba trv치n칤</th>
                                        <th>Kroky</th>
                                        <th>Status</th>
                                        <th>Spustil</th>
                                        <th>Akce</th>
                                    </tr>
                                </thead>
                                <tbody id="executionHistoryBody">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin"></i> Na캜칤t치m historii...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modals -->
<!-- Run Workflow Modal -->
<div class="modal fade" id="runWorkflowModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <span id="runModeTitle"></span>
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="runModeWarning" class="alert" style="display: none;">
                </div>
                
                <div class="form-group">
                    <label>Run Name</label>
                    <input type="text" class="form-control" id="runName" placeholder="My test run">
                </div>
                
                <div class="form-group">
                    <label>Input Parameters (JSON)</label>
                    <textarea class="form-control" id="inputParameters" rows="4" placeholder='{"key": "value"}'>{}</textarea>
                </div>
                
                <div class="card collapsed-card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-plus"></i> Advanced Options
                            </button>
                        </h5>
                    </div>
                    <div class="card-body" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Priority</label>
                                    <select class="form-control" id="runPriority">
                                        <option value="low">Low</option>
                                        <option value="normal" selected>Normal</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Test Item Limit</label>
                                    <input type="number" class="form-control" id="testItemLimit" value="10" min="1" max="100">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="debugMode">
                                <label class="custom-control-label" for="debugMode">Enable debug logging</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmRunBtn" onclick="executeWorkflow()">
                    <i class="fas fa-play"></i> Execute
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Orchestrator Settings Modal -->
<div class="modal fade" id="orchestratorModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">AI Orchestrator Settings</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Orchestrator Type</label>
                    <select class="form-control" id="orchestratorType">
                        <option value="conversation">游눫 Conversation</option>
                        <option value="tool_chain">游댕 Tool Chain</option>
                        <option value="react" selected>游 ReAct (Reasoning + Acting)</option>
                        <option value="custom">丘뙖잺 Custom</option>
                    </select>
                </div>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="form-group">
                            <label>AI Model</label>
                            <select class="form-control" id="orchestratorModel">
                                <option value="llama3.1:70b">Llama 3.1 (70B)</option>
                                <option value="mistral:latest">Mistral (7B)</option>
                                <option value="codellama:latest">Code Llama (7B)</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Temperature</label>
                            <input type="number" class="form-control" id="orchestratorTemp" value="0.7" min="0" max="2" step="0.1">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>System Prompt</label>
                    <textarea class="form-control" id="systemPrompt" rows="4">You are a helpful AI assistant that orchestrates workflow execution using the ReAct pattern (Reasoning + Acting).</textarea>
                </div>
                
                <div class="form-group">
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="useToolValidation" checked>
                        <label class="custom-control-label" for="useToolValidation">Enable tool parameter validation</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveOrchestratorSettings()">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Step Edit Modal -->
<div class="modal fade" id="stepEditModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Workflow Step</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Step edit form will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStep()">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>

@await Html.PartialAsync("_WorkflowTestModal")

<!-- Workflow Info Modal -->
<div class="modal fade" id="workflowInfoModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Workflow Information</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <pre id="workflowInfoContent" class="bg-light p-3 rounded"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        /* Ensure all buttons in the header have the same height */
        .content-header .btn {
            height: 38px;
            display: inline-flex;
            align-items: center;
            padding: 0.375rem 0.75rem;
        }
        
        /* Fix dropdown toggle height */
        .content-header .dropdown-toggle::after {
            margin-left: 0.5rem;
        }
        
        /* Ensure button groups maintain consistent height */
        .content-header .btn-group .btn {
            height: 38px;
        }
    </style>
}

@section Scripts {
    <script src="~/js/workflow-diagram-viewer.js"></script>
    <style>
        /* Styly pro ostatn칤 캜치sti str치nky */
        .description-block {
            text-align: center;
            padding: 10px 0;
        }
        
        .description-header {
            margin: 5px 0;
            font-size: 21px;
            font-weight: 600;
        }
        
        .description-text {
            display: block;
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
        }
        
        .stage-card {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fff;
            transition: all 0.3s;
        }
        
        .stage-card:hover {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stage-card .stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .stage-card .stage-number {
            background: #007bff;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .stage-card .stage-tools {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        .stage-card .tool-badge {
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
    </style>
    
    <script>
        let projectId = '@Model.Id';
        let currentRunMode = '';
        let workflowData = null;
        let workflowViewer = null;
        
        $(document).ready(function() {
            // Initialize workflow diagram viewer
            const diagramViewer = new WorkflowDiagramViewer('workflowDiagramContainer', projectId);
            
            // Load other components
            loadWorkflowSteps(projectId);
            loadOrchestratorSettings();
            loadExecutionHistory();
            loadRelatedRequests();
        });
        
        
        function renderWorkflowSteps(workflow) {
            const container = $('#workflowSteps');
            container.empty();
            
            let steps = [];
            
            // Get steps from orchestratorData or nodes
            if (workflow.metadata && workflow.metadata.orchestratorData) {
                // The orchestratorData now contains the entire WorkflowDesignerDto
                const orchestratorData = workflow.metadata.orchestratorData;
                steps = orchestratorData.steps || [];
            } else if (workflow.nodes) {
                // Convert nodes to steps format for display
                steps = workflow.nodes.map(node => ({
                    id: node.id,
                    name: node.name,
                    type: node.type,
                    tools: node.tools || [],
                    description: node.description || ''
                }));
            }
            
            if (steps.length > 0) {
                const stepsHtml = steps.map((step, index) => {
                    const stepNumber = index + 1;
                    const stepIcon = getStepIcon(step.type);
                    const stepColor = getStepColor(step.type);
                    const toolsDisplay = step.tools && step.tools.length > 0 
                        ? `<div class="mt-2"><small class="text-muted"><i class="fas fa-tools"></i> N치stroje: ${step.tools.join(', ')}</small></div>`
                        : '';
                    
                    return `
                        <div class="step-item d-flex align-items-start mb-3">
                            <div class="step-number bg-${stepColor} text-white rounded-circle d-flex align-items-center justify-content-center mr-3" style="width: 40px; height: 40px; min-width: 40px;">
                                <i class="${stepIcon}"></i>
                            </div>
                            <div class="step-content flex-grow-1">
                                <h6 class="mb-1">${step.name}</h6>
                                <p class="text-muted mb-1">${step.type || 'Task'}</p>
                                ${step.description ? `<small class="text-secondary">${step.description}</small>` : ''}
                                ${toolsDisplay}
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.html(`
                    <div class="workflow-steps">
                        ${stepsHtml}
                    </div>
                `);
            } else {
                container.html(`
                    <div class="text-center py-3">
                        <i class="fas fa-tasks fa-2x text-muted mb-2"></i>
                        <p class="text-muted">콯치dn칠 kroky workflow nejsou definov치ny</p>
                    </div>
                `);
            }
        }
        
        function getStepIcon(type) {
            const icons = {
                'process': 'fas fa-cogs',
                'ai-tool': 'fas fa-robot',
                'decision': 'fas fa-question-circle',
                'parallel-gateway': 'fas fa-code-branch',
                'condition': 'fas fa-question-circle',
                'parallel': 'fas fa-code-branch',
                'task': 'fas fa-tasks'
            };
            return icons[type] || 'fas fa-circle';
        }
        
        function getStepColor(type) {
            const colors = {
                'process': 'primary',
                'ai-tool': 'success',
                'decision': 'warning',
                'parallel-gateway': 'info',
                'condition': 'warning',
                'parallel': 'info',
                'task': 'primary'
            };
            return colors[type] || 'secondary';
        }
        
        function drawConnections() {
            // This is a simplified connection drawing
            // In a real implementation, you would calculate proper paths
            const svg = $('#workflowDiagram svg');
            const nodes = $('#workflowDiagram .workflow-node');
            
            for (let i = 0; i < nodes.length - 1; i++) {
                const from = $(nodes[i]);
                const to = $(nodes[i + 1]);
                
                const x1 = from.position().left + from.width();
                const y1 = from.position().top + from.height() / 2;
                const x2 = to.position().left;
                const y2 = to.position().top + to.height() / 2;
                
                const path = `<path class="workflow-connection" d="M ${x1} ${y1} L ${x2} ${y2}"/>`;
                svg.append(path);
            }
        }
        
        function loadWorkflowSteps(projectId) {
            $.ajax({
                url: `/api/workflow-designer/${projectId}`,
                type: 'GET',
                success: function(response) {
                    if (response.success && response.data) {
                        // Store workflow data including workflow ID
                        workflowData = response.data;
                        
                        // Create wrapper object for compatibility
                        const workflowWrapper = {
                            metadata: {
                                orchestratorData: response.data
                            }
                        };
                        renderWorkflowSteps(workflowWrapper);
                    }
                },
                error: function() {
                    $('#workflowSteps').html(`
                        <div class="text-center py-3">
                            <i class="fas fa-exclamation-triangle text-warning"></i>
                            <p class="text-muted">Unable to load workflow steps</p>
                        </div>
                    `);
                }
            });
        }
        
        // Old renderWorkflowSteps function removed - using the new one defined earlier
        
        function loadOrchestratorSettings() {
            // Orchestrator settings are now part of workflow, not project
            // This function is kept for backward compatibility but does nothing
        }
        
        function updateOrchestratorDisplay(settings) {
            if (settings.type) {
                $('#orchestratorDisplay dd:eq(0)').html(`<span class="badge badge-primary">${settings.type}</span>`);
            }
            if (settings.model) {
                $('#orchestratorDisplay dd:eq(1)').text(settings.model);
            }
            if (settings.temperature !== undefined) {
                $('#orchestratorDisplay dd:eq(2)').text(settings.temperature);
            }
            if (settings.systemPrompt) {
                $('#systemPromptDisplay').text(settings.systemPrompt);
            }
        }
        
        function loadExecutionHistory() {
            // First make sure we have workflow ID
            const workflowId = workflowData?.id || workflowData?.workflowId;
            if (!workflowData || !workflowId) {
                $('#executionHistoryBody').html(`
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin"></i> Na캜칤t치m workflow...
                        </td>
                    </tr>
                `);
                // Try again in a moment
                setTimeout(loadExecutionHistory, 1000);
                return;
            }
            
            $.ajax({
                url: `/api/workflow/history/${workflowId}`,
                type: 'GET',
                data: { page: 1, pageSize: 10 },
                success: function(response) {
                    // Handle wrapped response from BaseApiController
                    const executions = response.data?.items || response.data || [];
                    renderExecutionHistory(executions);
                },
                error: function() {
                    $('#executionHistoryBody').html(`
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                <i class="fas fa-exclamation-triangle"></i> Nepoda콏ilo se na캜칤st historii spu코t캩n칤
                            </td>
                        </tr>
                    `);
                }
            });
        }
        
        function renderExecutionHistory(executions) {
            const tbody = $('#executionHistoryBody');
            tbody.empty();
            
            if (!executions || executions.length === 0) {
                tbody.html(`
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            No execution history available
                        </td>
                    </tr>
                `);
                return;
            }
            
            executions.forEach(execution => {
                const duration = execution.durationSeconds ? 
                    execution.durationSeconds + 's' : 
                    (execution.completedAt ? 
                        Math.round((new Date(execution.completedAt) - new Date(execution.startedAt)) / 1000) + 's' : 
                        'B캩쮂...');
                
                const statusBadge = {
                    'Completed': 'badge-success',
                    'Running': 'badge-primary',
                    'Failed': 'badge-danger',
                    'Cancelled': 'badge-warning',
                    'Pending': 'badge-info'
                }[execution.status] || 'badge-secondary';
                
                const initiatedBy = execution.initiatedBy || execution.startedBy || 'System';
                const completedSteps = execution.completedSteps || 0;
                const totalSteps = execution.totalSteps || 0;
                const progress = totalSteps > 0 ? `${completedSteps}/${totalSteps}` : '-';
                
                const row = $(`
                    <tr>
                        <td>${new Date(execution.startedAt).toLocaleString('cs-CZ')}</td>
                        <td>${execution.completedAt ? new Date(execution.completedAt).toLocaleString('cs-CZ') : '-'}</td>
                        <td>${duration}</td>
                        <td>${progress}</td>
                        <td><span class="badge ${statusBadge}">${execution.status}</span></td>
                        <td>${initiatedBy}</td>
                        <td>
                            <button class="btn btn-sm btn-default" onclick="viewExecutionDetails('${execution.executionId || execution.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `);
                tbody.append(row);
            });
        }
        
        function showRunModal(mode) {
            currentRunMode = mode;
            
            if (mode === 'test') {
                // For test mode, open the test modal directly
                testWorkflow();
            } else {
                // For production run, execute directly without modal
                runProductionWorkflow();
            }
        }
        
        function runProductionWorkflow() {
            // Get workflow ID from the project's workflow
            const workflowId = workflowData?.id || workflowData?.workflowId;
            if (!workflowId) {
                toastr.error('Projekt nem치 p콏i콏azen칠 workflow');
                console.error('Workflow data:', workflowData);
                return;
            }
            
            // Show loading indicator
            toastr.info('Spou코t칤m workflow...', '', {timeOut: 2000});
            
            const executionData = {
                inputParameters: {},
                enableDebugLogging: false,
                initiatedBy: `Production run ${new Date().toLocaleString('cs-CZ')}`,
                metadata: {
                    projectId: projectId,
                    mode: 'production',
                    priority: 'normal'
                }
            };
            
            $.ajax({
                url: `/api/workflow/execute/${workflowId}`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(executionData),
                success: function(response) {
                    if (response.success && response.data) {
                        toastr.success('Workflow bylo 칰sp캩코n캩 spu코t캩no!');
                        
                        // Show execution ID
                        if (response.data.executionId) {
                            toastr.info(`ID spu코t캩n칤: ${response.data.executionId}`);
                        }
                        
                        // Refresh history after a delay
                        setTimeout(() => {
                            loadExecutionHistory();
                        }, 2000);
                    } else {
                        toastr.error(response.message || 'Chyba p콏i spou코t캩n칤 workflow');
                    }
                },
                error: function(xhr) {
                    let errorMsg = 'Nepoda콏ilo se spustit workflow';
                    try {
                        const errorResponse = JSON.parse(xhr.responseText);
                        if (errorResponse.message) {
                            errorMsg = errorResponse.message;
                        }
                    } catch (e) {}
                    toastr.error(errorMsg);
                }
            });
        }
        
        function executeWorkflow() {
            // Get workflow ID from the project's workflow
            const workflowId = workflowData?.workflowId;
            if (!workflowId) {
                toastr.error('Projekt nem치 p콏i콏azen칠 workflow');
                return;
            }
            
            const executionData = {
                inputParameters: JSON.parse($('#inputParameters').val() || '{}'),
                enableDebugLogging: $('#debugMode').is(':checked'),
                initiatedBy: $('#runName').val() || `${currentRunMode} run ${new Date().toLocaleString()}`,
                // Add metadata for project context
                metadata: {
                    projectId: projectId,
                    mode: currentRunMode,
                    priority: $('#runPriority').val(),
                    testItemLimit: currentRunMode === 'test' ? parseInt($('#testItemLimit').val()) : null
                }
            };
            
            $.ajax({
                url: `/api/workflow/execute/${workflowId}`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(executionData),
                success: function(response) {
                    $('#runWorkflowModal').modal('hide');
                    
                    if (response.success && response.data) {
                        toastr.success('Workflow spu코t캩no 칰sp캩코n캩!');
                        
                        // Show execution ID
                        if (response.data.executionId) {
                            toastr.info(`Execution ID: ${response.data.executionId}`);
                        }
                        
                        // Refresh history after a delay
                        setTimeout(() => {
                            loadExecutionHistory();
                        }, 2000);
                    } else {
                        toastr.error(response.message || 'Chyba p콏i spou코t캩n칤 workflow');
                    }
                },
                error: function(xhr) {
                    let errorMsg = 'Nepoda콏ilo se spustit workflow';
                    try {
                        const errorResponse = JSON.parse(xhr.responseText);
                        if (errorResponse.message) {
                            errorMsg = errorResponse.message;
                        }
                    } catch (e) {}
                    toastr.error(errorMsg);
                }
            });
        }
        
        function editStep(stepId) {
            window.location.href = `/WorkflowDesigner?projectId=${projectId}&stepId=${stepId}`;
        }
        
        function showOrchestratorModal() {
            // Load current settings
            // Orchestrator settings are now part of workflow, not project
            // Set default values
            $('#orchestratorType').val('react');
            $('#orchestratorModel').val('llama3.1:70b');
            $('#orchestratorTemp').val(0.7);
            $('#systemPrompt').val('You are a helpful AI assistant that orchestrates workflow execution using the ReAct pattern (Reasoning + Acting).');
            $('#useToolValidation').prop('checked', true);
            
            $('#orchestratorModal').modal('show');
        }
        
        function saveOrchestratorSettings() {
            // Orchestrator settings are now part of workflow, not project
            // This function is kept for backward compatibility
            $('#orchestratorModal').modal('hide');
            toastr.info('Orchestr치tor se nyn칤 konfiguruje ve workflow designeru');
        }
        
        function exportWorkflow() {
            if (!workflowData) {
                toastr.warning('No workflow data to export');
                return;
            }
            
            const dataStr = JSON.stringify(workflowData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `workflow-${projectId}-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        function testWorkflow() {
            // Get workflow ID from the project's workflow
            const workflowId = workflowData?.id || workflowData?.workflowId;
            if (!workflowId) {
                toastr.error('Projekt nem치 p콏i콏azen칠 workflow');
                console.error('Workflow data:', workflowData);
                return;
            }
            
            // Check if workflow has input adapter configuration
            let inputType = 'manual';
            let defaultTestData = {};
            
            if (workflowData?.input?.type) {
                inputType = workflowData.input.type;
                addTestLog('INFO', `Detekov치n vstupn칤 adapt칠r typu: ${inputType}`);
            }
            
            // Prepare test data based on workflow steps
            if (workflowData?.steps && workflowData.steps.length > 0) {
                const firstStep = workflowData.steps[0];
                addTestLog('INFO', `Prvn칤 krok workflow: ${firstStep.name} (${firstStep.type})`);
                
                // If first step is a web scraping tool, add URL
                if (firstStep.name && firstStep.name.toLowerCase().includes('web') || 
                    firstStep.tool === 'web_scraper' || 
                    firstStep.type === 'tool') {
                    defaultTestData.url = 'https://example.com';
                    defaultTestData.selector = 'body';
                }
            }
            
            // Reset test modal
            $('#workflowTestModal').modal('show');
            $('#testProgressBar').css('width', '0%').text('0%').removeClass('bg-success bg-danger').addClass('bg-warning');
            $('#testLogs').html('<div class="text-warning">[SYSTEM] Inicializuji test workflow...</div>');
            $('#testStatus').text('Spou코t칤m test...');
            $('#testStepsCount').text('0 / ' + (workflowData?.steps?.length || 0));
            $('#testDuration').text('0s');
            $('#testStatusIcon').removeClass('fa-check fa-times').addClass('fa-cog fa-spin');
            $('#cancelTestBtn').show();
            $('#closeTestBtn').hide();
            
            // Track test start time
            window.testStartTime = Date.now();
            
            // Add log entry
            addTestLog('INFO', 'P콏ipravuji testovac칤 data...');
            addTestLog('DEBUG', `Workflow m치 ${workflowData?.steps?.length || 0} krok콢`);
            
            // Execute workflow in test mode
            const testData = {
                projectId: projectId,
                runName: `Test Run - ${new Date().toLocaleString('cs-CZ')}`,
                mode: "test",
                priority: "normal",
                testItemLimit: 5,
                enableDebugLogging: true,
                startedBy: "project-detail-test",
                metadata: {
                    inputParameters: Object.assign({
                        testMode: true,
                        maxItems: 5,
                        debug: true
                    }, defaultTestData),
                    source: 'project-detail-test',
                    workflowId: workflowId
                }
            };
            
            addTestLog('INFO', `Spou코t칤m projekt ${projectId} v testovac칤m re쬴mu s orchestr치torem...`);
            addTestLog('DEBUG', `Testovac칤 parametry: ${JSON.stringify(testData.metadata.inputParameters)}`);
            
            $.ajax({
                url: `/api/projects/execute`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(testData),
                success: function(response) {
                    if (response.success && response.data) {
                        const executionId = response.data.id;
                        addTestLog('SUCCESS', `Projekt 칰sp캩코n캩 spu코t캩n s orchestr치torem. Execution ID: ${executionId}`);
                        $('#testProgressBar').css('width', '10%').text('10%');
                        
                        // Start monitoring execution
                        monitorTestExecution(executionId);
                    } else {
                        showTestError(response.message || 'Chyba p콏i spou코t캩n칤 testu');
                    }
                },
                error: function(xhr) {
                    let errorMsg = 'Nepoda콏ilo se spustit test';
                    try {
                        const errorResponse = JSON.parse(xhr.responseText);
                        if (errorResponse.message) {
                            errorMsg = errorResponse.message;
                        }
                        if (errorResponse.errors) {
                            errorMsg += ': ' + errorResponse.errors.join(', ');
                        }
                    } catch (e) {}
                    showTestError(errorMsg);
                }
            });
        }
        
        function addTestLog(level, message) {
            const timestamp = new Date().toLocaleTimeString('cs-CZ');
            let colorClass = 'text-light';
            let prefix = 'INFO';
            
            switch(level) {
                case 'SUCCESS':
                    colorClass = 'text-success';
                    prefix = 'SUCCESS';
                    break;
                case 'ERROR':
                    colorClass = 'text-danger';
                    prefix = 'ERROR';
                    break;
                case 'WARNING':
                    colorClass = 'text-warning';
                    prefix = 'WARNING';
                    break;
                case 'DEBUG':
                    colorClass = 'text-info';
                    prefix = 'DEBUG';
                    break;
            }
            
            const logEntry = `<div class="${colorClass}">[${timestamp}] [${prefix}] ${message}</div>`;
            $('#testLogs').append(logEntry);
            
            // Auto-scroll if enabled
            if ($('#autoScrollLogs').is(':checked')) {
                const logsContainer = $('#testLogs')[0];
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
        }
        
        function monitorTestExecution(executionId) {
            window.testMonitoringInterval = setInterval(async () => {
                try {
                    // Update test duration
                    const elapsed = Math.round((Date.now() - window.testStartTime) / 1000);
                    $('#testDuration').text(elapsed + 's');
                    
                    // Use project execution API instead of workflow execution API
                    const response = await $.ajax({
                        url: `/api/projects/execution/${executionId}`,
                        type: 'GET'
                    });
                    
                    if (response && response.id) {
                        // Project execution returns the execution object directly
                        const execution = response;
                        
                        // Calculate progress based on items processed
                        const progress = execution.itemsProcessedCount && execution.totalItemsCount 
                            ? Math.round((execution.itemsProcessedCount / execution.totalItemsCount) * 100)
                            : 0;
                        $('#testProgressBar').css('width', progress + '%').text(progress + '%');
                        
                        // Update status - handle project execution statuses
                        const displayStatus = execution.status === 'Running' || execution.status === 'InProgress' ? 'B캩쮂...' : execution.status;
                        $('#testStatus').text(displayStatus);
                        
                        // Update step count - use items instead of steps for project execution
                        if (execution.itemsProcessedCount !== undefined) {
                            $('#testStepsCount').text(`${execution.itemsProcessedCount} / ${execution.totalItemsCount || 0}`);
                        }
                        
                        // Add log for current stage
                        if (execution.currentStage && execution.currentStage !== window.lastStage) {
                            addTestLog('INFO', `Aktu치ln칤 f치ze: ${execution.currentStage}`);
                            window.lastStage = execution.currentStage;
                        }
                        
                        // Show execution log if available
                        if (execution.executionLog && execution.executionLog !== window.lastExecutionLog) {
                            window.lastExecutionLog = execution.executionLog;
                            const logEntries = execution.executionLog.split('\n');
                            logEntries.forEach(entry => {
                                if (entry.trim()) {
                                    addTestLog('DEBUG', entry);
                                }
                            });
                        }
                        
                        // Check if execution is complete - handle project execution statuses
                        if (execution.status !== 'Running' && execution.status !== 'Pending' && execution.status !== 'InProgress') {
                            clearInterval(window.testMonitoringInterval);
                            
                            if (execution.status === 'Completed' || execution.status === 'Success') {
                                $('#testProgressBar')
                                    .removeClass('progress-bar-animated bg-warning')
                                    .addClass('bg-success')
                                    .css('width', '100%')
                                    .text('100%');
                                $('#testStatus').text('Dokon캜eno 칰sp캩코n캩');
                                $('#testStatusIcon').removeClass('fa-cog fa-spin').addClass('fa-check');
                                $('.info-box-icon.bg-warning').removeClass('bg-warning').addClass('bg-success');
                                
                                addTestLog('SUCCESS', '=== TEST DOKON캛EN 칔SP캨N캨 ===');
                                addTestLog('SUCCESS', `Execution ID: ${executionId}`);
                                addTestLog('SUCCESS', `Doba trv치n칤: ${execution.durationSeconds || elapsed}s`);
                                if (execution.itemsProcessedCount !== undefined) {
                                    addTestLog('SUCCESS', `Zpracov치no polo쬰k: ${execution.itemsProcessedCount}/${execution.totalItemsCount || '?'}`);
                                }
                                
                                // Show execution results if available
                                if (execution.outputData) {
                                    addTestLog('INFO', 'V칳stupn칤 data:');
                                    addTestLog('DEBUG', JSON.stringify(execution.outputData, null, 2));
                                }
                                
                                $('#cancelTestBtn').hide();
                                $('#closeTestBtn').show();
                            } else {
                                const errorMsg = execution.errorMessage || execution.status;
                                showTestError(`Test selhal: ${errorMsg}`);
                                
                                if (execution.errorStackTrace) {
                                    addTestLog('ERROR', 'Stack trace:');
                                    addTestLog('ERROR', execution.errorStackTrace);
                                }
                            }
                        }
                    } else if (response.success && response.data) {
                        // Handle old format response for backward compatibility
                        const status = response.data;
                        const progress = Math.round(status.progressPercentage || 0);
                        $('#testProgressBar').css('width', progress + '%').text(progress + '%');
                        
                        // Update status
                        $('#testStatus').text(status.status === 'Running' ? 'B캩쮂...' : status.status);
                        
                        // Update step count
                        const completedSteps = status.completedSteps || 0;
                        const totalSteps = status.totalSteps || 0;
                        $('#testStepsCount').text(`${completedSteps} / ${totalSteps}`);
                        
                        // Add log for current step
                        if (status.currentStepName && status.currentStepName !== window.lastStepName) {
                            addTestLog('INFO', `Zpracov치v치m krok: ${status.currentStepName}`);
                            window.lastStepName = status.currentStepName;
                        }
                        
                        if (status.status !== 'Running' && status.status !== 'Pending') {
                            clearInterval(window.testMonitoringInterval);
                            
                            if (status.status === 'Completed') {
                                $('#testProgressBar')
                                    .removeClass('progress-bar-animated bg-warning')
                                    .addClass('bg-success')
                                    .css('width', '100%')
                                    .text('100%');
                                $('#testStatus').text('Dokon캜eno 칰sp캩코n캩');
                                $('#testStatusIcon').removeClass('fa-cog fa-spin').addClass('fa-check');
                                $('.info-box-icon.bg-warning').removeClass('bg-warning').addClass('bg-success');
                                
                                addTestLog('SUCCESS', '=== TEST DOKON캛EN 칔SP캨N캨 ===');
                                addTestLog('SUCCESS', `Execution ID: ${executionId}`);
                                addTestLog('SUCCESS', `Doba trv치n칤: ${status.durationSeconds || elapsed}s`);
                                addTestLog('SUCCESS', `Zpracov치no krok콢: ${completedSteps}/${totalSteps}`);
                                
                                $('#cancelTestBtn').hide();
                                $('#closeTestBtn').show();
                            } else {
                                showTestError(`Test selhal: ${status.message || status.status}`);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error checking test status:', error);
                    addTestLog('WARNING', 'Chyba p콏i kontrole stavu testu: ' + error.message);
                }
            }, 2000);
            
            // Also try to fetch execution logs
            // fetchExecutionLogs(executionId); // Commented out - logs are saved to files, not available via API
        }
        
        function fetchExecutionLogs(executionId) {
            window.logFetchInterval = setInterval(async () => {
                try {
                    const response = await $.ajax({
                        url: `/api/workflow/execution/${executionId}/logs`,
                        type: 'GET'
                    });
                    
                    if (response.success && response.data) {
                        response.data.forEach(log => {
                            const logId = `${log.timestamp}-${log.message}`;
                            if (!window.processedLogIds || !window.processedLogIds.includes(logId)) {
                                addTestLog(
                                    log.level || 'DEBUG',
                                    `[${log.source || 'WORKFLOW'}] ${log.message}`
                                );
                                if (!window.processedLogIds) window.processedLogIds = [];
                                window.processedLogIds.push(logId);
                            }
                        });
                    }
                } catch (error) {
                    // Silently ignore - logs endpoint might not exist
                }
            }, 3000);
        }
        
        function showTestError(message) {
            $('#testProgressBar')
                .removeClass('progress-bar-animated bg-warning')
                .addClass('bg-danger')
                .css('width', '100%')
                .text('Chyba');
            $('#testStatus').text('Test selhal');
            $('#testStatusIcon').removeClass('fa-cog fa-spin').addClass('fa-times');
            $('.info-box-icon.bg-warning').removeClass('bg-warning').addClass('bg-danger');
            
            addTestLog('ERROR', '=== TEST SELHAL ===');
            addTestLog('ERROR', message);
            
            $('#cancelTestBtn').hide();
            $('#closeTestBtn').show();
            
            // Clear intervals
            if (window.testMonitoringInterval) clearInterval(window.testMonitoringInterval);
            if (window.logFetchInterval) clearInterval(window.logFetchInterval);
        }
        
        function cancelTest() {
            addTestLog('WARNING', 'Test byl zru코en u쬴vatelem');
            
            // Clear intervals
            if (window.testMonitoringInterval) clearInterval(window.testMonitoringInterval);
            // if (window.logFetchInterval) clearInterval(window.logFetchInterval);
            
            // Reset state
            window.lastStepName = null;
            window.processedLogs = [];
            window.processedLogIds = [];
            
            $('#workflowTestModal').modal('hide');
        }
        
        function refreshHistory() {
            $('#executionHistoryBody').html(`
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </td>
                </tr>
            `);
            loadExecutionHistory();
        }
        
        function viewExecutionDetails(executionId) {
            // Open workflow execution details modal or redirect to details page
            // For now, let's show a modal with execution details
            $.ajax({
                url: `/api/workflow/execution/${executionId}/details`,
                type: 'GET',
                success: function(response) {
                    if (response.success && response.data) {
                        showExecutionDetailsModal(response.data);
                    }
                },
                error: function() {
                    toastr.error('Nepoda콏ilo se na캜칤st detaily spu코t캩n칤');
                }
            });
        }
        
        function showExecutionDetailsModal(executionData) {
            // Create a simple modal to show execution details
            const modalHtml = `
                <div class="modal fade" id="executionDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Detaily spu코t캩n칤 workflow</h5>
                                <button type="button" class="close" data-dismiss="modal">
                                    <span>&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <pre>${JSON.stringify(executionData, null, 2)}</pre>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Zav콏칤t</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            $('#executionDetailsModal').remove();
            $('body').append(modalHtml);
            $('#executionDetailsModal').modal('show');
        }
        
        function loadRelatedRequests() {
            $.ajax({
                url: '/api/requestsapi',
                type: 'GET',
                success: function(response) {
                    const requests = response.data || [];
                    const relatedRequests = requests.filter(r => r.projectId === projectId);
                    renderRelatedRequests(relatedRequests);
                },
                error: function() {
                    $('#relatedRequests').html(`
                        <div class="text-center py-3 text-muted">
                            <i class="fas fa-exclamation-triangle"></i> Nepoda콏ilo se na캜칤st po쬬davky
                        </div>
                    `);
                }
            });
        }
        
        function renderRelatedRequests(requests) {
            const container = $('#relatedRequests');
            container.empty();
            
            if (requests.length === 0) {
                container.html(`
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                        <h5>콯치dn칠 po쬬davky</h5>
                        <p class="mb-3">Zat칤m nejsou k tomuto projektu p콏i콏azeny 쮂멳n칠 po쬬davky</p>
                        <a href="/Requests/New?projectId=@Model.Id" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Vytvo콏it prvn칤 po쬬davek
                        </a>
                    </div>
                `);
                return;
            }
            
            // Table layout for better full-width display
            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>캛칤slo</th>
                                <th>N치zev</th>
                                <th>Klient</th>
                                <th>Status</th>
                                <th>Priorita</th>
                                <th>Vytvo콏eno</th>
                                <th>Akce</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${requests.map(request => {
                                const statusBadge = getRequestStatusBadge(request.status);
                                const priorityBadge = getRequestPriorityBadge(request.priority);
                                
                                return `
                                    <tr>
                                        <td>
                                            <a href="/Requests/${request.id}" class="font-weight-bold">
                                                ${request.requestNumber}
                                            </a>
                                        </td>
                                        <td>${request.title}</td>
                                        <td>${request.clientName || '<span class="text-muted">-</span>'}</td>
                                        <td><span class="badge ${statusBadge.class}">${statusBadge.text}</span></td>
                                        <td><span class="badge ${priorityBadge.class}">${priorityBadge.text}</span></td>
                                        <td>
                                            <small class="text-muted">
                                                <i class="fas fa-clock"></i> ${new Date(request.createdAt).toLocaleDateString('cs-CZ')}
                                            </small>
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <a href="/Requests/${request.id}" class="btn btn-sm btn-default">
                                                    <i class="fas fa-eye"></i> Detail
                                                </a>
                                                <a href="/Requests/${request.id}/Edit" class="btn btn-sm btn-default">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.html(tableHtml);
        }
        
        function getRequestStatusBadge(status) {
            const badges = {
                'New': { class: 'badge-info', text: '游 Nov칳' },
                'InProgress': { class: 'badge-primary', text: '丘뙖잺 V Procesu' },
                'OnHold': { class: 'badge-warning', text: '낒勇 Odlo쬰no' },
                'Completed': { class: 'badge-success', text: '九 Ukon캜eno' }
            };
            return badges[status] || { class: 'badge-secondary', text: status };
        }
        
        function getRequestPriorityBadge(priority) {
            const badges = {
                'Low': { class: 'badge-secondary', text: 'N칤zk치' },
                'Normal': { class: 'badge-info', text: 'Norm치ln칤' },
                'High': { class: 'badge-warning', text: 'Vysok치' },
                'Urgent': { class: 'badge-danger', text: 'Urgentn칤' }
            };
            return badges[priority] || { class: 'badge-secondary', text: priority };
        }
        
        function archiveProject(projectId) {
            $.ajax({
                url: '/api/projects/' + projectId + '/archive',
                type: 'PUT',
                success: function(response) {
                    toastr.success('Projekt byl 칰sp캩코n캩 archivov치n.');
                    setTimeout(() => {
                        window.location.href = '/Projects';
                    }, 1000);
                },
                error: function(xhr) {
                    const errorMessage = xhr.responseJSON?.message || xhr.responseText || 'Nepoda콏ilo se archivovat projekt';
                    toastr.error(errorMessage);
                }
            });
        }
        
        function deleteProject(projectId) {
            $.ajax({
                url: '/api/projects/' + projectId,
                type: 'DELETE',
                success: function(response) {
                    toastr.success('Projekt byl 칰sp캩코n캩 smaz치n.');
                    setTimeout(() => {
                        window.location.href = '/Projects';
                    }, 1000);
                },
                error: function(xhr) {
                    const errorMessage = xhr.responseJSON?.message || xhr.responseText || 'Nepoda콏ilo se smazat projekt';
                    toastr.error(errorMessage);
                }
            });
        }
        
        function changeProjectStatus(projectId, newStatus) {
            $.ajax({
                url: '/api/projects/' + projectId,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({
                    status: newStatus
                }),
                success: function(response) {
                    // Update UI dynamically
                    updateStatusUI(newStatus);
                    
                    // Show success notification
                    toastr.success('Stav projektu byl 칰sp캩코n캩 zm캩n캩n');
                },
                error: function(xhr) {
                    const errorMessage = xhr.responseJSON?.message || xhr.responseText || 'Nepoda콏ilo se zm캩nit stav projektu';
                    toastr.error(errorMessage);
                }
            });
        }
        
        function updateStatusUI(newStatus) {
            // Status configurations
            const statusConfig = {
                'Draft': { text: 'Draft', icon: 'pencil-alt', color: 'secondary' },
                'Active': { text: 'Aktivn칤', icon: 'play-circle', color: 'success' },
                'Paused': { text: 'Pozastaveno', icon: 'pause-circle', color: 'warning' },
                'Completed': { text: 'Dokon캜eno', icon: 'check-circle', color: 'info' },
                'Failed': { text: 'Selhalo', icon: 'times-circle', color: 'danger' }
            };
            
            const config = statusConfig[newStatus];
            const $dropdown = $('#statusDropdown');
            const $statusBadge = $('h1 .badge');
            
            // Update dropdown button
            $dropdown.removeClass('btn-outline-secondary btn-outline-success btn-outline-warning btn-outline-info btn-outline-danger');
            $dropdown.addClass('btn-outline-' + config.color);
            $dropdown.html('<i class="fas fa-' + config.icon + '"></i> <span id="currentStatus">' + config.text + '</span>');
            
            // Update active item in dropdown menu
            $('.status-item').removeClass('active');
            $('.status-item[data-status="' + newStatus + '"]').addClass('active');
            
            // Update status badge in header
            $statusBadge.removeClass('badge-secondary badge-success badge-warning badge-info badge-danger');
            $statusBadge.addClass('badge-' + config.color);
            $statusBadge.html('<i class="fas fa-' + config.icon + '"></i> ' + newStatus);
        }
        
        // Copy test logs to clipboard implementation
        window.copyTestLogs_impl = function() {
            const logContainer = document.getElementById('testLogs');
            if (!logContainer) {
                toastr.error('Logy nejsou k dispozici');
                return;
            }
            
            // Get all log entries and format them for copying
            const logEntries = logContainer.querySelectorAll('div');
            let logText = '';
            
            logEntries.forEach(entry => {
                // Remove HTML tags and get plain text
                const text = entry.textContent || entry.innerText || '';
                if (text.trim()) {
                    logText += text + '\n';
                }
            });
            
            // Create temporary textarea to copy text
            const textarea = document.createElement('textarea');
            textarea.value = logText;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            
            // Select and copy text
            textarea.select();
            textarea.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                toastr.success('Logy byly zkop칤rov치ny do schr치nky');
            } catch (err) {
                toastr.error('Nepoda콏ilo se zkop칤rovat logy');
                console.error('Copy failed:', err);
            }
            
            // Remove temporary textarea
            document.body.removeChild(textarea);
        }

        // Auto-test functionality - check for autoTest URL parameter
        $(document).ready(function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('autoTest') === 'true') {
                // Remove the parameter from URL
                const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                window.history.replaceState({path: newUrl}, '', newUrl);
                
                // Automatically start test after a short delay
                setTimeout(function() {
                    if (typeof testWorkflow === 'function') {
                        testWorkflow();
                    }
                }, 500);
            }
        });
    </script>
}