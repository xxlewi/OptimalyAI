@model OAI.Core.DTOs.ProjectDto
@{
    ViewData["Title"] = $"Projekt: {Model.Name}";
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-8">
                <h1>
                    <i class="fas fa-project-diagram"></i> @Model.Name
                    <span class="badge badge-@(Model.Status switch { 
                        "Active" => "success",
                        "Failed" => "danger",
                        "Paused" => "warning",
                        "Completed" => "info",
                        "Draft" => "secondary",
                        _ => "secondary"
                    }) ml-2">
                        <i class="fas fa-@(Model.Status switch {
                            "Active" => "play-circle",
                            "Failed" => "times-circle",
                            "Paused" => "pause-circle",
                            "Completed" => "check-circle",
                            "Draft" => "pencil-alt",
                            _ => "flag"
                        })"></i> @Model.Status
                    </span>
                </h1>
                <p class="text-muted">@Model.Description</p>
            </div>
            <div class="col-sm-4 text-right">
                <a href="@Url.Action("Index")" class="btn btn-default">
                    <i class="fas fa-arrow-left"></i> Zpƒõt na seznam
                </a>
                <div class="btn-group">
                    <button class="btn btn-warning" onclick="showRunModal('test')">
                        <i class="fas fa-vial"></i> Test run
                    </button>
                    <button class="btn btn-success" onclick="showRunModal('production')">
                        <i class="fas fa-play"></i> Production run
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <!-- Left column - Info cards -->
            <div class="col-md-4">
                <!-- Basic information -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-info-circle"></i> Z√°kladn√≠ informace</h3>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-5">ID projektu:</dt>
                            <dd class="col-sm-7"><code>@Model.Id.ToString().Substring(0, 8)...</code></dd>
                            
                            <dt class="col-sm-5">Z√°kazn√≠k:</dt>
                            <dd class="col-sm-7">
                                @if (Model.CustomerId.HasValue)
                                {
                                    <a href="@Url.Action("Details", "Customers", new { id = Model.CustomerId.Value })" class="text-primary">
                                        <i class="fas fa-user"></i> @Model.CustomerName
                                    </a>
                                }
                                else
                                {
                                    <span>@Model.CustomerName</span>
                                }
                                @if (!string.IsNullOrEmpty(Model.CustomerEmail))
                                {
                                    <br>
                                    <small class="text-muted">
                                        <a href="mailto:@Model.CustomerEmail">@Model.CustomerEmail</a>
                                    </small>
                                }
                            </dd>
                            
                            <dt class="col-sm-5">Typ workflow:</dt>
                            <dd class="col-sm-7">
                                @switch (Model.WorkflowType)
                                {
                                    case "image_processing":
                                        <span class="badge badge-info"><i class="fa fa-image"></i> Image Processing</span>
                                        break;
                                    case "data_analysis":
                                        <span class="badge badge-primary"><i class="fa fa-chart-line"></i> Data Analysis</span>
                                        break;
                                    case "text_generation":
                                        <span class="badge badge-warning"><i class="fa fa-file-alt"></i> Text Generation</span>
                                        break;
                                    case "custom":
                                    default:
                                        <span class="badge badge-secondary"><i class="fa fa-cogs"></i> Custom</span>
                                        break;
                                }
                            </dd>
                            
                            <dt class="col-sm-5">Spou≈°tƒõn√≠:</dt>
                            <dd class="col-sm-7">
                                @switch (Model.TriggerType)
                                {
                                    case "Manual":
                                        <text><i class="fas fa-hand-pointer"></i> Manu√°ln√≠</text>
                                        break;
                                    case "Schedule":
                                        <span><i class="fas fa-clock"></i> Pl√°novan√©</span>
                                        if (Model.NextRun.HasValue)
                                        {
                                            <br>
                                            <small>Dal≈°√≠: @Model.NextRun.Value.ToString("dd.MM.yyyy HH:mm")</small>
                                        }
                                        break;
                                    case "Event":
                                        <text><i class="fas fa-bolt"></i> Ud√°lostmi</text>
                                        break;
                                    default:
                                        <text><i class="fas fa-question"></i> @Model.TriggerType</text>
                                        break;
                                }
                            </dd>
                            
                            <dt class="col-sm-5">Poƒçet etap:</dt>
                            <dd class="col-sm-7">
                                <span class="badge badge-info">@Model.StageCount</span>
                            </dd>
                        </dl>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-chart-bar"></i> Statistiky</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="description-block border-right">
                                    <h5 class="description-header">@Model.TotalRuns</h5>
                                    <span class="description-text">CELKEM BƒöH≈Æ</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="description-block">
                                    <h5 class="description-header text-@(Model.SuccessRate >= 80 ? "success" : Model.SuccessRate >= 50 ? "warning" : "danger")">
                                        @Model.SuccessRate.ToString("F0")%
                                    </h5>
                                    <span class="description-text">√öSPƒö≈†NOST</span>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="text-center">
                            <p class="text-muted">
                                @if (Model.LastRun.HasValue)
                                {
                                    <text>Posledn√≠ bƒõh: @Model.LastRun.Value.ToString("dd.MM.yyyy HH:mm")</text>
                                    if (Model.LastRunSuccess)
                                    {
                                        <span class="badge badge-success ml-2">√öspƒõ≈°n√Ω</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-danger ml-2">Ne√∫spƒõ≈°n√Ω</span>
                                    }
                                }
                                else
                                {
                                    <text>Zat√≠m nebylo spu≈°tƒõno</text>
                                }
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- I/O Configuration -->
                <div class="card collapsed-card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-exchange-alt"></i> Vstupy & V√Ωstupy</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" onclick="showIOEditModal()">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="display: none;">
                        <h6><i class="fas fa-sign-in-alt text-primary"></i> Vstup workflow</h6>
                        <dl class="row mb-3" id="inputConfigDisplay">
                            <dt class="col-sm-5">Typ:</dt>
                            <dd class="col-sm-7">
                                <span class="badge badge-info">üìÅ Soubory</span>
                            </dd>
                            <dt class="col-sm-5">Form√°t:</dt>
                            <dd class="col-sm-7">Libovoln√© soubory</dd>
                            <dt class="col-sm-5">Zdroj:</dt>
                            <dd class="col-sm-7">Upload soubor≈Ø</dd>
                        </dl>
                        
                        <h6><i class="fas fa-sign-out-alt text-success"></i> V√Ωstup workflow</h6>
                        <dl class="row" id="outputConfigDisplay">
                            <dt class="col-sm-5">Typ:</dt>
                            <dd class="col-sm-7">
                                <span class="badge badge-success">üìÑ JSON</span>
                            </dd>
                            <dt class="col-sm-5">Form√°t:</dt>
                            <dd class="col-sm-7">Strukturovan√Ω v√Ωstup</dd>
                        </dl>
                    </div>
                </div>
                
                <!-- AI & Orchestrator -->
                <div class="card collapsed-card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-robot"></i> AI & Orchestrator</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" onclick="showOrchestratorModal()">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="display: none;">
                        <dl class="row" id="orchestratorDisplay">
                            <dt class="col-sm-5">Orchestrator:</dt>
                            <dd class="col-sm-7">
                                <span class="badge badge-primary">ReAct</span>
                            </dd>
                            <dt class="col-sm-5">Model:</dt>
                            <dd class="col-sm-7">Llama 3.1 (70B)</dd>
                            <dt class="col-sm-5">Temperature:</dt>
                            <dd class="col-sm-7">0.7</dd>
                        </dl>
                        <div class="form-group mb-0">
                            <label>System Prompt:</label>
                            <div class="border rounded p-2 bg-light">
                                <small id="systemPromptDisplay">You are a helpful AI assistant that orchestrates workflow execution using the ReAct pattern (Reasoning + Acting).</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right column - Workflow -->
            <div class="col-md-8">
                <!-- Workflow diagram -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-project-diagram"></i> Workflow Diagram
                        </h3>
                        <div class="card-tools">
                            <button class="btn btn-sm btn-outline-secondary" onclick="exportWorkflow()">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="testWorkflow()">
                                <i class="fas fa-vial"></i> Test
                            </button>
                            <a href="@Url.Action("Index", "WorkflowDesigner", new { projectId = Model.Id })" class="btn btn-sm btn-primary">
                                <i class="fas fa-edit"></i> Upravit
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- IDENTICK√Å struktura jako WorkflowDesigner -->
                        <div style="height: 400px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa; overflow: auto; position: relative;">
                            <div id="workflowDiagram-canvas" style="width: 2000px; height: 400px; position: relative; background-image: linear-gradient(rgba(0,0,0,.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,.05) 1px, transparent 1px); background-size: 20px 20px;">
                            </div>
                            <svg id="workflowDiagram-svg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;">
                                <defs>
                                    <marker id="arrowhead-detail" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto" markerUnits="strokeWidth">
                                        <polygon points="0 0, 10 3.5, 0 7" fill="#6c757d"/>
                                    </marker>
                                </defs>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- Workflow steps -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-tasks"></i> Workflow Steps
                        </h3>
                    </div>
                    <div class="card-body" id="workflowSteps">
                        <div class="text-center py-3">
                            <i class="fas fa-spinner fa-spin"></i> Naƒç√≠t√°m kroky workflow...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Execution history -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-history"></i> Historie spu≈°tƒõn√≠
                        </h3>
                        <div class="card-tools">
                            <button class="btn btn-sm btn-default" onclick="refreshHistory()">
                                <i class="fas fa-sync-alt"></i> Obnovit
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="executionHistoryTable">
                                <thead>
                                    <tr>
                                        <th>Zah√°jeno</th>
                                        <th>Dokonƒçeno</th>
                                        <th>Doba trv√°n√≠</th>
                                        <th>Zpracov√°no</th>
                                        <th>Status</th>
                                        <th>Spustil</th>
                                        <th>Akce</th>
                                    </tr>
                                </thead>
                                <tbody id="executionHistoryBody">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin"></i> Naƒç√≠t√°m historii...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modals -->
<!-- Run Workflow Modal -->
<div class="modal fade" id="runWorkflowModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <span id="runModeTitle"></span>
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="runModeWarning" class="alert" style="display: none;">
                </div>
                
                <div class="form-group">
                    <label>Run Name</label>
                    <input type="text" class="form-control" id="runName" placeholder="My test run">
                </div>
                
                <div class="form-group">
                    <label>Input Parameters (JSON)</label>
                    <textarea class="form-control" id="inputParameters" rows="4" placeholder='{"key": "value"}'>{}</textarea>
                </div>
                
                <div class="card collapsed-card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-plus"></i> Advanced Options
                            </button>
                        </h5>
                    </div>
                    <div class="card-body" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Priority</label>
                                    <select class="form-control" id="runPriority">
                                        <option value="low">Low</option>
                                        <option value="normal" selected>Normal</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Test Item Limit</label>
                                    <input type="number" class="form-control" id="testItemLimit" value="10" min="1" max="100">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="debugMode">
                                <label class="custom-control-label" for="debugMode">Enable debug logging</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmRunBtn" onclick="executeWorkflow()">
                    <i class="fas fa-play"></i> Execute
                </button>
            </div>
        </div>
    </div>
</div>

<!-- I/O Edit Modal -->
<div class="modal fade" id="ioEditModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configure Inputs & Outputs</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h6>Input Configuration</h6>
                <div class="form-group">
                    <label>Input Type</label>
                    <select class="form-control" id="configInputType">
                        <option value="files">üìÅ Files</option>
                        <option value="api">üåê API Endpoint</option>
                        <option value="database">üóÑÔ∏è Database</option>
                        <option value="manual">‚úçÔ∏è Manual Input</option>
                    </select>
                </div>
                
                <hr>
                
                <h6>Output Configuration</h6>
                <div class="form-group">
                    <label>Output Type</label>
                    <select class="form-control" id="configOutputType">
                        <option value="json">üìÑ JSON</option>
                        <option value="excel">üìä Excel</option>
                        <option value="csv">üìã CSV</option>
                        <option value="api">üåê API</option>
                        <option value="email">üìß Email</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveIOConfig()">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Orchestrator Settings Modal -->
<div class="modal fade" id="orchestratorModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">AI Orchestrator Settings</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Orchestrator Type</label>
                    <select class="form-control" id="orchestratorType">
                        <option value="conversation">üí¨ Conversation</option>
                        <option value="tool_chain">üîó Tool Chain</option>
                        <option value="react" selected>üß† ReAct (Reasoning + Acting)</option>
                        <option value="custom">‚öôÔ∏è Custom</option>
                    </select>
                </div>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="form-group">
                            <label>AI Model</label>
                            <select class="form-control" id="orchestratorModel">
                                <option value="llama3.1:70b">Llama 3.1 (70B)</option>
                                <option value="mistral:latest">Mistral (7B)</option>
                                <option value="codellama:latest">Code Llama (7B)</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Temperature</label>
                            <input type="number" class="form-control" id="orchestratorTemp" value="0.7" min="0" max="2" step="0.1">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>System Prompt</label>
                    <textarea class="form-control" id="systemPrompt" rows="4">You are a helpful AI assistant that orchestrates workflow execution using the ReAct pattern (Reasoning + Acting).</textarea>
                </div>
                
                <div class="form-group">
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="useToolValidation" checked>
                        <label class="custom-control-label" for="useToolValidation">Enable tool parameter validation</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveOrchestratorSettings()">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Step Edit Modal -->
<div class="modal fade" id="stepEditModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Workflow Step</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Step edit form will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStep()">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Workflow Test Modal -->
<div class="modal fade" id="workflowTestModal" tabindex="-1" role="dialog" data-backdrop="static">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-vial"></i> Testing Workflow
                </h5>
            </div>
            <div class="modal-body">
                <div class="progress mb-3" style="height: 25px;">
                    <div id="testProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
                </div>
                
                <div id="testSteps">
                    <!-- Test steps will be added dynamically -->
                </div>
                
                <div class="mt-3">
                    <h6>Test Results:</h6>
                    <pre id="testResults" class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;">Waiting for results...</pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="cancelTest()">
                    <i class="fas fa-stop"></i> Cancel
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal" style="display: none;" id="closeTestBtn">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Workflow Info Modal -->
<div class="modal fade" id="workflowInfoModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Workflow Information</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <pre id="workflowInfoContent" class="bg-light p-3 rounded"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/workflow-viewer.js"></script>
    <style>
        /* CLEAN CSS - no red! */
        .workflow-node {
            position: absolute !important;
            background: #ffffff !important;
            border: 2px solid #007bff !important;
            border-radius: 8px !important;
            padding: 15px !important;
            min-width: 180px !important;
            cursor: pointer !important;
            user-select: none !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
            z-index: 5 !important;
            color: #333 !important;
        }
        
        .workflow-node.condition {
            width: 140px;
            height: 140px;
            border: none !important;
            background: transparent !important;
            padding: 0;
            min-width: unset;
            box-shadow: none !important;
        }
        
        .workflow-node.condition::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotate(45deg);
            border: 3px solid #ffc107;
            background: #fff8e1;
            border-radius: 15px;
            z-index: 1;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .workflow-node.condition .node-content-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 2;
        }
        
        .workflow-node.condition .node-header {
            margin-bottom: 5px;
            text-align: center;
            font-size: 14px;
            position: relative;
        }
        
        .workflow-node.parallel {
            width: 140px;
            height: 140px;
            border: none !important;
            background: transparent !important;
            padding: 0;
            min-width: unset;
            box-shadow: none !important;
        }
        
        .workflow-node.parallel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotate(45deg);
            border: 3px solid #6f42c1;
            background: #f3e5f5;
            border-radius: 15px;
            z-index: 1;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .workflow-node.parallel::after {
            content: '+';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: #6f42c1;
            z-index: 2;
        }
        
        .workflow-node.parallel .node-content-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 3;
        }
        
        .node-header {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .node-tools {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .tool-badge {
            background: #e9ecef;
            color: #495057;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            white-space: nowrap;
        }
        
        .badge-purple {
            background: #6f42c1;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
        }
    </style>
        .workflow-diagram-container {
            position: relative;
            overflow: auto;
        }
        
        .workflow-node {
            position: absolute;
            background: white;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 15px;
            min-width: 150px;
            text-align: center;
            cursor: move;
            transition: all 0.3s;
        }
        
        .workflow-node:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .workflow-node.start {
            border-color: #28a745;
            background: #28a74510;
        }
        
        .workflow-node.end {
            border-color: #dc3545;
            background: #dc354510;
        }
        
        .workflow-connection {
            stroke: #6c757d;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }
        
        .description-block {
            text-align: center;
            padding: 10px 0;
        }
        
        .description-header {
            margin: 5px 0;
            font-size: 21px;
            font-weight: 600;
        }
        
        .description-text {
            display: block;
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
        }
        
        .stage-card {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fff;
            transition: all 0.3s;
        }
        
        .stage-card:hover {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stage-card .stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .stage-card .stage-number {
            background: #007bff;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .stage-card .stage-tools {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        .stage-card .tool-badge {
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
    </style>
    
    <script>
        let projectId = '@Model.Id';
        let currentRunMode = '';
        let workflowData = null;
        let workflowViewer = null;
        
        // COPIED DIRECTLY FROM WORKFLOW DESIGNER
        let nodes = {};
        let connections = [];
        let selectedNode = null;
        let nodeIdCounter = 1;
        let isConnecting = false;
        let connectionStart = null;
        const currentProjectId = projectId;
        
        $(document).ready(function() {
            // IDENTICAL initialization as WorkflowDesigner
            initializeCanvas();
            loadWorkflowFromServer();
            
            loadWorkflowSteps();
            loadOrchestratorSettings();
            loadExecutionHistory();
        });
        
        // COPIED DIRECTLY FROM WORKFLOW DESIGNER
        function initializeCanvas() {
            $('#workflowDiagram-canvas').on('click', function(e) {
                if (e.target === this) {
                    deselectAll();
                }
            });
        }
        
        function deselectAll() {
            selectedNode = null;
            $('.workflow-node').removeClass('selected');
        }
        
        // COPIED DIRECTLY FROM WORKFLOW DESIGNER  
        function loadWorkflowFromServer() {
            $.ajax({
                url: '/WorkflowDesigner/LoadWorkflow',
                type: 'GET',
                data: { projectId: currentProjectId },
                success: function(response) {
                    if (response.success && response.workflow) {
                        // Check if we have orchestrator data in metadata
                        if (response.workflow.metadata && response.workflow.metadata.orchestratorData) {
                            // Load from orchestrator format
                            loadFromOrchestratorFormat(response.workflow.metadata.orchestratorData);
                        } else if (response.workflow.nodes && response.workflow.nodes.length > 0) {
                            // Load nodes directly from workflow
                            response.workflow.nodes.forEach(node => {
                                const nodeData = {
                                    id: node.id,
                                    type: node.type.toLowerCase(),
                                    name: node.name,
                                    x: node.position.x,
                                    y: node.position.y,
                                    tools: node.tools || [],
                                    description: ''
                                };
                                nodes[node.id] = nodeData;
                                renderNode(nodeData);
                            });
                            
                            // Load edges
                            if (response.workflow.edges) {
                                response.workflow.edges.forEach(edge => {
                                    connections.push({
                                        from: edge.source,
                                        to: edge.target
                                    });
                                });
                                updateConnections();
                            }
                        }
                        console.log('Loaded nodes:', nodes);
                        console.log('Loaded connections:', connections);
                    }
                },
                error: function() {
                    // Create empty workflow on error
                }
            });
        }
        
        // COPIED EXACTLY FROM WORKFLOW DESIGNER
        function loadFromOrchestratorFormat(data) {
            if (!data || !data.steps) return;
            
            // Clear existing
            Object.keys(nodes).forEach(nodeId => {
                $(`#${nodeId}`).remove();
            });
            nodes = {};
            connections = [];
            
            // Get node positions from metadata if available
            const positions = data.metadata?.nodePositions || {};
            
            // Create nodes from steps
            data.steps.forEach((step, index) => {
                const pos = positions[step.id] || {
                    x: 1000,
                    y: 300 + (index * 150)
                };
                
                // Map step type back to node type
                let nodeType = 'task';
                if (step.type === 'decision') nodeType = 'condition';
                else if (step.type === 'parallel-gateway') nodeType = 'parallel';
                else if (step.type === 'ai-tool') nodeType = 'ai-tool';
                
                // Create the node
                const nodeId = step.id;
                nodes[nodeId] = {
                    id: nodeId,
                    type: nodeType,
                    name: step.name,
                    x: pos.x,
                    y: pos.y,
                    tools: step.tools || [],
                    description: step.description || '',
                    condition: step.condition,
                    useReAct: step.useReAct,
                    orchestrator: step.orchestrator,
                    systemPrompt: step.systemPrompt,
                    model: step.model,
                    temperature: step.temperature
                };
                renderNode(nodes[nodeId]);
            });
            
            // Recreate connections based on next/branches
            data.steps.forEach(step => {
                if (step.type === 'decision' && step.branches) {
                    // Decision node connections
                    if (step.branches.true && step.branches.true.length > 0) {
                        connections.push({
                            from: step.id,
                            to: step.branches.true[0],
                            branch: 'true'
                        });
                    }
                    if (step.branches.false && step.branches.false.length > 0) {
                        connections.push({
                            from: step.id,
                            to: step.branches.false[0],
                            branch: 'false'
                        });
                    }
                } else if (step.type === 'parallel-gateway' && step.branches) {
                    // Parallel gateway connections
                    step.branches.forEach(targetId => {
                        connections.push({
                            from: step.id,
                            to: targetId
                        });
                    });
                } else if (step.next) {
                    // Regular step connection
                    connections.push({
                        from: step.id,
                        to: step.next
                    });
                }
            });
            
            updateConnections();
        }
        
        // COPIED EXACTLY FROM WORKFLOW DESIGNER
        function renderNode(node) {
            console.log('Rendering node in detail view:', node);
            
            const nodeEl = $('<div>')
                .addClass('workflow-node')
                .addClass(node.type)
                .attr('id', node.id)
                .css({
                    left: node.x + 'px',
                    top: node.y + 'px'
                });
            
            console.log('Created node element:', nodeEl[0]);
            
            // Create wrapper for diamond-shaped nodes (condition and parallel)
            let contentWrapper;
            if (node.type === 'condition' || node.type === 'parallel') {
                contentWrapper = $('<div>').addClass('node-content-wrapper');
                nodeEl.append(contentWrapper);
            } else {
                contentWrapper = nodeEl;
            }
            
            // Header
            const header = $('<div>').addClass('node-header');
            header.append($('<span>').html(`<i class="${getNodeIcon(node.type)}"></i> ${node.name}`));
            
            contentWrapper.append(header);
            
            // Description
            if (node.description) {
                const descDiv = $('<div>')
                    .css({
                        fontSize: '12px',
                        color: '#666',
                        marginTop: '5px',
                        fontStyle: 'italic'
                    })
                    .text(node.description);
                contentWrapper.append(descDiv);
            }
            
            // Tools
            if (node.tools && node.tools.length > 0) {
                const toolsDiv = $('<div>').addClass('node-tools');
                node.tools.forEach(tool => {
                    toolsDiv.append($('<span>').addClass('tool-badge').text(tool.replace(/_/g, ' ')));
                });
                contentWrapper.append(toolsDiv);
            }
            
            // ReAct badge
            if (node.useReAct) {
                const reactBadge = $('<span>')
                    .addClass('badge badge-purple')
                    .html('<i class="fas fa-brain"></i> ReAct')
                    .css({
                        position: 'absolute',
                        top: '5px',
                        right: '25px',
                        fontSize: '11px'
                    });
                nodeEl.append(reactBadge);
            }
            
            console.log('Appending node to canvas:', $('#workflowDiagram-canvas').length);
            $('#workflowDiagram-canvas').append(nodeEl);
            console.log('Node appended, canvas children count:', $('#workflowDiagram-canvas').children().length);
        }
        
        // COPIED EXACTLY FROM WORKFLOW DESIGNER
        function getNodeIcon(type) {
            const icons = {
                'task': 'fas fa-tasks',
                'condition': 'fas fa-question-circle',
                'parallel': 'fas fa-code-branch',
                'ai-tool': 'fas fa-robot'
            };
            return icons[type] || 'fas fa-circle';
        }
        
        // COPIED EXACTLY FROM WORKFLOW DESIGNER
        function updateConnections() {
            console.log('UpdateConnections called with:', connections);
            const svg = $('#workflowDiagram-svg');
            svg.find('path, line').remove();
            
            connections.forEach(conn => {
                const fromNode = $(`#${conn.from}`);
                const toNode = $(`#${conn.to}`);
                
                console.log(`Drawing connection ${conn.from} -> ${conn.to}: fromNode=${fromNode.length}, toNode=${toNode.length}`);
                
                if (fromNode.length && toNode.length) {
                    drawConnection(fromNode, toNode, conn.branch);
                }
            });
        }
        
        // COPIED EXACTLY FROM WORKFLOW DESIGNER  
        function drawConnection(fromNode, toNode, branch) {
            const fromRect = fromNode[0].getBoundingClientRect();
            const toRect = toNode[0].getBoundingClientRect();
            const containerRect = $('#workflowDiagram-canvas').parent()[0].getBoundingClientRect();
            
            let x1, y1, x2, y2;
            
            if (branch === 'true') {
                x1 = fromRect.right - containerRect.left;
                y1 = fromRect.top - containerRect.top + fromRect.height * 0.3;
            } else if (branch === 'false') {
                x1 = fromRect.right - containerRect.left;
                y1 = fromRect.top - containerRect.top + fromRect.height * 0.7;
            } else {
                x1 = fromRect.right - containerRect.left;
                y1 = fromRect.top - containerRect.top + fromRect.height / 2;
            }
            
            x2 = toRect.left - containerRect.left;
            y2 = toRect.top - containerRect.top + toRect.height / 2;
            
            const svg = document.getElementById('workflowDiagram-svg');
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            
            const midX = (x1 + x2) / 2;
            path.setAttribute('d', `M ${x1} ${y1} Q ${midX} ${y1} ${midX} ${(y1 + y2) / 2} Q ${midX} ${y2} ${x2} ${y2}`);
            path.setAttribute('stroke', branch === 'true' ? '#28a745' : branch === 'false' ? '#dc3545' : '#6c757d');
            path.setAttribute('stroke-width', '2');
            path.setAttribute('fill', 'none');
            path.setAttribute('marker-end', 'url(#arrowhead-detail)');
            
            svg.appendChild(path);
        }
        
        function loadWorkflowDiagram() {
            $.ajax({
                url: '/WorkflowDesigner/LoadWorkflow',
                type: 'GET',
                data: { projectId: projectId },
                success: function(response) {
                    if (response.success && response.workflow) {
                        workflowData = response.workflow;
                        workflowRenderer.renderWorkflow(response.workflow);
                        renderWorkflowSteps(response.workflow);
                    } else {
                        $('#workflowDiagram').html(`
                            <div class="text-center py-5">
                                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                                <p>Workflow diagram not available</p>
                                <a href="/WorkflowDesigner?projectId=${projectId}" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Create Workflow
                                </a>
                            </div>
                        `);
                        $('#workflowSteps').html(`
                            <div class="text-center py-3">
                                <i class="fas fa-exclamation-triangle text-warning"></i>
                                <p class="text-muted">Workflow steps not available</p>
                            </div>
                        `);
                    }
                },
                error: function() {
                    $('#workflowDiagram').html(`
                        <div class="text-center py-5">
                            <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                            <p>Error loading workflow diagram</p>
                        </div>
                    `);
                }
            });
        }
        
        function renderWorkflowDiagram(workflow) {
            // Replaced by WorkflowRenderer component
            console.log('Rendering workflow diagram:', workflow);
            const container = $('#workflowDiagram');
            container.empty();
            
            // Create SVG for connections directly with DOM
            const svgNamespace = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNamespace, "svg");
            svg.setAttribute("width", "100%");
            svg.setAttribute("height", "500px");
            svg.setAttribute("style", "position: absolute; top: 0; left: 0; pointer-events: none; z-index: 0;");
            
            // Create defs for arrow marker
            const defs = document.createElementNS(svgNamespace, "defs");
            const marker = document.createElementNS(svgNamespace, "marker");
            marker.setAttribute("id", "arrowhead");
            marker.setAttribute("markerWidth", "10");
            marker.setAttribute("markerHeight", "7");
            marker.setAttribute("refX", "9");
            marker.setAttribute("refY", "3.5");
            marker.setAttribute("orient", "auto");
            
            const polygon = document.createElementNS(svgNamespace, "polygon");
            polygon.setAttribute("points", "0 0, 10 3.5, 0 7");
            polygon.setAttribute("fill", "#6c757d");
            
            marker.appendChild(polygon);
            defs.appendChild(marker);
            svg.appendChild(defs);
            
            container.append(svg);
            
            // Check if we have orchestratorData format
            if (workflow.metadata && workflow.metadata.orchestratorData && workflow.metadata.orchestratorData.steps) {
                // New format - convert orchestratorData to nodes
                const orchestratorData = workflow.metadata.orchestratorData;
                const nodes = [];
                const edges = [];
                
                // Convert steps to nodes
                orchestratorData.steps.forEach(step => {
                    const position = orchestratorData.metadata?.nodePositions?.[step.id] || { x: 100, y: 100 };
                    nodes.push({
                        id: step.id,
                        name: step.name,
                        type: step.type,
                        position: position,
                        tools: step.tools || []
                    });
                    
                    // Create edges from step connections
                    if (step.next) {
                        edges.push({
                            source: step.id,
                            target: step.next
                        });
                    }
                    if (step.branches) {
                        // For condition nodes
                        if (step.branches.true && step.branches.true.length > 0) {
                            edges.push({
                                source: step.id,
                                target: step.branches.true[0],
                                branch: 'true'
                            });
                        }
                        if (step.branches.false && step.branches.false.length > 0) {
                            edges.push({
                                source: step.id,
                                target: step.branches.false[0],
                                branch: 'false'
                            });
                        }
                        // For parallel nodes
                        if (Array.isArray(step.branches)) {
                            step.branches.forEach(targetId => {
                                edges.push({
                                    source: step.id,
                                    target: targetId
                                });
                            });
                        }
                    }
                });
                
                // Use converted nodes and edges
                workflow.nodes = nodes;
                workflow.edges = edges;
            }
            
            // Render nodes from workflow data
            if (workflow.nodes && workflow.nodes.length > 0) {
                workflow.nodes.forEach(node => {
                    const nodeEl = $(`
                        <div class="workflow-node" data-node-id="${node.id}" style="left: ${node.position.x}px; top: ${node.position.y}px;">
                            <div class="font-weight-bold">${node.name}</div>
                            <small class="text-muted">${node.type}</small>
                            ${node.tools && node.tools.length > 0 ? `<br><small>${node.tools.join(', ')}</small>` : ''}
                        </div>
                    `);
                    
                    // Add special classes based on type
                    if (node.type === 'Condition') {
                        nodeEl.addClass('condition');
                    } else if (node.type === 'Parallel') {
                        nodeEl.addClass('parallel');
                    }
                    
                    container.append(nodeEl);
                });
                
                // Draw connections
                if (workflow.edges && workflow.edges.length > 0) {
                    console.log('Drawing connections:', workflow.edges);
                    setTimeout(() => {
                        workflow.edges.forEach(edge => {
                            console.log('Processing edge:', edge);
                            const fromNode = $(`[data-node-id="${edge.source}"]`);
                            const toNode = $(`[data-node-id="${edge.target}"]`);
                            
                            console.log('From node:', fromNode.length, 'To node:', toNode.length);
                            
                            if (fromNode.length && toNode.length) {
                                // Use direct CSS position values
                                const fromLeft = parseInt(fromNode.css('left')) || 0;
                                const fromTop = parseInt(fromNode.css('top')) || 0;
                                const toLeft = parseInt(toNode.css('left')) || 0;
                                const toTop = parseInt(toNode.css('top')) || 0;
                                
                                const x1 = fromLeft + fromNode.outerWidth();
                                const y1 = fromTop + fromNode.outerHeight() / 2;
                                const x2 = toLeft;
                                const y2 = toTop + toNode.outerHeight() / 2;
                                
                                console.log(`Drawing line from (${x1}, ${y1}) to (${x2}, ${y2})`);
                                
                                // Create path element properly
                                const path = document.createElementNS(svgNamespace, "path");
                                path.setAttribute("d", `M ${x1} ${y1} L ${x2} ${y2}`);
                                path.setAttribute("stroke", "#6c757d");
                                path.setAttribute("stroke-width", "2");
                                path.setAttribute("fill", "none");
                                path.setAttribute("marker-end", "url(#arrowhead)");
                                svg.appendChild(path);
                                
                            }
                        });
                    }, 200);
                }
            } else {
                // Fallback if no nodes - show empty state
                container.html(`
                    <div class="text-center py-5">
                        <i class="fas fa-project-diagram fa-3x text-muted mb-3"></i>
                        <p>Workflow nen√≠ definov√°no</p>
                        <a href="/WorkflowDesigner?projectId=${projectId}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Vytvo≈ôit workflow
                        </a>
                    </div>
                `);
            }
        }
        
        function renderWorkflowSteps(workflow) {
            const container = $('#workflowSteps');
            container.empty();
            
            let steps = [];
            
            // Get steps from orchestratorData or nodes
            if (workflow.metadata && workflow.metadata.orchestratorData && workflow.metadata.orchestratorData.steps) {
                steps = workflow.metadata.orchestratorData.steps;
            } else if (workflow.nodes) {
                // Convert nodes to steps format for display
                steps = workflow.nodes.map(node => ({
                    id: node.id,
                    name: node.name,
                    type: node.type,
                    tools: node.tools || [],
                    description: node.description || ''
                }));
            }
            
            if (steps.length > 0) {
                const stepsHtml = steps.map((step, index) => {
                    const stepNumber = index + 1;
                    const stepIcon = getStepIcon(step.type);
                    const stepColor = getStepColor(step.type);
                    const toolsDisplay = step.tools && step.tools.length > 0 
                        ? `<div class="mt-2"><small class="text-muted"><i class="fas fa-tools"></i> N√°stroje: ${step.tools.join(', ')}</small></div>`
                        : '';
                    
                    return `
                        <div class="step-item d-flex align-items-start mb-3">
                            <div class="step-number bg-${stepColor} text-white rounded-circle d-flex align-items-center justify-content-center mr-3" style="width: 40px; height: 40px; min-width: 40px;">
                                <i class="${stepIcon}"></i>
                            </div>
                            <div class="step-content flex-grow-1">
                                <h6 class="mb-1">${step.name}</h6>
                                <p class="text-muted mb-1">${step.type || 'Task'}</p>
                                ${step.description ? `<small class="text-secondary">${step.description}</small>` : ''}
                                ${toolsDisplay}
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.html(`
                    <div class="workflow-steps">
                        ${stepsHtml}
                    </div>
                `);
            } else {
                container.html(`
                    <div class="text-center py-3">
                        <i class="fas fa-tasks fa-2x text-muted mb-2"></i>
                        <p class="text-muted">≈Ω√°dn√© kroky workflow nejsou definov√°ny</p>
                    </div>
                `);
            }
        }
        
        function getStepIcon(type) {
            const icons = {
                'process': 'fas fa-cogs',
                'ai-tool': 'fas fa-robot',
                'decision': 'fas fa-question-circle',
                'parallel-gateway': 'fas fa-code-branch',
                'condition': 'fas fa-question-circle',
                'parallel': 'fas fa-code-branch',
                'task': 'fas fa-tasks'
            };
            return icons[type] || 'fas fa-circle';
        }
        
        function getStepColor(type) {
            const colors = {
                'process': 'primary',
                'ai-tool': 'success',
                'decision': 'warning',
                'parallel-gateway': 'info',
                'condition': 'warning',
                'parallel': 'info',
                'task': 'primary'
            };
            return colors[type] || 'secondary';
        }
        
        function drawConnections() {
            // This is a simplified connection drawing
            // In a real implementation, you would calculate proper paths
            const svg = $('#workflowDiagram svg');
            const nodes = $('#workflowDiagram .workflow-node');
            
            for (let i = 0; i < nodes.length - 1; i++) {
                const from = $(nodes[i]);
                const to = $(nodes[i + 1]);
                
                const x1 = from.position().left + from.width();
                const y1 = from.position().top + from.height() / 2;
                const x2 = to.position().left;
                const y2 = to.position().top + to.height() / 2;
                
                const path = `<path class="workflow-connection" d="M ${x1} ${y1} L ${x2} ${y2}"/>`;
                svg.append(path);
            }
        }
        
        function loadWorkflowSteps() {
            // This function is now called from loadWorkflowDiagram
            // No separate API call needed since steps are in workflow data
        }
        
        // Old renderWorkflowSteps function removed - using the new one defined earlier
        
        function loadOrchestratorSettings() {
            // Load from project data if available
            if (@Html.Raw(Model.OrchestratorSettings != null ? "true" : "false")) {
                const settings = @Html.Raw(Model.OrchestratorSettings != null ? Json.Serialize(Model.OrchestratorSettings) : "{}");
                updateOrchestratorDisplay(settings);
            }
        }
        
        function updateOrchestratorDisplay(settings) {
            if (settings.type) {
                $('#orchestratorDisplay dd:eq(0)').html(`<span class="badge badge-primary">${settings.type}</span>`);
            }
            if (settings.model) {
                $('#orchestratorDisplay dd:eq(1)').text(settings.model);
            }
            if (settings.temperature !== undefined) {
                $('#orchestratorDisplay dd:eq(2)').text(settings.temperature);
            }
            if (settings.systemPrompt) {
                $('#systemPromptDisplay').text(settings.systemPrompt);
            }
        }
        
        function loadExecutionHistory() {
            $.ajax({
                url: '/api/projects/' + projectId + '/executions',
                type: 'GET',
                data: { limit: 10 },
                success: function(response) {
                    // Handle wrapped response from BaseApiController
                    const executions = response.data || response;
                    renderExecutionHistory(executions);
                },
                error: function() {
                    $('#executionHistoryBody').html(`
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                <i class="fas fa-exclamation-triangle"></i> Unable to load execution history
                            </td>
                        </tr>
                    `);
                }
            });
        }
        
        function renderExecutionHistory(executions) {
            const tbody = $('#executionHistoryBody');
            tbody.empty();
            
            if (!executions || executions.length === 0) {
                tbody.html(`
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            No execution history available
                        </td>
                    </tr>
                `);
                return;
            }
            
            executions.forEach(execution => {
                const duration = execution.completedAt ? 
                    Math.round((new Date(execution.completedAt) - new Date(execution.startedAt)) / 1000) + 's' : 
                    'Running...';
                
                const statusBadge = {
                    'Completed': 'badge-success',
                    'Running': 'badge-primary',
                    'Failed': 'badge-danger',
                    'Cancelled': 'badge-warning'
                }[execution.status] || 'badge-secondary';
                
                const row = $(`
                    <tr>
                        <td>${new Date(execution.startedAt).toLocaleString()}</td>
                        <td>${execution.completedAt ? new Date(execution.completedAt).toLocaleString() : '-'}</td>
                        <td>${duration}</td>
                        <td>${execution.itemsProcessed || 0}</td>
                        <td><span class="badge ${statusBadge}">${execution.status}</span></td>
                        <td>${execution.startedBy}</td>
                        <td>
                            <button class="btn btn-sm btn-default" onclick="viewExecution('${execution.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `);
                tbody.append(row);
            });
        }
        
        function showRunModal(mode) {
            currentRunMode = mode;
            
            if (mode === 'test') {
                $('#runModeTitle').html('<i class="fas fa-vial text-warning"></i> Test Run Configuration');
                $('#runModeWarning').removeClass('alert-danger').addClass('alert-warning');
                $('#runModeWarning').html('<i class="fas fa-exclamation-triangle"></i> <strong>Test mode:</strong> Limited to 10 items for testing purposes.');
                $('#runModeWarning').show();
                $('#confirmRunBtn').removeClass('btn-success').addClass('btn-warning');
                $('#testItemLimit').val(10).prop('disabled', false);
            } else {
                $('#runModeTitle').html('<i class="fas fa-play text-success"></i> Production Run Configuration');
                $('#runModeWarning').removeClass('alert-warning').addClass('alert-danger');
                $('#runModeWarning').html('<i class="fas fa-exclamation-circle"></i> <strong>Production mode:</strong> Will process all items. This may take considerable time.');
                $('#runModeWarning').show();
                $('#confirmRunBtn').removeClass('btn-warning').addClass('btn-success');
                $('#testItemLimit').val(0).prop('disabled', true);
            }
            
            $('#runWorkflowModal').modal('show');
        }
        
        function executeWorkflow() {
            const executionData = {
                projectId: projectId,
                runName: $('#runName').val() || `${currentRunMode} run ${new Date().toLocaleString()}`,
                mode: currentRunMode,
                priority: $('#runPriority').val(),
                testItemLimit: currentRunMode === 'test' ? parseInt($('#testItemLimit').val()) : null,
                enableDebugLogging: $('#debugMode').is(':checked'),
                startedBy: 'Current User', // This would come from auth
                metadata: JSON.parse($('#inputParameters').val() || '{}')
            };
            
            $.ajax({
                url: '/api/projects/execute',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(executionData),
                success: function(response) {
                    $('#runWorkflowModal').modal('hide');
                    toastr.success('Workflow execution started successfully!');
                    
                    // Refresh history after a delay
                    setTimeout(() => {
                        loadExecutionHistory();
                    }, 2000);
                },
                error: function(xhr) {
                    toastr.error('Failed to start workflow execution');
                }
            });
        }
        
        function editStep(stepId) {
            window.location.href = `/WorkflowDesigner?projectId=${projectId}&stepId=${stepId}`;
        }
        
        function showIOEditModal() {
            $('#ioEditModal').modal('show');
        }
        
        function saveIOConfig() {
            const config = {
                input: {
                    type: $('#configInputType').val()
                },
                output: {
                    type: $('#configOutputType').val()
                }
            };
            
            $.ajax({
                url: `/api/projects/${projectId}/io-configuration`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(config),
                success: function() {
                    $('#ioEditModal').modal('hide');
                    toastr.success('I/O configuration saved successfully');
                    
                    // Update display
                    location.reload();
                },
                error: function() {
                    toastr.error('Failed to save I/O configuration');
                }
            });
        }
        
        function showOrchestratorModal() {
            // Load current settings
            if (@Html.Raw(Model.OrchestratorSettings != null ? "true" : "false")) {
                const settings = @Html.Raw(Model.OrchestratorSettings != null ? Json.Serialize(Model.OrchestratorSettings) : "{}");
                $('#orchestratorType').val(settings.type || 'react');
                $('#orchestratorModel').val(settings.model || 'llama3.1:70b');
                $('#orchestratorTemp').val(settings.temperature || 0.7);
                $('#systemPrompt').val(settings.systemPrompt || 'You are a helpful AI assistant that orchestrates workflow execution using the ReAct pattern (Reasoning + Acting).');
                $('#useToolValidation').prop('checked', settings.useToolValidation !== false);
            }
            
            $('#orchestratorModal').modal('show');
        }
        
        function saveOrchestratorSettings() {
            const settings = {
                type: $('#orchestratorType').val(),
                model: $('#orchestratorModel').val(),
                temperature: parseFloat($('#orchestratorTemp').val()),
                systemPrompt: $('#systemPrompt').val(),
                useToolValidation: $('#useToolValidation').is(':checked')
            };
            
            $.ajax({
                url: `/api/projects/${projectId}/orchestrator-settings`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(settings),
                success: function() {
                    $('#orchestratorModal').modal('hide');
                    toastr.success('Orchestrator settings saved successfully');
                    updateOrchestratorDisplay(settings);
                },
                error: function() {
                    toastr.error('Failed to save orchestrator settings');
                }
            });
        }
        
        function exportWorkflow() {
            if (!workflowData) {
                toastr.warning('No workflow data to export');
                return;
            }
            
            const dataStr = JSON.stringify(workflowData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `workflow-${projectId}-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        function testWorkflow() {
            $('#workflowTestModal').modal('show');
            $('#testProgressBar').css('width', '0%').text('0%');
            $('#testSteps').empty();
            $('#testResults').text('Running tests...');
            
            // Simulate workflow test
            const testSteps = [
                { name: 'Validating workflow structure', duration: 1000 },
                { name: 'Checking tool availability', duration: 1500 },
                { name: 'Testing connections', duration: 2000 },
                { name: 'Running sample data', duration: 3000 }
            ];
            
            let currentStep = 0;
            
            function runTestStep() {
                if (currentStep >= testSteps.length) {
                    $('#testProgressBar').removeClass('progress-bar-animated').addClass('bg-success').text('100%');
                    $('#testResults').text(JSON.stringify({
                        success: true,
                        message: 'All tests passed successfully',
                        details: {
                            stagesValidated: workflowData?.stages?.length || 0,
                            toolsChecked: 5,
                            connectionsValid: true,
                            sampleDataProcessed: true
                        }
                    }, null, 2));
                    $('#closeTestBtn').show();
                    return;
                }
                
                const step = testSteps[currentStep];
                const progress = Math.round((currentStep + 1) / testSteps.length * 100);
                
                $('#testProgressBar').css('width', progress + '%').text(progress + '%');
                
                const stepHtml = $(`
                    <div class="d-flex align-items-center mb-2">
                        <div class="spinner-border spinner-border-sm text-primary mr-2"></div>
                        <span>${step.name}...</span>
                    </div>
                `);
                $('#testSteps').append(stepHtml);
                
                setTimeout(() => {
                    stepHtml.find('.spinner-border').removeClass('spinner-border spinner-border-sm text-primary').html('<i class="fas fa-check-circle text-success"></i>');
                    stepHtml.find('span').html(`${step.name} - <span class="text-success">Passed</span>`);
                    
                    currentStep++;
                    runTestStep();
                }, step.duration);
            }
            
            runTestStep();
        }
        
        function cancelTest() {
            $('#workflowTestModal').modal('hide');
        }
        
        function refreshHistory() {
            $('#executionHistoryBody').html(`
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </td>
                </tr>
            `);
            loadExecutionHistory();
        }
        
        function viewExecution(executionId) {
            window.location.href = `/Projects/Execution/${executionId}`;
        }
    </script>
}