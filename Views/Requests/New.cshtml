@{
    ViewData["Title"] = "Vytvo≈ôit po≈æadavek";
}

<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>
                    <i class="fas fa-plus-circle text-info"></i> Vytvo≈ôit nov√Ω po≈æadavek
                </h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="/Requests">Po≈æadavky</a></li>
                    <li class="breadcrumb-item active">Vytvo≈ôit</li>
                </ol>
            </div>
        </div>
    </div>
</section>

<section class="content">
    <div class="container-fluid">
        <form id="newRequestForm">
            <div class="row">
                <!-- Main form -->
                <div class="col-xl-9">
                    <!-- Error messages placeholder -->
                    <div id="errorContainer"></div>
                    
                    <!-- Basic Information Card -->
                    <div class="card card-info card-outline">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-tasks"></i> Z√°kladn√≠ informace po≈æadavku
                            </h3>
                        </div>
                        
                        <div class="card-body">
                            <!-- Request Title -->
                            <div class="form-group">
                                <label class="font-weight-bold">N√°zev po≈æadavku <span class="text-danger">*</span></label>
                                <div class="input-group input-group-lg">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
                                    </div>
                                    <input type="text" class="form-control" id="title" name="title" 
                                           placeholder="nap≈ô. Produktov√© fotky pro kolekci Jaro 2024" 
                                           autofocus required>
                                </div>
                                <small class="form-text text-muted">Zadejte kr√°tk√Ω a v√Ωsti≈æn√Ω n√°zev po≈æadavku</small>
                            </div>
                            
                            <!-- Customer and Project Row -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="font-weight-bold">
                                            <i class="fas fa-user-tie text-primary"></i> Z√°kazn√≠k
                                        </label>
                                        <select class="form-control custom-select" id="customerId" name="customerId">
                                            <option value="">-- Vyberte z√°kazn√≠ka --</option>
                                            <option value="" data-internal="true">üè¢ Intern√≠ po≈æadavek (bez z√°kazn√≠ka)</option>
                                            <option value="new">‚ûï Nov√Ω z√°kazn√≠k (rychl√© vytvo≈ôen√≠)</option>
                                        </select>
                                        <small class="form-text text-muted">M≈Ø≈æete vybrat existuj√≠c√≠ho z√°kazn√≠ka nebo vytvo≈ôit nov√©ho</small>
                                        
                                        <!-- Quick customer creation inline -->
                                        <div id="quickCustomerSection" style="display: none;" class="mt-3 p-3 bg-light rounded">
                                            <div class="form-group mb-0">
                                                <label class="font-weight-bold">Jm√©no z√°kazn√≠ka <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="quickCustomerName" 
                                                       placeholder="Jan Nov√°k nebo Firma s.r.o.">
                                                <small class="form-text text-muted">Z√°kazn√≠k bude automaticky vytvo≈ôen p≈ôi ulo≈æen√≠ po≈æadavku</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="font-weight-bold">
                                            <i class="fas fa-project-diagram text-info"></i> Projekt
                                        </label>
                                        <select class="form-control custom-select" id="projectId" name="projectId">
                                            <option value="">-- Vyberte projekt --</option>
                                            <option value="new">üÜï Vytvo≈ôit nov√Ω projekt z tohoto po≈æadavku</option>
                                        </select>
                                        <small class="form-text text-muted">Po≈æadavek bude p≈ôi≈ôazen k vybran√©mu projektu</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Description -->
                            <div class="form-group">
                                <label class="font-weight-bold">Popis po≈æadavku</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-align-left"></i></span>
                                    </div>
                                    <textarea class="form-control" id="description" name="description" rows="4" 
                                              placeholder="Popi≈°te co p≈ôesnƒõ po≈æadujete..."></textarea>
                                </div>
                                <small class="form-text text-muted">ƒå√≠m podrobnƒõj≈°√≠ popis, t√≠m lep≈°√≠ v√Ωsledek</small>
                            </div>
                            
                            <!-- Priority and Type Row -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="font-weight-bold">Priorita</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-flag"></i></span>
                                            </div>
                                            <select class="form-control custom-select" id="priority" name="priority">
                                                <option value="Low">N√≠zk√°</option>
                                                <option value="Normal" selected>Norm√°ln√≠</option>
                                                <option value="High">Vysok√°</option>
                                                <option value="Urgent">Urgentn√≠</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="font-weight-bold">Typ po≈æadavku</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-tag"></i></span>
                                            </div>
                                            <select class="form-control custom-select" id="requestType" name="requestType">
                                                <option value="Custom">Vlastn√≠</option>
                                                <option value="Support">Podpora</option>
                                                <option value="Feature">Nov√° funkce</option>
                                                <option value="Bug">Chyba</option>
                                                <option value="Analysis">Anal√Ωza</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Deadline -->
                            <div class="form-group">
                                <label class="font-weight-bold">Po≈æadovan√Ω term√≠n dokonƒçen√≠</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                                    </div>
                                    <input type="date" class="form-control" id="deadline" name="deadline">
                                </div>
                                <small class="form-text text-muted">Nepovinn√© - pokud m√°te konkr√©tn√≠ term√≠n</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right sidebar -->
                <div class="col-xl-3">
                    <!-- Tips Card -->
                    <div class="card card-secondary">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-lightbulb"></i> Tipy
                            </h3>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2">
                                    <i class="fas fa-check text-success"></i> 
                                    Pi≈°te jasn√Ω a konkr√©tn√≠ n√°zev
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-success"></i> 
                                    P≈ôi≈ôaƒète po≈æadavek k projektu
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-success"></i> 
                                    Nastavte spr√°vnou prioritu
                                </li>
                                <li>
                                    <i class="fas fa-check text-success"></i> 
                                    Definujte realistick√Ω term√≠n
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Actions Card -->
                    <div class="card">
                        <div class="card-body">
                            <button type="submit" class="btn btn-info btn-block btn-lg">
                                <i class="fas fa-save"></i> Vytvo≈ôit po≈æadavek
                            </button>
                            <a href="/Requests" class="btn btn-default btn-block">
                                <i class="fas fa-times"></i> Zru≈°it
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Initialize Select2 for better dropdowns
            $('#customerId, #projectId').select2({
                theme: 'bootstrap4',
                width: '100%'
            });
            
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const preselectedCustomerId = urlParams.get('customerId');
            const preselectedProjectId = urlParams.get('projectId');
            
            // Load customers and handle preselection
            loadCustomers(preselectedCustomerId, preselectedProjectId);
            
            // Handle customer selection
            $('#customerId').on('change', function() {
                const selectedOption = $(this).find('option:selected');
                const selectedValue = $(this).val();
                
                if (selectedOption.data('internal') === true) {
                    // Internal request - hide customer section and clear projects
                    $('#quickCustomerSection').slideUp();
                    $('#quickCustomerName').val('');
                    loadProjects(); // Clear projects for internal request
                } else if (selectedValue === 'new') {
                    $('#quickCustomerSection').slideDown();
                    loadProjects(); // Clear projects when selecting new customer
                } else {
                    $('#quickCustomerSection').slideUp();
                    $('#quickCustomerName').val('');
                    if (selectedValue) {
                        loadProjects(selectedValue);
                    } else {
                        loadProjects();
                    }
                }
            });
            
            // Handle project selection - store project name when "new" is selected
            $('#projectId').on('change', function() {
                const selectedValue = $(this).val();
                if (selectedValue === 'new') {
                    // Store the title as project name internally
                    const title = $('#title').val().trim();
                    $('#projectId').data('projectName', title);
                }
            });
            
            // Update stored project name when title changes
            $('#title').on('input', function() {
                const title = $(this).val().trim();
                if ($('#projectId').val() === 'new') {
                    $('#projectId').data('projectName', title);
                }
            });
        });
        
        function loadCustomers(preselectedCustomerId = null, preselectedProjectId = null) {
            $.ajax({
                url: '/api/customersapi',
                type: 'GET',
                success: function(response) {
                    const customers = response.data || response;
                    const $select = $('#customerId');
                    
                    // Keep the first three options (empty, internal, new)
                    $select.find('option:gt(2)').remove();
                    
                    customers.forEach(customer => {
                        $select.append(`<option value="${customer.id}">${customer.name}</option>`);
                    });
                    
                    // If there's a preselected customer, set it and load its projects
                    if (preselectedCustomerId) {
                        $select.val(preselectedCustomerId);
                        loadProjects(preselectedCustomerId, preselectedProjectId);
                    }
                    
                    // Refresh Select2
                    $select.trigger('change');
                },
                error: function() {
                    console.error('Failed to load customers');
                }
            });
        }
        
        function loadProjects(customerId = null, preselectedProjectId = null) {
            $.ajax({
                url: '/api/projects',
                type: 'GET',
                data: customerId ? { customerId: customerId } : {},
                success: function(response) {
                    const projects = response.data?.projects || response.projects || [];
                    const $select = $('#projectId');
                    
                    // Keep the first two options
                    $select.find('option:gt(1)').remove();
                    
                    if (Array.isArray(projects)) {
                        projects.forEach(project => {
                            $select.append(`<option value="${project.id}">${project.name}</option>`);
                        });
                    }
                    
                    // If there's a preselected project, set it
                    if (preselectedProjectId) {
                        $select.val(preselectedProjectId);
                    }
                    
                    // Refresh Select2
                    $select.trigger('change');
                },
                error: function() {
                    console.error('Failed to load projects');
                }
            });
        }
        
        // Form submission
        $('#newRequestForm').on('submit', function(e) {
            e.preventDefault();
            
            // Clear previous errors
            $('#errorContainer').empty();
            
            // Validate required fields
            const title = $('#title').val().trim();
            if (!title) {
                showError('N√°zev po≈æadavku je povinn√Ω');
                return;
            }
            
            // Prepare data
            const selectedCustomerOption = $('#customerId').find('option:selected');
            const isInternal = selectedCustomerOption.data('internal') === true;
            
            const formData = {
                title: title,
                description: $('#description').val() || ' ',
                priority: $('#priority').val(),
                requestType: $('#requestType').val(),
                deadline: $('#deadline').val() || null,
                clientId: isInternal ? null : ($('#customerId').val() === 'new' ? null : $('#customerId').val()),
                clientName: $('#customerId').val() === 'new' ? $('#quickCustomerName').val() : (isInternal ? 'Intern√≠' : null),
                projectId: $('#projectId').val() === 'new' ? null : $('#projectId').val()
            };
            
            // Validate quick customer creation
            if ($('#customerId').val() === 'new' && !$('#quickCustomerName').val().trim()) {
                showError('P≈ôi vytv√°≈ôen√≠ nov√©ho z√°kazn√≠ka je nutn√© zadat jeho jm√©no');
                return;
            }
            
            // Add project name if creating new project
            if ($('#projectId').val() === 'new') {
                const projectName = $('#projectId').data('projectName') || $('#title').val().trim();
                formData.projectName = projectName;
            }
            
            // Submit
            $.ajax({
                url: '/api/requestsapi',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    toastr.success('Po≈æadavek byl √∫spƒõ≈°nƒõ vytvo≈ôen');
                    window.location.href = `/Requests/${response.data.id}`;
                },
                error: function(xhr) {
                    const errorMessage = xhr.responseJSON?.message || 'Chyba p≈ôi vytv√°≈ôen√≠ po≈æadavku';
                    showError(errorMessage);
                }
            });
        });
        
        function showError(message) {
            const alert = `
                <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
                    <h5><i class="icon fas fa-ban"></i> Chyba:</h5>
                    <p class="mb-0">${message}</p>
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            `;
            $('#errorContainer').html(alert);
        }
    </script>
}